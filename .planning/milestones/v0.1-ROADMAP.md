# Milestone v0.1: Large File Refactoring

**Status:** ✅ SHIPPED 2026-01-08
**Phases:** 1-4
**Total Plans:** 14

## Overview

A systematic refactoring of BoardSmith's four largest files into smaller, more maintainable modules. Each phase targets one file, preserving all existing behavior and public APIs while improving code organization, navigability, and testability.

## Phases

### Phase 1: game-session refactoring

**Goal**: Split `packages/session/src/game-session.ts` (2,585 lines) into focused modules while maintaining the unified GameSession API
**Depends on**: Nothing (first phase)
**Plans**: 4 plans

Plans:
- [x] 01-01: Extract lobby management (~900 lines → LobbyManager)
- [x] 01-02: Extract selection & pending action handling (~550 lines → SelectionHandler, PendingActionManager)
- [x] 01-03: Extract state history & debug (~360 lines → StateHistory, DebugController)
- [x] 01-04: Verify and clean up

**Details:**
- GameSession reduced from 2,585 to 1,249 lines (52% reduction)
- Extracted: LobbyManager (986 lines), StateHistory (459 lines), SelectionHandler (352 lines), PendingActionManager (326 lines), DebugController (126 lines)
- Architecture documentation added to main file

### Phase 2: useActionController refactoring

**Goal**: Split `packages/ui/src/composables/useActionController.ts` (1,807 lines) into focused Vue composables
**Depends on**: Phase 1
**Plans**: 4 plans

Plans:
- [x] 02-01: Analyze useActionController and identify extraction boundaries
- [x] 02-02: Extract types to useActionControllerTypes.ts (~350 lines)
- [x] 02-03: Extract pure helpers to actionControllerHelpers.ts (~100 lines)
- [x] 02-04: Extract enrichment to useGameViewEnrichment.ts (~50 lines)

**Details:**
- useActionController reduced from 1,807 to 1,423 lines (21% reduction)
- Extracted: useActionControllerTypes.ts (332 lines), actionControllerHelpers.ts (76 lines), useGameViewEnrichment.ts (91 lines)
- Analysis concluded stateful composable extraction too aggressive due to tight coupling

### Phase 3: action refactoring

**Goal**: Split `packages/engine/src/action/action.ts` (1,845 lines) into focused modules while preserving fluent builder API
**Depends on**: Phase 2
**Plans**: 3 plans

Plans:
- [x] 03-01: Extract ConditionTracer and dev utilities (~85 lines)
- [x] 03-02: Extract Action builder class (~340 lines)
- [x] 03-03: Verify and document final structure

**Details:**
- action.ts reduced from 1,845 to 1,361 lines (26% reduction)
- Extracted: action-builder.ts (363 lines), condition-tracer.ts (58 lines)
- ActionExecutor kept intact (cohesive class with internal dependencies)

### Phase 4: test file refactoring

**Goal**: Restructure `packages/ui/tests/useActionController.test.ts` (2,088 lines) to mirror the new composable structure
**Depends on**: Phase 2 (must complete useActionController refactoring first)
**Plans**: 3 plans

Plans:
- [x] 04-01: Analyze test structure and map to new composable modules
- [x] 04-02: Split tests into separate files mirroring composable structure
- [x] 04-03: Verify all tests pass after restructure

**Details:**
- Test file split into 3 files: useActionController.test.ts (1,178 lines), useActionController.selections.test.ts (777 lines), useActionController.helpers.ts (183 lines)
- All 79 tests passing (increased from 66 due to Phase 2 additions)

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale |
|----------|-----------|
| Refactor all four files | Complete the tech debt cleanup for large files |
| Pure refactoring only | Minimize risk, changes are easier to verify |
| LobbyManager holds reference to StoredGameState | Mutations flow through without copying |
| Callback pattern for cross-module coordination | GameSession controls AI scheduling |
| Handlers expose updateRunner() method | Hot reload support for reloadWithCurrentRules |
| Extract types + helpers only, not stateful composables | actionSnapshot is central; Pit of Success pattern requires centralized state |
| ActionExecutor kept intact | Cohesive class with internal method dependencies |

**Issues Resolved:**

- None (clean execution)

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/ROADMAP.md_
