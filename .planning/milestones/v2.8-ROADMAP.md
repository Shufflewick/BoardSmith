# Milestone v2.8: Disabled Selections

**Status:** SHIPPED 2026-02-06
**Phases:** 75-79
**Total Plans:** 8

## Overview

Add a `disabled` state to element and choice selections so items remain visible but unselectable, with a mandatory reason string. The feature threads through three layers (engine, session, UI) following the existing data flow, then concludes with documentation of the breaking `getChoices()` return type change.

## Phases

### Phase 75: Engine Core

**Goal**: Game designers can mark choices and elements as disabled with a reason, and the engine correctly evaluates availability and rejects invalid selections
**Depends on**: Nothing (first phase)
**Plans**: 2 plans

Plans:

- [x] 75-01: Add AnnotatedChoice type, disabled to selection interfaces, disabled option to builder methods
- [x] 75-02: Update getChoices to return AnnotatedChoice[], validation, path checking, internal callers, AI bot, tests

**Details:**
- Added `AnnotatedChoice<T>` type with `{ value: T, disabled: string | false }` — no bare `true`, forces reason string
- `disabled` callback on `ChoiceSelection`, `ElementSelection`, `ElementsSelection` interfaces
- `chooseFrom`, `chooseElement`, `fromElements` builder methods accept `disabled` option
- `getChoices()` returns `AnnotatedChoice<unknown>[]` for choice, element, elements types
- `validateSelection()` rejects disabled items with "Selection disabled: <reason>" before containment check
- `hasValidSelectionPath()` filters to enabled choices for required selections, optional selections remain available
- AI bot filters disabled choices and extracts `.value` (preserves existing `unknown[]` contract)
- 10 new disabled behavior tests

### Phase 76: Session Wire

**Goal**: Disabled status survives the engine-to-UI boundary so the UI layer can render and enforce disabled state without re-evaluating engine logic
**Depends on**: Phase 75
**Plans**: 1 plan

Plans:

- [x] 76-01: Add disabled?: string to wire types, thread disabled in PickHandler, add tests

**Details:**
- `ValidElement` and `ChoiceWithRefs` gain `disabled?: string` (sparse: absent on enabled items)
- PickHandler evaluates disabled callback directly for choice, element, and elements types
- 6 new tests covering disabled threading through PickHandler wire output

### Phase 77: UI Integration

**Goal**: Players see disabled items greyed out with reason tooltips in both ActionPanel and custom UIs, cannot select disabled items through any interaction path, and auto-fill correctly skips disabled items
**Depends on**: Phase 76
**Plans**: 3 plans

Plans:

- [x] 77-01: Add disabled?: string to UI-layer types, isDisabledElement() and triggerElementSelect guard in board interaction
- [x] 77-02: Add disabled rendering to all ActionPanel button templates and AutoElement bs-element-disabled CSS class
- [x] 77-03: Add disabled validation/auto-fill filtering to useActionController, tests

**Details:**
- `disabled?: string` on 5 UI type locations (ChoiceWithRefs, ValidElement, PickSnapshot.choices, PickChoicesResult.choices, board interaction ValidElement)
- `isDisabledElement()` method on BoardInteractionActions (returns reason string or false)
- `triggerElementSelect` guard against disabled elements
- All 6 ActionPanel button/checkbox templates render disabled with :disabled and :title tooltip
- Multi-select checkbox disabled is compound: element.disabled OR max-reached
- `bs-element-disabled` CSS class with opacity 0.5, grayscale 0.5, cursor not-allowed
- validateSelection rejects disabled values with reason string
- Auto-fill filters disabled choices across all 3 code paths
- getChoices/getCurrentChoices return type includes disabled?: string
- 7 new disabled-specific tests

### Phase 78: Documentation

**Goal**: External teams can migrate to v2.8 without surprises by reading the breaking changes and migration guide
**Depends on**: Phase 77
**Plans**: 1 plan

Plans:

- [x] 78-01: Add v2.8 section to BREAKING.md and update existing docs for disabled field

**Details:**
- BREAKING.md v2.8 section with getChoices() return type change, before/after code examples, migration table
- Updated custom-ui-guide.md getChoices() return type with disabled field
- Updated common-pitfalls.md getChoices() return shape

### Phase 79: Fix element-type disabled in getChoices (INSERTED)

**Goal**: Close integration gap found by milestone audit — element-type picks dropped disabled field when converting ValidElement[] to choice-like arrays
**Depends on**: Phase 77
**Plans**: 1 plan

Plans:

- [x] 79-01: Fix 3 element-to-choice map calls to carry disabled field, add element-type disabled tests

**Details:**
- Added `...(el.disabled && { disabled: el.disabled })` spread to 3 element-to-choice map calls in getChoices()
- 4 new tests covering element-type getChoices disabled, fill rejection, auto-fill filtering, elementsByDependentValue

---

## Milestone Summary

**Decimal Phases:**

- Phase 79: Fix element-type disabled in getChoices (inserted after audit found integration gap)

**Key Decisions:**

- `disabled` runs only on filter-passed items (filter = visibility, disabled = selectability)
- `disabled` returns `string | false` (no bare `true`) — forces developers to provide a reason (pit of success)
- `AnnotatedChoice<T>` has `value` + `disabled` only — display is layered on by session/UI, not engine concern
- `disabled?: string` on wire (optional, not `string | false`) — no need to send `false` for every selectable item
- Disabled check runs before containment check in validateSelection for specific error messages
- AI bot preserves unknown[] contract by filtering disabled internally
- HTML disabled attribute prevents clicks natively — no custom guards needed in button handlers
- bs-element-disabled CSS overrides action-selectable green highlighting
- Auto-fill filters to enabled choices before counting across all 3 code paths

**Issues Resolved:**

- Element-type getChoices() dropped disabled field (found by milestone audit, fixed in Phase 79)

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/ROADMAP.md_
