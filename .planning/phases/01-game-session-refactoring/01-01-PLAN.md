---
phase: 01-game-session-refactoring
plan: 01
type: execute
---

<objective>
Extract lobby management logic (~900 lines) from GameSession into a focused LobbyManager class.

Purpose: The lobby code is the largest cohesive section in GameSession (lines 1674-2585). Extracting it improves navigability and makes both GameSession and lobby logic easier to understand and test independently.

Output: New `lobby-manager.ts` file with LobbyManager class, GameSession delegating to it.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
@packages/session/src/game-session.ts
@packages/session/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LobbyManager class</name>
  <files>packages/session/src/lobby-manager.ts</files>
  <action>
Create a new LobbyManager class that encapsulates all lobby-related logic from GameSession.

Extract these methods (lines 1674-2585 of game-session.ts):
- isWaitingForPlayers()
- getLobbyState()
- getLobbyInfo()
- claimPosition()
- updateSlotName()
- setReady()
- addSlot()
- removeSlot()
- setSlotAI()
- #checkAndStartGame() -> checkAndStartGame() (make public)
- #updateAIConfig() -> updateAIConfig() (make public)
- computeDefaultPlayerOptions() (static method)
- #computeDefaultPlayerOptions() -> computeDefaultPlayerOptions() (instance)
- getPositionForPlayer()
- broadcastLobby()
- leavePosition()
- setPlayerConnected()
- kickPlayer()
- clearDisconnectTimeouts()
- updatePlayerOptions()
- updateSlotPlayerOptions()
- updateGameOptions()

The LobbyManager needs:
- Constructor taking: storedState reference, storage adapter, broadcaster, callbacks for AI/broadcast
- Access to storedState.lobbySlots, lobbyState, playerNames, etc.
- #disconnectTimeouts map (move from GameSession)
- DISCONNECT_TIMEOUT_MS constant (move from GameSession)

Design pattern: LobbyManager holds a reference to StoredGameState (not a copy) so mutations flow through.
Pass callbacks for operations that need GameSession context (e.g., onGameStart for AI scheduling).

Do NOT extract types - they stay in types.ts where they already are.
Do NOT change any public method signatures - preserve exact API.
  </action>
  <verify>npx tsc --noEmit in packages/session compiles without errors</verify>
  <done>LobbyManager class exists with all lobby methods extracted, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Wire LobbyManager into GameSession</name>
  <files>packages/session/src/game-session.ts, packages/session/src/index.ts</files>
  <action>
Update GameSession to use LobbyManager:

1. Add #lobbyManager?: LobbyManager field
2. In constructor, if storedState has lobbySlots, create LobbyManager instance
3. In create() factory, if useLobby, create LobbyManager after session creation
4. In restore() factory, if storedState.lobbySlots exists, create LobbyManager

Replace all lobby method implementations with delegations:
- isWaitingForPlayers() { return this.#lobbyManager?.isWaitingForPlayers() ?? false; }
- getLobbyState() { return this.#lobbyManager?.getLobbyState(); }
- etc.

Remove from GameSession:
- #disconnectTimeouts field
- DISCONNECT_TIMEOUT_MS constant (now in LobbyManager)
- All lobby method implementations (keep signatures as delegations)

Update packages/session/src/index.ts to export LobbyManager if it needs to be public (check if any external code instantiates it directly - likely not needed).

Preserve exact public API - external callers should not notice any change.
  </action>
  <verify>npm test in packages/session - all existing tests pass</verify>
  <done>GameSession delegates to LobbyManager, all session tests pass, GameSession reduced by ~900 lines</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` in packages/session succeeds
- [ ] `npm test` in packages/session passes all tests
- [ ] GameSession.ts is ~900 lines smaller
- [ ] LobbyManager.ts exists with extracted logic
- [ ] No changes to public API signatures
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- GameSession lobby methods delegate to LobbyManager
- Existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/01-game-session-refactoring/01-01-SUMMARY.md`
</output>
