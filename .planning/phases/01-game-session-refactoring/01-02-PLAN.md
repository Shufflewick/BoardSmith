---
phase: 01-game-session-refactoring
plan: 02
type: execute
---

<objective>
Extract selection and pending action handling (~550 lines) from GameSession into focused classes.

Purpose: The selection choice resolution and pending action state machine are complex, self-contained subsystems. Extracting them improves testability and reduces GameSession cognitive load.

Output: New `selection-handler.ts` and `pending-action-manager.ts` files, GameSession delegating to them.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-game-session-refactoring/01-01-SUMMARY.md
@packages/session/src/game-session.ts
@packages/session/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SelectionHandler class</name>
  <files>packages/session/src/selection-handler.ts</files>
  <action>
Create SelectionHandler class to encapsulate selection choice resolution logic.

Extract from GameSession (lines 1019-1336):
- getSelectionChoices() method
- #buildValidElementsList() helper method

SelectionHandler needs:
- Constructor taking: runner reference (GameRunner), storedState reference (for playerCount validation)
- Access to runner.game for action/player lookups

The getSelectionChoices method:
- Takes actionName, selectionName, playerPosition, currentArgs
- Returns SelectionChoicesResponse (already in types.ts)
- Handles choice, element, elements, number, text selection types

Make #buildValidElementsList a private method on SelectionHandler.

Do NOT change the method signature or return type - preserve exact API.
  </action>
  <verify>npx tsc --noEmit in packages/session compiles without errors</verify>
  <done>SelectionHandler class exists with getSelectionChoices extracted, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Create PendingActionManager class</name>
  <files>packages/session/src/pending-action-manager.ts</files>
  <action>
Create PendingActionManager class to encapsulate pending action state machine.

Extract from GameSession (lines 1338-1585):
- #pendingActions map (move to PendingActionManager)
- startPendingAction()
- processSelectionStep()
- getPendingAction()
- cancelPendingAction()
- hasRepeatingSelections()

PendingActionManager needs:
- Constructor taking: runner reference, storedState reference, storage adapter, broadcaster callback
- #pendingActions: Map<number, PendingActionState>
- Callbacks for: save(), broadcast(), scheduleAICheck()

The processSelectionStep method is complex - it:
- Auto-creates pending action if needed
- Handles repeating vs regular selections
- Executes final action when complete
- Persists and broadcasts state

Pass callbacks rather than direct dependencies to avoid circular imports.
  </action>
  <verify>npx tsc --noEmit in packages/session compiles without errors</verify>
  <done>PendingActionManager class exists with all pending action methods, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 3: Wire into GameSession and verify</name>
  <files>packages/session/src/game-session.ts</files>
  <action>
Update GameSession to use SelectionHandler and PendingActionManager:

1. Add #selectionHandler: SelectionHandler field
2. Add #pendingActionManager: PendingActionManager field
3. Initialize both in constructor (after runner is set)
4. Also initialize in restore() factory

Replace implementations with delegations:
- getSelectionChoices() -> this.#selectionHandler.getSelectionChoices(...)
- startPendingAction() -> this.#pendingActionManager.startPendingAction(...)
- processSelectionStep() -> this.#pendingActionManager.processSelectionStep(...)
- getPendingAction() -> this.#pendingActionManager.getPendingAction(...)
- cancelPendingAction() -> this.#pendingActionManager.cancelPendingAction(...)
- hasRepeatingSelections() -> this.#pendingActionManager.hasRepeatingSelections(...)

Remove from GameSession:
- #pendingActions map
- All selection/pending action method implementations

After reloadWithCurrentRules(), need to update the handlers with new runner reference or recreate them.
  </action>
  <verify>npm test in packages/session - all existing tests pass</verify>
  <done>GameSession delegates to SelectionHandler and PendingActionManager, all tests pass, GameSession reduced by ~550 more lines</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` in packages/session succeeds
- [ ] `npm test` in packages/session passes all tests
- [ ] SelectionHandler.ts exists (~300 lines)
- [ ] PendingActionManager.ts exists (~250 lines)
- [ ] GameSession.ts reduced by ~550 lines from plan 01-01 state
- [ ] No changes to public API signatures
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Selection and pending action logic fully extracted
- Existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/01-game-session-refactoring/01-02-SUMMARY.md`
</output>
