---
phase: 01-game-session-refactoring
plan: 04
type: execute
---

<objective>
Verify the complete refactoring, run full test suite, and clean up.

Purpose: Ensure all extractions work correctly together, no regressions were introduced, and the codebase is in a clean state.

Output: Verified refactoring with passing tests, updated exports, final GameSession at ~800-900 lines.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-game-session-refactoring/01-01-SUMMARY.md
@.planning/phases/01-game-session-refactoring/01-02-SUMMARY.md
@.planning/phases/01-game-session-refactoring/01-03-SUMMARY.md
@packages/session/src/game-session.ts
@packages/session/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite and fix any issues</name>
  <files>packages/session/src/*.ts</files>
  <action>
Run the complete test suite for the session package and fix any issues:

1. Run `npm test` in packages/session
2. If any tests fail, analyze the failure and fix
3. Run `npm run build` to ensure clean build
4. Run `npm run typecheck` if available

Common issues to watch for:
- Circular import errors (use callbacks pattern)
- Missing method delegations
- Runner reference becoming stale after reload
- Broadcast not being called after state changes

If tests pass, verify GameSession.ts line count is significantly reduced:
- Original: ~2,585 lines
- After extractions: Should be ~800-900 lines (core logic only)

The remaining GameSession should contain:
- Factory methods (create, restore)
- Core accessors (runner, storedState, gameType, etc.)
- performAction()
- getState(), buildPlayerState()
- getHistory()
- broadcast()
- Hot reload (reloadWithCurrentRules)
- AI scheduling (#scheduleAICheck, #checkAITurn)
- Delegations to extracted classes
  </action>
  <verify>npm test passes, npm run build succeeds, GameSession.ts < 1000 lines</verify>
  <done>All tests pass, build succeeds, GameSession significantly reduced</done>
</task>

<task type="auto">
  <name>Task 2: Update exports and add module documentation</name>
  <files>packages/session/src/index.ts, packages/session/src/game-session.ts</files>
  <action>
1. Review packages/session/src/index.ts exports:
   - GameSession should remain the primary export
   - New classes (LobbyManager, SelectionHandler, PendingActionManager, StateHistory, DebugController)
     should NOT be exported unless there's a specific external use case
   - They are internal implementation details

2. Add a brief module comment at the top of game-session.ts explaining the architecture:
   ```typescript
   /**
    * GameSession - Unified game session management across platforms.
    *
    * Architecture: GameSession delegates to focused helper classes:
    * - LobbyManager: Player slots, ready state, game start
    * - SelectionHandler: Action selection choice resolution
    * - PendingActionManager: Repeating selection state machine
    * - StateHistory: Time travel, undo, action traces
    * - DebugController: Debug deck manipulation
    *
    * This keeps GameSession focused on core concerns:
    * - Game lifecycle (create, restore)
    * - Action execution
    * - State queries
    * - Broadcasting
    * - AI scheduling
    */
   ```

3. Verify no external packages import internal classes directly by searching:
   `grep -r "from.*session.*lobby-manager\|selection-handler\|pending-action\|state-history\|debug-controller" packages/`
  </action>
  <verify>grep finds no external imports of internal classes</verify>
  <done>Exports clean, module documented, no external coupling to internals</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete GameSession refactoring - split 2,585 lines into 6 focused modules</what-built>
  <how-to-verify>
    1. Check file sizes:
       - `wc -l packages/session/src/game-session.ts` (should be ~800-900)
       - `wc -l packages/session/src/lobby-manager.ts` (should be ~900)
       - `wc -l packages/session/src/selection-handler.ts` (should be ~300)
       - `wc -l packages/session/src/pending-action-manager.ts` (should be ~250)
       - `wc -l packages/session/src/state-history.ts` (should be ~280)
       - `wc -l packages/session/src/debug-controller.ts` (should be ~80)
    2. Run: `npm test` in packages/session - all tests should pass
    3. Run: `npm run build` - should succeed
    4. Optionally: Start a game with `boardsmith dev` and verify it works
  </how-to-verify>
  <resume-signal>Type "approved" if refactoring is complete, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass in packages/session
- [ ] Build succeeds
- [ ] GameSession.ts < 1000 lines
- [ ] All extracted modules exist and are reasonable sizes
- [ ] No external packages depend on internal modules
- [ ] Human verified the refactoring works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human approved the final result
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-game-session-refactoring/01-04-SUMMARY.md` with:
- Final line counts for all files
- Summary of what was extracted
- Any deviations from plan
- Confirmation phase is complete
</output>
