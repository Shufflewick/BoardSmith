---
phase: 03-action-refactoring
plan: 01
type: execute
---

<objective>
Extract ConditionTracer class and development utilities from action.ts into separate modules.

Purpose: Reduce action.ts size while extracting the most independent pieces first.
Output: New files `condition-tracer.ts` and updates to helpers.ts, action.ts reduced by ~85 lines.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-action-refactoring/03-ANALYSIS.md
@packages/engine/src/action/action.ts
@packages/engine/src/action/helpers.ts
@packages/engine/src/action/types.ts
@packages/engine/src/action/index.ts

**Prior decisions:**
- Phase 2 showed over-aggressive extraction fragments tightly-coupled code
- Types and helpers already extracted successfully
- ActionExecutor is cohesive and should stay together

**Extraction targets:**
- ConditionTracer class (lines 73-112) - self-contained debug helper
- Dev utilities (lines 34-51) - isDevMode(), shownWarnings, devWarn()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract ConditionTracer class</name>
  <files>packages/engine/src/action/condition-tracer.ts, packages/engine/src/action/action.ts</files>
  <action>
Create new file `condition-tracer.ts` containing:
1. Import ConditionDetail type from types.ts
2. The ConditionTracer class (currently lines 73-112)
3. Export the class

In action.ts:
1. Remove the ConditionTracer class definition
2. Add import: `import { ConditionTracer } from './condition-tracer.js';`
3. Keep the re-export in the export section

Update index.ts to export ConditionTracer from the new file.
  </action>
  <verify>npm run build -w @boardsmith/engine succeeds with no type errors</verify>
  <done>ConditionTracer class extracted to condition-tracer.ts, action.ts updated with import, exports unchanged</done>
</task>

<task type="auto">
  <name>Task 2: Extract development utilities to helpers.ts</name>
  <files>packages/engine/src/action/helpers.ts, packages/engine/src/action/action.ts</files>
  <action>
Move dev utilities to the top of helpers.ts:
1. isDevMode() function (currently lines 34-36 in action.ts)
2. shownWarnings Set (line 41)
3. devWarn() function (lines 46-51)

In helpers.ts:
1. Add these at the top with a section comment "// Development Mode Utilities"
2. Export isDevMode and devWarn (keep shownWarnings private/unexported)

In action.ts:
1. Remove the dev utilities section (lines 27-51)
2. Add import: `import { isDevMode, devWarn } from './helpers.js';`

Do NOT export isDevMode/devWarn from index.ts (internal utilities only).
  </action>
  <verify>npm run build -w @boardsmith/engine && npm test -w @boardsmith/engine succeeds</verify>
  <done>Dev utilities moved to helpers.ts, action.ts imports them, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite</name>
  <files>packages/engine/tests/action.test.ts</files>
  <action>
Run the full test suite to verify no regressions:
1. npm test -w @boardsmith/engine
2. Verify all action tests pass
3. Check that ConditionTracer works in traceActionAvailability tests (if any)
  </action>
  <verify>All tests in packages/engine/tests/ pass</verify>
  <done>All 95+ engine tests pass, no regressions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build -w @boardsmith/engine` succeeds
- [ ] `npm test -w @boardsmith/engine` passes all tests
- [ ] action.ts reduced by ~85 lines
- [ ] condition-tracer.ts created with ConditionTracer class
- [ ] helpers.ts updated with dev utilities
- [ ] index.ts exports ConditionTracer from new location
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- action.ts reduced from 1,845 to ~1,760 lines
- Clean separation of debug/dev utilities
</success_criteria>

<output>
After completion, create `.planning/phases/03-action-refactoring/03-01-SUMMARY.md`
</output>
