---
phase: 03-action-refactoring
plan: 02
type: execute
---

<objective>
Extract the Action builder class from action.ts into a dedicated module.

Purpose: Separate the fluent builder API (used by game developers) from the executor (runtime internals).
Output: New file `action-builder.ts` with Action class, action.ts reduced by ~340 lines.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-action-refactoring/03-ANALYSIS.md
@.planning/phases/03-action-refactoring/03-01-SUMMARY.md
@packages/engine/src/action/action.ts
@packages/engine/src/action/index.ts

**Prior plan:**
- 03-01 extracted ConditionTracer and dev utilities
- action.ts now ~1,760 lines

**Extraction target:**
- Action class (lines 168-509) - fluent builder API
- wrapFilterWithHelpfulErrors helper (lines 114-166) - only used by Action and ActionExecutor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Action builder class</name>
  <files>packages/engine/src/action/action-builder.ts, packages/engine/src/action/action.ts</files>
  <action>
Create new file `action-builder.ts` containing:
1. Necessary type imports from types.ts
2. Import devWarn from helpers.ts (used in wrapFilterWithHelpfulErrors)
3. The wrapFilterWithHelpfulErrors helper function (currently lines ~114-166)
4. The Action class (currently lines ~168-509)
5. Export Action class (wrapFilterWithHelpfulErrors stays internal)

In action.ts:
1. Remove the Action class definition
2. Remove wrapFilterWithHelpfulErrors (it's only used by Action.chooseElement internally)
3. Add import: `import { Action } from './action-builder.js';`
4. Keep the re-export in the export section

Update index.ts to export Action from the new file.
  </action>
  <verify>npm run build -w @boardsmith/engine succeeds with no type errors</verify>
  <done>Action class extracted to action-builder.ts, action.ts updated with import, exports unchanged</done>
</task>

<task type="auto">
  <name>Task 2: Verify wrapFilterWithHelpfulErrors usage</name>
  <files>packages/engine/src/action/action.ts, packages/engine/src/action/action-builder.ts</files>
  <action>
Check if wrapFilterWithHelpfulErrors is used by ActionExecutor:
1. Search action.ts for calls to wrapFilterWithHelpfulErrors
2. If ActionExecutor also uses it, export from action-builder.ts and import in action.ts
3. If only Action uses it (expected), keep it internal to action-builder.ts

Based on analysis: wrapFilterWithHelpfulErrors is called in ActionExecutor.getChoices() at line 781.
So we need to either:
- Keep it in action.ts, OR
- Export it from helpers.ts (better - it's a utility)

Move to helpers.ts instead:
1. Move wrapFilterWithHelpfulErrors to helpers.ts (it uses devWarn which is already there)
2. Export from helpers.ts
3. Import in both action.ts and action-builder.ts as needed
  </action>
  <verify>Grep for wrapFilterWithHelpfulErrors shows correct imports in both files</verify>
  <done>wrapFilterWithHelpfulErrors correctly placed and imported where needed</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite</name>
  <files>packages/engine/tests/action.test.ts</files>
  <action>
Run the full test suite to verify no regressions:
1. npm test -w @boardsmith/engine
2. Verify all action builder tests pass (Action.create, fluent API)
3. Verify all action executor tests pass
  </action>
  <verify>All tests in packages/engine/tests/ pass</verify>
  <done>All 95+ engine tests pass, no regressions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build -w @boardsmith/engine` succeeds
- [ ] `npm test -w @boardsmith/engine` passes all tests
- [ ] action.ts reduced by ~340 lines (now ~1,420 lines)
- [ ] action-builder.ts created with Action class
- [ ] wrapFilterWithHelpfulErrors in correct location
- [ ] index.ts exports Action from new location
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- action.ts reduced from ~1,760 to ~1,420 lines
- Clean separation of builder API from executor
</success_criteria>

<output>
After completion, create `.planning/phases/03-action-refactoring/03-02-SUMMARY.md`
</output>
