---
phase: 04-test-file-refactoring
plan: 02
type: execute
---

<objective>
Split useActionController.test.ts into focused test files based on the analysis from 04-01.

Purpose: Improve test file navigability and align test organization with the composable structure from Phase 2.
Output: Multiple focused test files with shared test utilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-file-refactoring/04-ANALYSIS.md

**Source test file:**
@packages/ui/tests/useActionController.test.ts

**Testing patterns:**
@.planning/codebase/TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared test utilities file</name>
  <files>packages/ui/tests/useActionController.helpers.ts</files>
  <action>
Extract shared test utilities to useActionController.helpers.ts:

1. Move createMockSendAction() helper
2. Move createTestMetadata() helper with all test action definitions
3. Export types needed by test files (if any)

Keep the helpers file focused on test setup utilities, not actual test cases.
Import from vitest for types only if needed.
  </action>
  <verify>File exists with exported helpers, no syntax errors: `pnpm exec tsc --noEmit packages/ui/tests/useActionController.helpers.ts`</verify>
  <done>Test helpers extracted and exported</done>
</task>

<task type="auto">
  <name>Task 2: Create selection-focused test file</name>
  <files>packages/ui/tests/useActionController.selections.test.ts</files>
  <action>
Create useActionController.selections.test.ts with selection-related tests.

Move these describe blocks from the original file:
- 'repeating selections' (~265 lines)
- 'dependsOn selections' (~168 lines)
- 'filterBy selections' (~98 lines)
- 'text and number inputs' (~96 lines)
- 'element selections' (~50 lines)
- 'multiSelect validation' (~60 lines)

Include:
1. Import from vitest (describe, it, expect, vi, beforeEach)
2. Import from vue (ref, reactive, nextTick)
3. Import useActionController and types from composable
4. Import shared helpers from useActionController.helpers.ts
5. Standard beforeEach setup (sendAction, availableActions, actionMetadata, isMyTurn)
6. All tests from the listed describe blocks

Total estimated: ~737 lines
  </action>
  <verify>New test file runs: `pnpm test packages/ui/tests/useActionController.selections.test.ts`</verify>
  <done>Selection tests in separate file, all passing</done>
</task>

<task type="auto">
  <name>Task 3: Update original test file to use shared helpers</name>
  <files>packages/ui/tests/useActionController.test.ts</files>
  <action>
Update the original useActionController.test.ts:

1. Remove moved describe blocks:
   - 'repeating selections'
   - 'dependsOn selections'
   - 'filterBy selections'
   - 'text and number inputs'
   - 'element selections'
   - 'multiSelect validation'

2. Remove duplicated helper functions (createMockSendAction, createTestMetadata)

3. Add import from useActionController.helpers.ts

4. Keep remaining tests:
   - initialization
   - execute() method
   - step-by-step mode (wizard)
   - auto-fill behavior
   - auto-execute behavior
   - getChoices utility
   - getActionMetadata utility
   - isExecuting guard
   - state cleanup
   - injection helpers
   - externalArgs (bidirectional sync)
   - start() with initialArgs
   - selection choices
   - getCurrentChoices()
   - error recovery
   - fetchChoicesForSelection()

Expected reduction: ~737 lines (from 2088 to ~1351)
  </action>
  <verify>Original file runs: `pnpm test packages/ui/tests/useActionController.test.ts`</verify>
  <done>Original file updated, tests passing, line count reduced</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `pnpm test packages/ui/tests/useActionController`
- [ ] Total test count unchanged (count tests before and after)
- [ ] No duplicate tests between files
- [ ] Shared helpers used by both test files
</verification>

<success_criteria>

- Test files split successfully
- All tests pass
- No test coverage lost
- Shared helpers extracted
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-file-refactoring/04-02-SUMMARY.md`
</output>
