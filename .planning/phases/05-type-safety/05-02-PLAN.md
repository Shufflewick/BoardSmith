---
phase: 05-type-safety
plan: 02
type: execute
---

<objective>
Replace DOM property storage pattern with WeakMap in useZoomPreview.

Purpose: Eliminate `as any` type assertions when storing cleanup functions on DOM elements.
Output: Type-safe cleanup function storage using WeakMap.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./05-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONCERNS.md

@packages/ui/src/composables/useZoomPreview.ts

**The Issue:**
The composable stores cleanup functions directly on DOM objects using `as any`:

```typescript
// Line 127: Store on window
(window as any).__zoomPreviewKeyboardCleanup = () => { ... };

// Line 136-138: Access and delete from window
if ((window as any).__zoomPreviewKeyboardCleanup) {
  (window as any).__zoomPreviewKeyboardCleanup();
  delete (window as any).__zoomPreviewKeyboardCleanup;
}

// Line 589: Store on container element
(container as any).__zoomPreviewCleanup = () => { ... };

// Line 611-613: Access and delete from container
if ((container as any).__zoomPreviewCleanup) {
  (container as any).__zoomPreviewCleanup();
  delete (container as any).__zoomPreviewCleanup;
}
```

**Solution:**
Use WeakMap to store cleanup functions, keyed by the object they're associated with. This is the standard pattern for associating metadata with DOM elements without polluting them.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WeakMaps for cleanup function storage</name>
  <files>packages/ui/src/composables/useZoomPreview.ts</files>
  <action>
Near the top of the file (after the interface definitions, around line 93), add two module-level WeakMaps:

```typescript
// WeakMaps for storing cleanup functions without polluting DOM objects
const keyboardCleanupMap = new WeakMap<Window, () => void>();
const containerCleanupMap = new WeakMap<Element, () => void>();
```

Then update the four locations that use `as any`:

**Location 1 (line ~127):** Replace:
```typescript
(window as any).__zoomPreviewKeyboardCleanup = () => { ... };
```
With:
```typescript
keyboardCleanupMap.set(window, () => { ... });
```

**Location 2 (lines ~136-138):** Replace:
```typescript
if ((window as any).__zoomPreviewKeyboardCleanup) {
  (window as any).__zoomPreviewKeyboardCleanup();
  delete (window as any).__zoomPreviewKeyboardCleanup;
}
```
With:
```typescript
const cleanup = keyboardCleanupMap.get(window);
if (cleanup) {
  cleanup();
  keyboardCleanupMap.delete(window);
}
```

**Location 3 (line ~589):** Replace:
```typescript
(container as any).__zoomPreviewCleanup = () => { ... };
```
With:
```typescript
containerCleanupMap.set(container, () => { ... });
```

**Location 4 (lines ~611-613):** Replace:
```typescript
if ((container as any).__zoomPreviewCleanup) {
  (container as any).__zoomPreviewCleanup();
  delete (container as any).__zoomPreviewCleanup;
}
```
With:
```typescript
const containerCleanup = containerCleanupMap.get(container);
if (containerCleanup) {
  containerCleanup();
  containerCleanupMap.delete(container);
}
```

This preserves the exact same behavior (storing and retrieving cleanup functions) while eliminating all `as any` assertions.
  </action>
  <verify>npm run build passes without TypeScript errors</verify>
  <done>No `as any` in useZoomPreview.ts, TypeScript compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Verify cleanup behavior works correctly</name>
  <files>packages/ui/src/composables/useZoomPreview.ts</files>
  <action>
Run the UI package tests to confirm the WeakMap refactoring doesn't break any existing behavior.

The WeakMap pattern has identical behavior to direct property assignment:
- `map.set(obj, fn)` is equivalent to `obj.prop = fn`
- `map.get(obj)` is equivalent to `obj.prop`
- `map.delete(obj)` is equivalent to `delete obj.prop`

Additionally, WeakMap provides automatic garbage collection if the key object is released.
  </action>
  <verify>npm run test -- packages/ui passes</verify>
  <done>All UI tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run test -- packages/ui` passes
- [ ] Grep for `as any` in useZoomPreview.ts returns no results
- [ ] WeakMaps are properly typed
</verification>

<success_criteria>

- WeakMaps replace direct property assignment on window/container
- All `as any` removed from useZoomPreview.ts
- All tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-type-safety/05-02-SUMMARY.md`
</output>
