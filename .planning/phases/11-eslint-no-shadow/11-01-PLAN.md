---
phase: 11-eslint-no-shadow
plan: 01
type: execute
---

<objective>
Add ESLint with @typescript-eslint/no-shadow rule and fix all existing violations.

Purpose: Catch variable shadowing bugs at build time (prompted by train action silent failure where inner `action` shadowed outer `action`)
Output: ESLint configured with no-shadow rule, all violations fixed, lint script added
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Background:** The train action bug involved an inner variable shadowing an outer one, causing silent failures. The @typescript-eslint/no-shadow rule would catch this at build time.

**Existing ESLint in project:** packages/eslint-plugin is a SEPARATE custom plugin for game code sandboxing rules. This plan adds ESLint to the workspace root for codebase-wide linting.

**Known violations (5 total):**
1. packages/engine/src/flow/engine.ts:368 - `actionName` shadows outer scope
2. packages/ui/src/composables/useActionController.ts:936 - `options` shadows outer scope
3. packages/ui/src/composables/useAutoAnimations.ts:217 - `reset` shadows outer scope
4. packages/ui/src/composables/useAutoFlyToStat.ts:178 - `tracker` shadows outer scope
5. packages/ui/src/composables/useElementAnimation.ts:152 - `currentRect` shadows outer scope

**Constraints:**
- Must work with existing TypeScript 5.7, pnpm workspace setup
- Focus on .ts files only (Vue files need vue-eslint-parser which adds complexity - out of scope)
- Ignore test files and dist directories
- Ignore games/ directory (user-generated content)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ESLint with no-shadow rule</name>
  <files>package.json, eslint.config.mjs</files>
  <action>
1. Add dev dependencies to workspace root: eslint, @typescript-eslint/parser, @typescript-eslint/eslint-plugin
2. Create eslint.config.mjs (flat config format - ESLint 9+) with:
   - Target: packages/**/*.ts files
   - Parser: @typescript-eslint/parser (no type-aware - project: false for speed)
   - Single rule: @typescript-eslint/no-shadow: 'error'
   - Ignores: dist/**, node_modules/**, *.d.ts, *.test.ts, games/**
3. Add "lint" script to root package.json: "eslint packages/"
4. Verify: pnpm lint should show exactly 5 errors (the known violations)
  </action>
  <verify>pnpm lint 2>&1 | grep "5 problems" (5 errors, 0 warnings)</verify>
  <done>ESLint installed, config created, lint script works, shows 5 known violations</done>
</task>

<task type="auto">
  <name>Task 2: Fix all no-shadow violations</name>
  <files>
packages/engine/src/flow/engine.ts,
packages/ui/src/composables/useActionController.ts,
packages/ui/src/composables/useAutoAnimations.ts,
packages/ui/src/composables/useAutoFlyToStat.ts,
packages/ui/src/composables/useElementAnimation.ts
  </files>
  <action>
Fix each violation by renaming the inner variable to avoid shadowing:

1. engine.ts:368 - rename inner `actionName` to `currentActionName` or similar
2. useActionController.ts:936 - rename inner `options` to avoid shadowing line 140
3. useAutoAnimations.ts:217 - rename inner `reset` to avoid shadowing line 256
4. useAutoFlyToStat.ts:178 - rename inner `tracker` to avoid shadowing line 127
5. useElementAnimation.ts:152 - rename inner `currentRect` to avoid shadowing line 118

For each fix:
- Read the file to understand the context
- Choose a name that's descriptive and doesn't break existing usage
- Ensure all references to the renamed variable are updated
  </action>
  <verify>pnpm lint exits with 0 errors</verify>
  <done>All 5 violations fixed, pnpm lint passes clean</done>
</task>

<task type="auto">
  <name>Task 3: Verify tests still pass</name>
  <files>None (verification only)</files>
  <action>
Run full test suite to ensure variable renames didn't break anything.
All 442 tests should still pass.
  </action>
  <verify>pnpm test shows all tests passing</verify>
  <done>All tests pass, no regressions from variable renames</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm lint` passes with 0 errors
- [ ] `pnpm test` passes all 442 tests
- [ ] No TypeScript errors (`pnpm build` in engine/ui packages)
- [ ] lint script exists in package.json
</verification>

<success_criteria>

- ESLint configured with @typescript-eslint/no-shadow rule
- All 5 existing violations fixed
- lint script added to package.json
- All tests pass
- Future shadowing bugs caught at lint time
</success_criteria>

<output>
After completion, create `.planning/phases/11-eslint-no-shadow/11-01-SUMMARY.md`:

# Phase 11 Plan 01: ESLint No-Shadow Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `eslint.config.mjs` - ESLint flat config with no-shadow rule
- `package.json` - Added eslint deps and lint script
- [List of 5 fixed files]

## Decisions Made

[Any decisions about variable naming]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 11 complete, milestone v0.5 complete
</output>
