---
phase: 12-player-in-tree
plan: 03
type: execute
---

<objective>
Update all tests, supporting packages (testing, session, ai, runtime, ui), and verify full system works.

Purpose: Complete the migration by updating all remaining code and ensuring tests pass.
Output: All 442+ tests pass, full system works with new player model.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-player-in-tree/12-01-SUMMARY.md
@.planning/phases/12-player-in-tree/12-02-SUMMARY.md

**Prior work:**
- 12-01: Player extends GameElement, PlayerCollection removed from engine
- 12-02: All game implementations updated

**Packages with game.players references to update:**
- packages/testing/src/*.ts - TestGame helpers, assertions
- packages/session/src/*.ts - GameSession, selection handling
- packages/ai/src/*.ts - MCTS bot, AI interfaces
- packages/runtime/src/*.ts - GameRunner
- packages/ui/src/*.ts - Vue components accessing players

**Test files to update:**
- packages/engine/tests/*.test.ts
- packages/games/*/tests/*.test.ts
- packages/runtime/tests/*.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update supporting packages</name>
  <files>
packages/testing/src/test-game.ts,
packages/testing/src/debug.ts,
packages/session/src/game-session.ts,
packages/session/src/selection-handler.ts,
packages/session/src/pending-action-manager.ts,
packages/session/src/utils.ts,
packages/ai/src/mcts-bot.ts,
packages/ai-trainer/src/introspector.ts,
packages/runtime/src/runner.ts,
packages/engine/src/utils/serializer.ts,
packages/engine/src/utils/snapshot.ts
  </files>
  <action>
Search and update all `game.players` references in supporting packages:

```bash
grep -r "game\.players" packages/testing packages/session packages/ai packages/runtime --include="*.ts"
grep -r "\.players\." packages/ --include="*.ts" | grep -v node_modules | grep -v ".d.ts"
```

Apply migration patterns:
- `game.players.all()` → `game.all(Player)`
- `game.players.get(n)` → `game.first(Player, p => p.position === n)`
- `game.players.current` → `game.currentPlayer`
- `game.players.length` → `game.all(Player).length`
- `game.players.forEach(...)` → `game.all(Player).forEach(...)`
- `game.players.map(...)` → `game.all(Player).map(...)`
- `game.players.toJSON()` → players serialize naturally as elements now
- `for (const p of game.players)` → `for (const p of game.all(Player))`

Special cases:
- **Serialization (serializer.ts, snapshot.ts):** Players now serialize as part of element tree. Remove separate player serialization logic.
- **Deserialization:** Players restored as part of element tree. No separate restoration needed.
- **MCTS Bot:** Update player iteration patterns
- **TestGame:** Update any player setup helpers

Import Player where needed:
```typescript
import { Player } from '@boardsmith/engine';
```
  </action>
  <verify>pnpm build succeeds for all supporting packages</verify>
  <done>All supporting packages compile with new player model</done>
</task>

<task type="auto">
  <name>Task 2: Update UI components</name>
  <files>
packages/ui/src/components/PlayersPanel.vue,
packages/ui/src/composables/*.ts
  </files>
  <action>
Update UI code that accesses player data:

```bash
grep -r "players" packages/ui/src --include="*.ts" --include="*.vue"
```

Key patterns:
- UI receives serialized game state - players are now in element tree
- `game.all(Player)` in game code → serialize → UI receives player elements in tree
- PlayersPanel may need to search tree for Player elements instead of receiving separate array

Check PlayersPanel.vue:
- If it receives `players` prop separately, may need to update to find players in tree
- Or update the data passing to extract players from tree before sending to UI

Check composables for any player access patterns.
  </action>
  <verify>UI package compiles without errors</verify>
  <done>UI components work with players-in-tree model</done>
</task>

<task type="auto">
  <name>Task 3: Update tests and verify all pass</name>
  <files>
packages/engine/tests/*.test.ts,
packages/games/*/tests/*.test.ts,
packages/runtime/tests/*.test.ts
  </files>
  <action>
Update all test files that reference `game.players`:

```bash
grep -r "game\.players" packages/*/tests --include="*.test.ts"
grep -r "\.players" packages/*/tests --include="*.test.ts"
```

Apply same migration patterns as Task 1.

Common test patterns to update:
- `expect(game.players.length).toBe(2)` → `expect(game.all(Player).length).toBe(2)`
- `game.players.get(1)` → `game.first(Player, p => p.position === 1)`
- Test setup creating players - verify works with new model

Run tests:
```bash
pnpm test
```

Fix any failing tests. Expected: All 442+ tests pass.

If tests fail:
1. Check if test is testing PlayerCollection behavior (remove/update test)
2. Check if test needs updated player access pattern
3. Check if serialization/deserialization changed test expectations
  </action>
  <verify>pnpm test passes all tests (442+)</verify>
  <done>All tests pass with new player model</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All supporting packages compile (testing, session, ai, runtime)
- [ ] UI package compiles
- [ ] `pnpm test` passes all 442+ tests
- [ ] `pnpm build` succeeds for entire workspace
- [ ] No `game.players` or `PlayerCollection` references remain anywhere
</verification>

<success_criteria>

- All packages compile
- All 442+ tests pass
- No PlayerCollection references in codebase
- Players findable via `game.all(Player)`
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-player-in-tree/12-03-SUMMARY.md`:

# Phase 12 Plan 03: Tests and Supporting Packages Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List of files]

## Decisions Made
[Key decisions]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Phase 12 complete. Ready for Phase 13 (player-access-docs).
</output>
