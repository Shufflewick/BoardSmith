---
phase: 14-condition-api-refactor
plan: 02
type: execute
---

<objective>
Implement automatic condition tracing in ActionExecutor and remove ConditionTracer class.

Purpose: Make condition debugging automatic by evaluating labeled predicates and capturing results.
Output: ActionExecutor processes object conditions with auto-tracing, ConditionTracer removed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-condition-api-refactor/14-01-SUMMARY.md

# Relevant source files:
@packages/engine/src/action/action.ts
@packages/engine/src/action/condition-tracer.ts
@packages/engine/src/action/index.ts
@packages/engine/src/action/types.ts
@packages/engine/src/index.ts

**After Plan 01:** ConditionConfig type exists, Action.condition() accepts both formats.
**This plan:** ActionExecutor evaluates object conditions, auto-traces labeled predicates.

**Object condition evaluation logic:**
For object conditions, all predicates are evaluated and results captured:
```typescript
// { 'label1': pred1, 'label2': pred2 }
// Evaluate each, capture: { label: 'label1', value: true/false, passed: true/false }
// Condition passes if ALL predicates pass (AND semantics)
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ActionExecutor to process object conditions with auto-tracing</name>
  <files>packages/engine/src/action/action.ts</files>
  <action>
Update ActionExecutor methods to handle ConditionConfig (both function and object formats):

1. Add import for ConditionConfig, ConditionPredicate, ObjectCondition at top:
   ```typescript
   import type {
     // ... existing imports
     ConditionConfig,
     ConditionPredicate,
     ObjectCondition,
   } from './types.js';
   ```

2. Add helper function to detect condition type:
   ```typescript
   /**
    * Check if a condition is an object-based condition (has labeled predicates)
    */
   private isObjectCondition(condition: ConditionConfig): condition is ObjectCondition {
     return typeof condition !== 'function';
   }
   ```

3. Add helper to evaluate object conditions and capture trace:
   ```typescript
   /**
    * Evaluate an object condition, returning result and details.
    * All predicates are evaluated (AND semantics) and their results captured.
    */
   private evaluateObjectCondition(
     condition: ObjectCondition,
     context: ActionContext
   ): { passed: boolean; details: ConditionDetail[] } {
     const details: ConditionDetail[] = [];
     let allPassed = true;

     for (const [label, predicate] of Object.entries(condition)) {
       let passed = false;
       let value: unknown = undefined;
       try {
         const result = predicate(context);
         passed = Boolean(result);
         value = result;
       } catch (error) {
         passed = false;
         value = error instanceof Error ? error.message : String(error);
       }
       details.push({ label, value, passed });
       if (!passed) allPassed = false;
     }

     return { passed: allPassed, details };
   }
   ```

4. Update `isActionAvailable()` method to handle both formats:
   - For function conditions: call directly as before
   - For object conditions: use evaluateObjectCondition, return passed result

5. Update `traceActionAvailability()` method:
   - For function conditions: call directly, no automatic details (legacy behavior)
   - For object conditions: use evaluateObjectCondition, include details in trace

6. Remove the ConditionTracer usage in traceActionAvailability:
   - Remove the `const tracer = new ConditionTracer()` line
   - Remove passing tracer as second argument to condition
   - The automatic tracing replaces manual tracer usage

7. Update `validateAction()` to handle ConditionConfig:
   - For function conditions: `!condition(context)`
   - For object conditions: `!evaluateObjectCondition(condition, context).passed`
  </action>
  <verify>
Run `npm run build -w packages/engine` - should compile without errors.
Run `npm test -w packages/engine` - all tests should pass.
  </verify>
  <done>
ActionExecutor handles both function and object conditions.
Object conditions produce automatic ConditionDetail traces.
ConditionTracer is no longer used in ActionExecutor.
All engine tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove ConditionTracer class and exports</name>
  <files>packages/engine/src/action/condition-tracer.ts, packages/engine/src/action/index.ts, packages/engine/src/action/types.ts, packages/engine/src/index.ts</files>
  <action>
Remove ConditionTracer since it's replaced by automatic object condition tracing:

1. **Delete condition-tracer.ts:**
   Delete the entire file `packages/engine/src/action/condition-tracer.ts`

2. **Update action/index.ts:**
   Remove the ConditionTracer export line:
   ```typescript
   // DELETE THIS LINE:
   export { ConditionTracer } from './condition-tracer.js';
   ```

3. **Update action/types.ts:**
   Remove the ConditionTracer import:
   ```typescript
   // DELETE THIS LINE:
   import type { ConditionTracer } from './condition-tracer.js';
   ```
   (The ConditionDetail type should remain - it's used for trace output)

4. **Update engine/src/index.ts:**
   Remove ConditionTracer from the export:
   ```typescript
   // Change from:
   export { Action, ActionExecutor, ConditionTracer } from './action/index.js';
   // To:
   export { Action, ActionExecutor } from './action/index.js';
   ```

5. **Update action.ts:**
   Remove ConditionTracer import since it's no longer used:
   ```typescript
   // DELETE THIS LINE:
   import { ConditionTracer } from './condition-tracer.js';
   ```

Note: Keep ConditionDetail type - it's now auto-generated by evaluateObjectCondition().
  </action>
  <verify>
Run `npm run build -w packages/engine` - should compile without errors.
Run `npm test -w packages/engine` - all tests should pass.
Verify ConditionTracer no longer appears in exports: `grep -r "ConditionTracer" packages/engine/src`
  </verify>
  <done>
condition-tracer.ts deleted.
ConditionTracer removed from all exports.
Package builds successfully.
All tests pass.
No ConditionTracer references remain in engine/src.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build -w packages/engine` succeeds
- [ ] `npm test -w packages/engine` passes all tests
- [ ] Object conditions produce automatic ConditionDetail traces
- [ ] Function conditions still work (backward compatibility)
- [ ] `grep -r "ConditionTracer" packages/engine/src` returns no matches
- [ ] condition-tracer.ts file no longer exists
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Object conditions auto-trace without manual tracer usage
- ConditionTracer completely removed from engine
- Phase 14 complete, ready for Phase 15 (game migrations)
</success_criteria>

<output>
After completion, create `.planning/phases/14-condition-api-refactor/14-02-SUMMARY.md`:

# Phase 14 Plan 02: Auto-tracing and ConditionTracer Removal Summary

**[One-liner summarizing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `packages/engine/src/action/action.ts` - Added object condition evaluation with auto-tracing
- `packages/engine/src/action/condition-tracer.ts` - DELETED
- `packages/engine/src/action/index.ts` - Removed ConditionTracer export
- `packages/engine/src/action/types.ts` - Removed ConditionTracer import
- `packages/engine/src/index.ts` - Removed ConditionTracer export

## Decisions Made

[Any decisions or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 14 complete. Ready for Phase 15: game-migrations (update all games to new condition format)
</output>
