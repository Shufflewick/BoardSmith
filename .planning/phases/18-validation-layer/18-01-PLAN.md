---
phase: 18-validation-layer
plan: 01
type: execute
---

<objective>
Add clear error messages when state transfer fails and implement graceful flow position recovery.

Purpose: Make HMR failures understandable and recoverable. When dev state transfer fails, developers get actionable error messages explaining what went wrong and what to do. When flow structure changes, the game recovers gracefully instead of crashing.

Output: Enhanced dev-state.ts with validation, detailed error reporting, and flow recovery logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-dev-state-transfer/17-01-SUMMARY.md

**Key files from Phase 17:**
@packages/engine/src/utils/dev-state.ts
@packages/session/src/game-session.ts

**Constraining decisions:**
- Phase 17: "Use toJSON() for state capture - getters automatically excluded"
- Phase 17: "Dual-path HMR: dev transfer primary, replay fallback"

**Flow restoration context:**
@packages/engine/src/flow/engine.ts (FlowEngine.restore method, lines 437-463)
@packages/engine/src/flow/types.ts (FlowPosition interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comprehensive snapshot validation with actionable errors</name>
  <files>packages/engine/src/utils/dev-state.ts</files>
  <action>
Enhance `validateDevSnapshot` to perform deep validation and return structured results:

1. **Class validation** (already exists, enhance error messages):
   - Check all snapshot classes exist in registry
   - For missing classes, include: class name, where it appears in tree, registration instructions

2. **Schema validation** (new):
   - Validate snapshot structure matches DevSnapshot interface
   - Check required fields: elements, flowPosition, randomState, timestamp
   - Validate elements have required ElementJSON structure

3. **Property compatibility validation** (new):
   - For each element in snapshot, check if class in registry has matching stored property names
   - Detect property renames (old property in snapshot, not in class)
   - Detect type changes where possible (primitive type mismatches)

Create a `ValidationResult` interface:
```typescript
interface ValidationResult {
  valid: boolean;
  errors: ValidationError[];
  warnings: ValidationWarning[];
}

interface ValidationError {
  type: 'missing-class' | 'schema-error' | 'property-mismatch';
  message: string;
  path: string[];  // Element path in tree
  suggestion: string;  // Actionable fix
}

interface ValidationWarning {
  type: 'new-property' | 'type-change';
  message: string;
  path: string[];
}
```

Format errors with clear structure:
```
[HMR] State transfer blocked:

ERROR: Missing class "CustomCard"
  Path: game > deck > children[0]
  Fix: Register the class in your Game constructor:
       this.registerElements([CustomCard, ...]);

ERROR: Property mismatch in "Player"
  Path: game > players[0]
  Old property "score" not found in new class
  Fix: If renamed, update the property name consistently
```
  </action>
  <verify>npm run typecheck passes, validation detects mock missing class and property mismatches in tests</verify>
  <done>ValidationResult interface exists with errors/warnings, validateDevSnapshot catches class and property issues with actionable messages</done>
</task>

<task type="auto">
  <name>Task 2: Implement graceful flow position recovery</name>
  <files>packages/engine/src/utils/dev-state.ts, packages/engine/src/flow/engine.ts</files>
  <action>
Add flow position validation and recovery:

1. **In dev-state.ts**, add `validateFlowPosition` function:
   - Takes snapshot.flowPosition and new flow definition
   - Walks the position.path against flow structure
   - Returns: { valid: true } | { valid: false, reason: string, recoveryPosition: FlowPosition }
   - Recovery: Return position truncated to last valid depth

2. **In FlowEngine**, add `tryRestore` method (safer alternative to `restore`):
```typescript
tryRestore(position: FlowPosition): { success: true } | { success: false; error: string; validPath: number[] }
```
   - Wraps restore() logic with bounds checking
   - If path[i] >= children.length, return failure with validPath
   - This enables dev-state to recover by truncating

3. **In restoreDevState**, handle flow recovery:
   - Call validateFlowPosition before attempting restore
   - If invalid but recoverable: log warning, use recovery position
   - If completely invalid (e.g., no flow definition): skip flow restore, log warning

Console output for recovery:
```
[HMR] Flow position recovery:
  Original position: [1, 3, 2] (phase "trading" > step 4 > move 3)
  Flow structure changed (step 4 no longer exists)
  Recovering to: [1] (phase "trading")
  Note: Game may need manual action to resume
```
  </action>
  <verify>npm run typecheck passes, flow recovery test with invalid position recovers without crashing</verify>
  <done>tryRestore method exists in FlowEngine, validateFlowPosition in dev-state, invalid flow positions recover gracefully with logging</done>
</task>

<task type="auto">
  <name>Task 3: Integrate validation into GameSession HMR path</name>
  <files>packages/session/src/game-session.ts</files>
  <action>
Update `#reloadWithDevTransfer` to use new validation:

1. **Pre-transfer validation**:
   - Call enhanced validateDevSnapshot before attempting restore
   - If errors: log detailed messages, return null to fall back to replay
   - If warnings only: log warnings, proceed with transfer

2. **Structured console output**:
   - Success: Keep existing success messages
   - Validation failure: Show all errors with paths and suggestions
   - Flow recovery: Show recovery details
   - Fallback: Clear message that replay is being used and why

3. **Error aggregation**:
   - Collect all validation errors (don't fail on first)
   - Group by type (class issues, property issues, flow issues)
   - Show count summary: "3 errors, 1 warning - falling back to replay"

Example output for validation failure:
```
[HMR] Validation failed (2 errors):

  1. Missing class "CustomCard"
     Path: game > deck > children[0]
     Fix: this.registerElements([CustomCard, ...]);

  2. Property "oldScore" not found in Player
     Path: game > players[0]
     Fix: If renamed, update property name consistently

[HMR] Falling back to replay...
```
  </action>
  <verify>npm run typecheck passes, HMR with intentional class mismatch shows clear error and falls back to replay</verify>
  <done>GameSession validates before transfer, shows structured error output, gracefully falls back on validation failure</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` succeeds without errors
- [ ] `npm run test` passes all tests (442+ tests)
- [ ] Validation catches missing class with actionable error message
- [ ] Validation catches property mismatch with path and suggestion
- [ ] Flow position recovery truncates invalid path and continues
- [ ] GameSession shows structured validation errors before fallback
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ValidationResult interface with errors and warnings
- validateFlowPosition function with recovery logic
- FlowEngine.tryRestore method for safe restoration
- GameSession shows actionable errors before fallback
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/18-validation-layer/18-01-SUMMARY.md`:

# Phase 18 Plan 01: Validation Layer Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 19 (dev-checkpoints) or notes on blockers]
</output>
