---
phase: 21-worker-infrastructure
plan: 01
type: execute
---

<objective>
Create worker thread infrastructure for parallel AI training simulations.

Purpose: Enable multi-core utilization during `train-ai` to achieve near-linear speedup.
Output: simulation-worker.ts and parallel-simulator.ts that can run games across multiple CPU cores.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./21-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-simulator-exports/20-01-SUMMARY.md

@packages/ai-trainer/src/types.ts
@packages/ai-trainer/src/simulator.ts
@packages/ai-trainer/src/index.ts

**From Phase 20:**
- `simulateSingleGame` is now exported
- `SerializableSimulationOptions` contains all structured-cloneable data for workers
- `serializeGameStructure()` and `deserializeGameStructure()` handle Map/Set conversion
- Workers regenerate features from structure using `generateCandidateFeatures(deserializeGameStructure(data.structure))`

**Tech constraints:**
- Node.js worker_threads API (built-in, no new dependencies)
- TypeScript 5.7, ES2022 target
- Workers import game module dynamically via `file://` URL
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create simulation-worker.ts</name>
  <files>packages/ai-trainer/src/simulation-worker.ts</files>
  <action>
Create a worker thread script that:

1. Imports `parentPort` and `workerData` from `worker_threads`
2. Listens for messages containing `SerializableSimulationOptions`
3. On message:
   - Dynamically imports the game module from `options.gameModulePath`
   - Deserializes the game structure using `deserializeGameStructure()`
   - Regenerates features using `generateCandidateFeatures()`
   - Calls `simulateSingleGame()` with the GameClass and options
   - Posts the `GameData` result back to parent

Key implementation details:
- Use `await import()` for dynamic game module import (ESM)
- Extract `gameDefinition.gameClass` from the imported module
- Build `SingleGameOptions` from the serializable options
- Handle errors gracefully - post error message back to parent on failure
- Worker stays alive for multiple games (no self.close() after each game)

Error handling:
- Wrap the entire message handler in try/catch
- On error, post `{ error: string, seed: string }` back to parent so coordinator can track failures
- Log errors to stderr for debugging

Do NOT use `eval()` or code serialization - features are regenerated from structure data.
  </action>
  <verify>
```bash
# File exists and compiles
npx tsc --noEmit packages/ai-trainer/src/simulation-worker.ts
```
  </verify>
  <done>simulation-worker.ts exists with message handler that imports game, regenerates features, runs simulation, posts results</done>
</task>

<task type="auto">
  <name>Task 2: Create parallel-simulator.ts and export</name>
  <files>packages/ai-trainer/src/parallel-simulator.ts, packages/ai-trainer/src/index.ts</files>
  <action>
Create parallel-simulator.ts with:

**ParallelSimulatorOptions interface:**
```typescript
interface ParallelSimulatorOptions {
  /** Number of worker threads (default: os.cpus().length - 1) */
  workerCount?: number;
  /** Batch size per worker (default: 10 games) */
  batchSize?: number;
}
```

**runParallelSimulations function:**
```typescript
async function runParallelSimulations<G extends Game>(
  gameModulePath: string,  // Absolute path to compiled game module
  gameType: string,
  options: SimulationOptions,
  structure: GameStructure,
  parallelOptions?: ParallelSimulatorOptions
): Promise<SimulationResults>
```

Implementation:
1. Determine worker count (default: `os.cpus().length - 1`, min 1, cap at gameCount)
2. Create worker pool using `new Worker(workerPath)`
3. Serialize the game structure once using `serializeGameStructure()`
4. Distribute games across workers in batches
5. Use a work-stealing pattern: when a worker finishes a batch, give it the next batch
6. Collect `GameData` results as workers complete
7. Aggregate into final `SimulationResults` (same format as `runSimulations`)
8. Call `options.onProgress` after each game completes
9. Terminate all workers when done

Worker lifecycle:
- Create workers using `new Worker(new URL('./simulation-worker.js', import.meta.url))`
- Each worker stays alive for multiple games
- Terminate workers after all games complete using `worker.terminate()`

Error handling:
- If a worker crashes, redistribute its pending games to other workers
- If a game errors (worker posts error), count as incomplete (same as timeout)
- Don't let one bad game crash the entire simulation

Progress tracking:
- Track completed games across all workers
- Call onProgress with accurate count
- Handle out-of-order completion (games may finish in different order than started)

Update index.ts to export:
- `runParallelSimulations` function
- `ParallelSimulatorOptions` type
  </action>
  <verify>
```bash
# Files exist and compile
npx tsc --noEmit packages/ai-trainer/src/parallel-simulator.ts
# Check exports
grep -n "runParallelSimulations" packages/ai-trainer/src/index.ts
```
  </verify>
  <done>parallel-simulator.ts creates worker pool, distributes work, aggregates results; exported from index.ts</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm --filter @boardsmith/ai-trainer build` succeeds
- [ ] simulation-worker.ts compiles without errors
- [ ] parallel-simulator.ts compiles without errors
- [ ] Both new exports appear in index.ts
- [ ] No new dependencies added (worker_threads is built-in)
</verification>

<success_criteria>

- simulation-worker.ts handles game simulation in worker thread
- parallel-simulator.ts coordinates worker pool and distributes work
- Both files use SerializableSimulationOptions from Phase 20
- Features are regenerated from structure (not serialized functions)
- Progress callback works across parallel workers
- Exports added to index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/21-worker-infrastructure/21-01-SUMMARY.md`:

# Phase 21 Plan 01: Worker Infrastructure Summary

**[One-liner: what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `packages/ai-trainer/src/simulation-worker.ts` - Worker thread script
- `packages/ai-trainer/src/parallel-simulator.ts` - Parallel coordinator
- `packages/ai-trainer/src/index.ts` - Added exports

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 22 (cli-integration): Add --parallel and --workers CLI flags
</output>
