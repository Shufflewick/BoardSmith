---
phase: 22-cli-integration
plan: 01
type: execute
---

<objective>
Add --parallel and --workers CLI flags to train-ai command and integrate with parallel simulator.

Purpose: Enable multi-core AI training from the command line.
Output: train-ai command supports --parallel flag with optional --workers count.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phases this builds on:
@.planning/phases/20-simulator-exports/20-01-SUMMARY.md
@.planning/phases/21-worker-infrastructure/21-01-SUMMARY.md

# Source files:
@packages/cli/src/cli.ts
@packages/cli/src/commands/train-ai.ts
@packages/ai-trainer/src/parallel-simulator.ts
@packages/ai-trainer/src/trainer.ts

**Tech stack available:**
- runParallelSimulations function (from Phase 21)
- ParallelSimulatorOptions type (from Phase 21)
- SerializableSimulationOptions types (from Phase 20)
- serializeGameStructure, deserializeGameStructure (from Phase 20)

**Established patterns:**
- Work-stealing for load balancing across workers
- Worker crash recovery with work redistribution
- Features regenerated in workers from serialized structure

**Key insight from trainer.ts:**
- AITrainer calls `runSimulations()` in a loop (line 156)
- Need to swap to `runParallelSimulations()` when parallel mode enabled
- runParallelSimulations needs: gameModulePath, gameType, options, structure, parallelOptions
- The trainer already has structure (this.structure) and can get gameModulePath from CLI context
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI flags for parallel training</name>
  <files>packages/cli/src/cli.ts, packages/cli/src/commands/train-ai.ts</files>
  <action>
  1. In cli.ts, add two new options to the train-ai command:
     - `--parallel` (boolean flag) - Enable parallel simulation using worker threads
     - `--workers <count>` (optional number) - Number of worker threads (default: CPU cores - 1)

  2. In train-ai.ts, update TrainAIOptions interface to include:
     - `parallel?: boolean`
     - `workers?: string` (parsed to number, undefined means auto-detect)

  Pattern follows existing flags like --games, --iterations which are strings parsed to ints.
  </action>
  <verify>
  Run `npx boardsmith train-ai --help` and confirm --parallel and --workers appear in output.
  </verify>
  <done>
  - --parallel flag appears in train-ai --help
  - --workers flag appears with description mentioning CPU cores
  - TrainAIOptions includes parallel and workers
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate parallel simulation into trainer</name>
  <files>packages/cli/src/commands/train-ai.ts, packages/ai-trainer/src/trainer.ts, packages/ai-trainer/src/types.ts</files>
  <action>
  The integration happens at the CLI level, not inside AITrainer. Reason: AITrainer doesn't know the game module path (it has GameClass, not the path to import it). The CLI knows the module path.

  **Approach A (simpler, recommended):** Bypass AITrainer for parallel mode

  When --parallel is set in trainAICommand:
  1. Import runParallelSimulations from @boardsmith/ai-trainer
  2. After introspecting game structure, run parallel simulations directly instead of using AITrainer.train()
  3. Feed results to the analyzer and code generator manually

  This duplicates some orchestration logic but keeps the parallel path clean.

  **Implementation:**
  1. In trainAICommand, after loading game module and getting structure:
     - If parallel mode enabled:
       - Import runParallelSimulations, analyzeFeatures, selectTopFeatures from ai-trainer
       - For each iteration:
         - Call runParallelSimulations(modulePath, gameType, simOptions, structure, { workerCount })
         - Analyze results with analyzeFeatures
         - Update progress
       - Generate AI code from analyzed results
     - If NOT parallel (existing path):
       - Use AITrainer as before

  2. Log parallel mode status in CLI output:
     - "Parallel mode: enabled (X workers)" or "Parallel mode: disabled"

  **Key parameters for runParallelSimulations:**
  - gameModulePath: absolute path to the game module (already have as modulePath)
  - gameType: already have
  - options: SimulationOptions with gameCount, playerCount, features, timeout, maxActions, seed, aiConfig, onProgress
  - structure: GameStructure from introspectGame
  - parallelOptions: { workerCount: parsed workers option or undefined for auto }

  **Important:** Do NOT try to integrate parallel into AITrainer class itself - it would require passing module paths through the class which breaks the clean API.
  </action>
  <verify>
  1. Build the CLI package: `pnpm --filter @boardsmith/cli build`
  2. In a test game directory, run: `npx boardsmith train-ai --parallel --games 20 --iterations 1 -v`
  3. Verify output shows "Parallel mode: enabled" with worker count
  4. Verify training completes successfully
  </verify>
  <done>
  - Parallel mode logs worker count at startup
  - Games are distributed across workers (visible in verbose output)
  - Training completes and generates ai.ts
  - Non-parallel mode (without --parallel) still works as before
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm --filter @boardsmith/cli build` succeeds
- [ ] `npx boardsmith train-ai --help` shows --parallel and --workers options
- [ ] Parallel training runs and produces ai.ts
- [ ] Non-parallel training still works (no regression)
- [ ] Worker count can be customized with --workers
</verification>

<success_criteria>

- Both tasks completed
- All verification checks pass
- No TypeScript errors
- Parallel training produces same-quality results as serial training
</success_criteria>

<output>
After completion, create `.planning/phases/22-cli-integration/22-01-SUMMARY.md`:

# Phase 22 Plan 01: CLI Integration Summary

**[One-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 23 (verification): Verify correctness and benchmark speedup.
</output>
