---
phase: 26-training-improvements
plan: 03
type: execute
---

<objective>
Integrate evolution into training loop and add CLI options for evolutionary training.

Purpose: Wire up the evolution system from 26-02 into the actual training pipeline, making evolution opt-in via CLI flag. Add verification that training produces measurable improvement.

Output: `--evolve` flag for train-ai command, evolutionary training loop, verified improvement on Hex.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-training-improvements/26-01-PLAN.md
@.planning/phases/26-training-improvements/26-02-PLAN.md

@packages/ai-trainer/src/trainer.ts
@packages/cli/src/commands/train-ai.ts

**Tech stack:** TypeScript, ora (spinner), chalk (colors)
**Established patterns:** CLI options parsing, progress reporting
**Constraining decisions:**
- 26-01: benchmarkAI exists for fitness measurement
- 26-02: evolution functions exist (mutate, crossover, select, generateOffspring)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add evolutionary training mode to AITrainer</name>
  <files>packages/ai-trainer/src/trainer.ts, packages/ai-trainer/src/types.ts</files>
  <action>
Add evolution config to TrainingConfig (types.ts):
```typescript
/** Enable evolutionary weight optimization */
evolve?: boolean;
/** Evolution generations (default 5) */
evolutionGenerations?: number;
/** Parent population size µ (default 5) */
evolutionMu?: number;
/** Offspring population size λ (default 20) */
evolutionLambda?: number;
/** Initial mutation sigma (default 1.0) */
evolutionSigma?: number;
/** Benchmark games per fitness evaluation (default 50) */
evolutionBenchmarkGames?: number;
```

Update DEFAULT_TRAINING_CONFIG with sensible defaults.

In trainer.ts, add evolutionary training mode:

1. After initial correlation-based training completes (existing flow), if config.evolve:
   - Report "Starting evolutionary optimization..."
   - Initialize parent population from correlation-based objectives
   - For each generation:
     a. Generate lambda offspring via mutation/crossover
     b. Benchmark each offspring (fitness = win rate)
     c. Select top mu as new parents
     d. Decay sigma (sigma *= 0.9)
     e. Report progress: "Generation X: best fitness Y%"
   - Final objectives = best from last generation

2. Update metadata to track evolution stats:
   - evolutionGenerations completed
   - final population fitness

Import evolution functions from ./evolution.ts.
  </action>
  <verify>
```bash
cd packages/ai-trainer && npx tsc --noEmit
npm run build -w packages/ai-trainer
```
Both pass.
  </verify>
  <done>Evolutionary training mode works when config.evolve=true, evolution parameters configurable</done>
</task>

<task type="auto">
  <name>Task 2: Add --evolve CLI flag and progress reporting</name>
  <files>packages/cli/src/commands/train-ai.ts</files>
  <action>
Add CLI options:
- `--evolve` - Enable evolutionary weight optimization
- `--generations <n>` - Evolution generations (default 5)
- `--population <n>` - Population size (default 20)

Update TrainAIOptions interface and option parsing.

Pass evolution config to AITrainer:
```typescript
const trainer = new AITrainer(GameClass, gameType, {
  ...existingConfig,
  evolve: options.evolve,
  evolutionGenerations: options.generations ? parseInt(options.generations) : undefined,
  evolutionLambda: options.population ? parseInt(options.population) : undefined,
});
```

Update progress reporting to show evolution status:
- "Generation 1/5: Evaluating 20 candidates..."
- "Generation 1/5: Best fitness 62.0%"

Also update parallel mode path to support evolution (or skip evolution in parallel mode with warning for now - evolution requires sequential benchmark evaluation).
  </action>
  <verify>
```bash
cd packages/cli && npx tsc --noEmit
# Check help text includes new options
cd /Users/jtsmith/board_game_service/BoardSmith && npx boardsmith train-ai --help 2>&1 | grep -i evolve
```
Type-checks and --evolve appears in help.
  </verify>
  <done>--evolve flag works, progress shows generation/fitness, parallel mode warns if --evolve used</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Evolutionary AI training with measurable improvement</what-built>
  <how-to-verify>
1. Navigate to a Hex game directory:
   ```bash
   cd packages/games/hex
   ```

2. Build the rules:
   ```bash
   pnpm build
   ```

3. Run baseline training (no evolution) and note win rate:
   ```bash
   npx boardsmith train-ai --games 100 --iterations 2 --fresh
   ```

4. Run evolutionary training and compare:
   ```bash
   npx boardsmith train-ai --games 100 --iterations 2 --evolve --generations 3 --fresh
   ```

5. Verify:
   - Evolution mode runs without errors
   - Generation progress is shown
   - Final win rate is displayed (should be >50% vs random)
   - Evolutionary version should show improvement over baseline (not guaranteed but likely)

Note: Full training with evolution takes longer. The checkpoint is to verify the system works, not to achieve optimal results.
  </how-to-verify>
  <resume-signal>Type "approved" if evolution runs and reports progress, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build -w packages/ai-trainer` succeeds
- [ ] `npm run build -w packages/cli` succeeds
- [ ] `npx boardsmith train-ai --help` shows --evolve option
- [ ] Evolution mode runs on Hex game
- [ ] Progress reporting shows generation/fitness
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Evolutionary training produces output with real win rate
- Human verified that evolution runs end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/26-training-improvements/26-03-SUMMARY.md`
</output>
