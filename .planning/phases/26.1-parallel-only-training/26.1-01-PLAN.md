---
phase: 26.1-parallel-only-training
plan: 01
type: execute
---

<objective>
Consolidate training harnesses - make parallel the only execution path.

Purpose: Eliminate duplicate AITrainer vs parallel-path code, enabling evolution in parallel mode and simplifying maintenance.
Output: Single parallel-based training implementation with full feature parity.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-training-improvements/26-02-SUMMARY.md
@.planning/phases/26-training-improvements/26-03-SUMMARY.md

**Problem:**
train-ai.ts has two separate code paths (lines 170-336):
1. Non-parallel path (lines 306-336): Uses `AITrainer` class with evolution, benchmarking
2. Parallel path (lines 172-305): Reimplements training logic directly, no evolution

**Solution:**
Create `ParallelTrainer` class that wraps parallel simulation with AITrainer's iteration logic:
- Uses `runParallelSimulations` for game execution (fast, multi-core)
- Keeps AITrainer's iteration loop, analysis, evolution integration
- Single code path in train-ai.ts

**Key files:**
@packages/cli/src/commands/train-ai.ts
@packages/ai-trainer/src/trainer.ts
@packages/ai-trainer/src/parallel-simulator.ts
@packages/ai-trainer/src/evolution.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ParallelTrainer class with worker-based simulation</name>
  <files>packages/ai-trainer/src/parallel-trainer.ts, packages/ai-trainer/src/index.ts</files>
  <action>
Create new ParallelTrainer class that:
1. Takes same constructor args as AITrainer (GameClass, gameType, config) PLUS gameModulePath (required for worker threads)
2. Has same `train()` method signature returning TrainingResult
3. Uses `runParallelSimulations` for game execution instead of `runSimulations`
4. Integrates the existing `runEvolution` logic from AITrainer (copy it over)
5. Integrates benchmarking between iterations (copy from AITrainer)
6. Reports progress via config.onProgress callback (same as AITrainer)

Key differences from AITrainer:
- Constructor takes `gameModulePath: string` parameter (path to compiled .js file)
- Uses parallel simulation instead of serial
- Worker count configurable via config.workerCount (default: os.cpus().length - 1)

Export from index.ts alongside AITrainer.
  </action>
  <verify>npm run build passes in ai-trainer package, ParallelTrainer exported</verify>
  <done>ParallelTrainer class exists with train() method, exports cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Update train-ai.ts to use ParallelTrainer exclusively</name>
  <files>packages/cli/src/commands/train-ai.ts</files>
  <action>
Replace the dual-path code (lines 170-336) with single ParallelTrainer usage:
1. Remove the parallelMode branching entirely
2. Always use ParallelTrainer (parallel is now the only mode)
3. Remove --parallel flag from CLI options (it's now always on)
4. Keep --workers flag for controlling worker count
5. Evolution now works since ParallelTrainer has it built-in

The refactored train() section should be ~30 lines instead of ~160 lines:
- Create ParallelTrainer with config
- Call trainer.train()
- Use result

Update console output to remove "Parallel mode: enabled/disabled" since it's always parallel.
  </action>
  <verify>npm run build passes in cli package</verify>
  <done>train-ai uses single ParallelTrainer path, no dual-harness</done>
</task>

<task type="auto">
  <name>Task 3: Update CLI to remove --parallel flag</name>
  <files>packages/cli/src/cli.ts</files>
  <action>
Remove the --parallel flag since parallel is now always on:
1. Remove `.option('--parallel', 'Run training in parallel mode')` from train-ai command
2. Keep --workers flag as it still controls parallelism level
3. Optionally add brief note in help text that training uses all available cores by default
  </action>
  <verify>boardsmith train-ai --help shows --workers but not --parallel</verify>
  <done>--parallel flag removed, --workers retained</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds in all packages (ai-trainer, cli)
- [ ] `npm test` passes in ai-trainer package
- [ ] ParallelTrainer has evolution support (runEvolution method)
- [ ] train-ai command works: `cd packages/games/hex && npx boardsmith train-ai --games 20 --iterations 1`
- [ ] Evolution works in parallel: `npx boardsmith train-ai --games 20 --iterations 1 --evolve`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Single code path for training (no parallelMode branching)
- Evolution works (previously skipped in parallel mode)
- No performance regression
</success_criteria>

<output>
After completion, create `.planning/phases/26.1-parallel-only-training/26.1-01-SUMMARY.md`
</output>
