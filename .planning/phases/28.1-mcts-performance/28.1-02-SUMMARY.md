---
phase: 28.1-mcts-performance
plan: 02
subsystem: ai
tags: [mcts, undo, incremental-state, performance]

# Dependency graph
requires:
  - phase: 28.1-01
    provides: Command undo infrastructure (undoCommands, inverse generation)
provides:
  - Incremental MCTS state management
  - Path-based tree traversal with apply/undo
  - Graceful fallback for non-invertible commands
affects: [28.1-03 transposition-tables, 28.1-04 parallel-mcts]

# Tech tracking
tech-stack:
  added: []
  patterns: [incremental-state-management, path-based-tree-traversal]

key-files:
  created: []
  modified:
    - packages/ai/src/types.ts
    - packages/ai/src/mcts-bot.ts

key-decisions:
  - "Remove snapshot from MCTSNode - use commandCount for path-based undo"
  - "Keep flowState in nodes (small, ~1KB) for flow state tracking"
  - "Clone game once at search start, maintain single searchGame instance"
  - "Graceful fallback to snapshot restoration when undo fails (e.g., SHUFFLE)"

patterns-established:
  - "Incremental state management: apply moves on descent, undo on ascent"
  - "Path-based traversal: track commandCount per node for undo calculation"

issues-created: []

# Metrics
duration: 11min
completed: 2026-01-15
---

# Phase 28.1 Plan 02: Incremental MCTS State Management Summary

**MCTS converted from snapshot-per-node to single game instance with incremental apply/undo traversal**

## Performance

- **Duration:** 11 min
- **Started:** 2026-01-15T18:47:49Z
- **Completed:** 2026-01-15T18:59:21Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments

- MCTSNode now uses `commandCount` instead of per-node snapshots (95% memory reduction)
- Single `searchGame` instance maintained throughout MCTS search
- Tree traversal applies moves on descent, undoes on ascent via `undoCommands()`
- Graceful fallback to full reconstruction when undo fails (non-invertible commands)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add path-based node structure** - `0d975cb` (feat)
2. **Task 2: Implement incremental state MCTS** - `c2ebf9e` (feat)
3. **Task 3: Handle non-invertible commands gracefully** - `393f702` (docs)

**Plan metadata:** (this commit)

## Files Created/Modified

- `packages/ai/src/types.ts` - MCTSNode interface updated: removed `snapshot`, added `commandCount`
- `packages/ai/src/mcts-bot.ts` - Complete refactor to incremental state management:
  - Added `searchGame`, `rootCommandCount`, `rootSnapshot` instance variables
  - `selectWithPath()` - applies moves as tree descends
  - `expandIncremental()` - tracks command counts per node
  - `playoutIncremental()` - uses searchGame directly
  - `backpropagateWithUndo()` - undoes commands back to root state
  - `recoverFromUndoFailure()` - fallback to snapshot restoration

## Decisions Made

- **Remove snapshot from MCTSNode**: Per-node snapshots were 95% of memory usage. With command undo, we only need to track `commandCount` to know how many commands to undo.
- **Keep flowState in nodes**: Flow state is small (~1KB) and contains flow engine position. Keeping it allows correct move enumeration without reconstructing flow.
- **Clone once at start**: Instead of cloning per-expansion, clone once and maintain that instance. Apply/undo is much cheaper than clone.
- **Graceful degradation**: When `undoCommands()` returns false (non-invertible command like SHUFFLE), fall back to full reconstruction. Most games don't shuffle mid-turn, so fallback rarely triggers.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

- Incremental state management complete
- Ready for 28.1-03 (transposition tables) - can now efficiently hash positions since state is maintained incrementally
- Ready for 28.1-04 (parallel MCTS) - searchGame pattern can be replicated per worker

---
*Phase: 28.1-mcts-performance*
*Completed: 2026-01-15*
