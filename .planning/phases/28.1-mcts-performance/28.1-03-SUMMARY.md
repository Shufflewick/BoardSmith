---
phase: 28.1-mcts-performance
plan: 03
subsystem: ai
tags: [mcts, caching, transposition-table, performance]

# Dependency graph
requires:
  - phase: 28.1-02
    provides: Incremental MCTS state management (searchGame, apply/undo)
provides:
  - Move caching per node (allMoves field)
  - Transposition table for position evaluation caching
  - Configurable caching via useTranspositionTable option
affects: [28.1-04 parallel-mcts]

# Tech tracking
tech-stack:
  added: []
  patterns: [move-caching, transposition-tables, flow-state-hashing]

key-files:
  created:
    - packages/ai/tests/mcts-cache.test.ts
  modified:
    - packages/ai/src/types.ts
    - packages/ai/src/mcts-bot.ts

key-decisions:
  - "Cache allMoves per node - moves enumerated once at node creation, reused on revisits"
  - "Use flowState.position for hashing - commandHistory not populated during continueFlow"
  - "3-visit confidence threshold - return cached value only after sufficient samples"
  - "Running average for cached values - improves estimate as more visits accumulate"
  - "Clear transposition table per search - avoid stale data between play() calls"

patterns-established:
  - "Flow state position hashing: JSON.stringify(flowState.position) uniquely identifies game state"
  - "Evaluation caching: check table -> evaluate if miss -> update with running average"

issues-created: []

# Metrics
duration: 12min
completed: 2026-01-15
---

# Phase 28.1 Plan 03: Move Caching and Transposition Tables Summary

**Added move caching per node and transposition table for position evaluations to reduce redundant computation**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-15T13:08:00Z
- **Completed:** 2026-01-15T13:25:00Z
- **Tasks:** 3
- **Files created:** 1
- **Files modified:** 2

## Accomplishments

- MCTSNode now caches `allMoves` at creation time - moves enumerated once per node
- Transposition table (`Map<string, {value, visits}>`) caches position evaluations
- Position hashing uses `flowState.position` which uniquely tracks game progression
- 3-visit confidence threshold prevents returning low-quality cached values
- Running average improves cached estimates as more samples accumulate
- `useTranspositionTable` config option allows disabling (default: true)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add move caching per node** - `49b52da` (feat)
2. **Task 2: Add transposition table for evaluations** - `2173ab4` (feat)
3. **Task 3: Benchmark and verify correctness** - `0c199dd` (test)

**Plan metadata:** (this commit)

## Files Created/Modified

- `packages/ai/src/types.ts`:
  - Added `allMoves: BotMove[]` to MCTSNode interface
  - Added `useTranspositionTable?: boolean` to BotConfig

- `packages/ai/src/mcts-bot.ts`:
  - Added `transpositionTable: Map<string, {value, visits}>` instance variable
  - Added `hashPosition(game, flowState)` - uses JSON.stringify of flowState.position
  - Added `evaluateWithCache(game, flowState)` - caching wrapper around evaluation
  - Updated `createNode()` to store `allMoves` and initialize `untriedMoves` from it
  - Updated `playoutIncremental()` to use `evaluateWithCache`
  - Table cleared at start of each `play()` call

- `packages/ai/tests/mcts-cache.test.ts` (new):
  - Move caching tests (allMoves consistency, enumeration consistency)
  - Transposition table tests (enabled/disabled, hash determinism, table clearing)
  - Performance benchmark test (skipped by default)

## Decisions Made

- **Use flowState.position for hashing**: Initially tried commandHistory, but `continueFlow()` doesn't populate it (only `execute()` does). Flow state position changes with each action and uniquely identifies game state.
- **3-visit confidence threshold**: Don't trust cached values until we have multiple samples. Prevents over-reliance on single evaluation.
- **Running average**: As we revisit positions, the cached value converges to true expected value. Better than simple overwrite.
- **Clear per search**: Each `play()` call starts fresh. Prevents stale evaluations from previous searches affecting current decision.

## Deviations from Plan

- **Hash function changed**: Plan suggested command history, but discovered `continueFlow()` doesn't populate `commandHistory`. Switched to `flowState.position` which correctly tracks game state changes.

## Issues Encountered

- **Empty commandHistory**: Discovered that `game.continueFlow()` doesn't add to `commandHistory` (only `game.execute()` does). Required switching hash strategy to use flow state position instead.

## Verification Results

- `pnpm build`: Passed (with pre-existing UI type warnings)
- `pnpm test`: 527 passed, 3 failed (E2E tests require server), 1 skipped
- All mcts-cache tests pass
- All mcts-bot tests pass

## Next Phase Readiness

- Caching infrastructure complete
- Ready for 28.1-04 (parallel MCTS) - transposition table pattern can be shared or replicated per worker
- Move caching reduces enumeration overhead for parallel workers

---
*Phase: 28.1-mcts-performance*
*Completed: 2026-01-15*
