---
phase: 31-trajectory-objectives
plan: 01
type: execute
---

<objective>
Add feature templates that detect momentum/trajectory rather than just static state.

Purpose: Current features evaluate "what is the state?" but not "who is gaining ground?". Trajectory features detect initiative, tempo, and position quality - key factors in strategic games.

Output: New feature templates in feature-templates.ts that capture momentum proxies detectable from a single game state.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/30-threat-response/30-01-SUMMARY.md
@.planning/phases/29-playout-lookahead/29-01-SUMMARY.md
@.planning/phases/25-structural-features/25-01-SUMMARY.md

# Source files:
@packages/ai-trainer/src/feature-templates.ts

**Established patterns:**
- Feature templates with `requires` for gameType filtering
- Evaluator factory functions returning `(game, playerIndex) => boolean`
- HEX_DIRECTIONS for hex adjacency, Dijkstra for path analysis
- getPlayerByIndex, getElementsForPlayer helpers

**Constraints:**
- No new dependencies (PROJECT.md constraint)
- Boolean evaluators only (current feature system design)
- Must work with existing GameStructure introspection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tempo/initiative feature templates</name>
  <files>packages/ai-trainer/src/feature-templates.ts</files>
  <action>
Add feature templates that detect who has tempo/initiative (forcing opponent to respond):

1. **path-differential** (connection games):
   - Template ID: `path-differential`
   - Category: `comparison`
   - Requires: `{ spatial: true, gameType: 'connection' }`
   - Description: "Player has significantly shorter path than opponent (tempo advantage)"
   - Evaluator: Returns true if `myPath < opponentPath - 1` (at least 2 stones ahead)
   - This is a trajectory indicator: larger differential = more forcing position

2. **threat-differential** (capture games):
   - Template ID: `threat-differential`
   - Category: `comparison`
   - Requires: `{ spatial: true, ownership: true, gameType: 'capture' }`
   - Description: "Player creates more threats than facing (attacking position)"
   - Evaluator: Returns true if `myThreatsToOpponent > opponentThreatsToMe`
   - Use existing `countThreatenedPieces` helper (swap player/opponent args)

3. **forcing-position** (connection games):
   - Template ID: `forcing-position`
   - Category: `boolean`
   - Requires: `{ spatial: true, gameType: 'connection' }`
   - Description: "Player is within 2 moves while opponent is further (forcing a response)"
   - Evaluator: Returns true if `myPath <= 2 && opponentPath > 2`

Add these to FEATURE_TEMPLATES array in a new section: `// TEMPO/INITIATIVE FEATURES`.
  </action>
  <verify>TypeScript compiles: `cd packages/ai-trainer && pnpm build`</verify>
  <done>Three new tempo/initiative templates added with working evaluators</done>
</task>

<task type="auto">
  <name>Task 2: Add position quality feature templates</name>
  <files>packages/ai-trainer/src/feature-templates.ts</files>
  <action>
Add feature templates that detect positions with high growth potential:

1. **bridge-potential** (connection games):
   - Template ID: `bridge-potential`
   - Category: `spatial`
   - Requires: `{ spatial: true, gameType: 'connection' }`
   - Description: "Player has more 'bridge' cells (empty cells adjacent to 2+ groups)"
   - Evaluator:
     - Use `countConnectedGroups` to find player's groups
     - For each empty cell, count how many distinct player groups it's adjacent to
     - Cells adjacent to 2+ groups are "bridge" cells
     - Return true if player has more bridge cells than opponent
   - Create helper `countBridgeCells(game, className, player)` for this

2. **expansion-room** (all spatial games):
   - Template ID: `expansion-room`
   - Category: `spatial`
   - Requires: `{ spatial: true, ownership: true }`
   - Description: "Player's pieces have more adjacent empty cells (expansion potential)"
   - Evaluator:
     - For each player piece, count adjacent empty cells
     - Sum total empty adjacencies
     - Return true if player has more than opponent
   - Create helper `countAdjacentEmpty(game, className, player)` using HEX_DIRECTIONS for hex or grid offsets

3. **central-mass** (all spatial games):
   - Template ID: `central-mass`
   - Category: `spatial`
   - Requires: `{ spatial: true, ownership: true }`
   - Description: "Player has more pieces closer to board center (strategic advantage)"
   - Evaluator:
     - Calculate average distance from center for each player's pieces
     - Return true if player's average is lower (closer to center)
   - Note: Different from `center-control` which checks threshold regions; this is continuous distance

Add these to FEATURE_TEMPLATES array in a new section: `// POSITION QUALITY FEATURES`.
  </action>
  <verify>TypeScript compiles: `cd packages/ai-trainer && pnpm build`</verify>
  <done>Three new position quality templates added with helper functions and working evaluators</done>
</task>

<task type="auto">
  <name>Task 3: Verify feature generation for test games</name>
  <files>packages/ai-trainer/src/feature-templates.ts</files>
  <action>
Verify the new features are generated correctly:

1. Add a simple test script to verify:
   - Create temporary test in `packages/ai-trainer/scripts/test-trajectory.ts`
   - Import `generateCandidateFeatures` and `FEATURE_TEMPLATES`
   - Create mock GameStructure for connection game (Hex-like)
   - Verify new templates generate features correctly
   - Print count of trajectory features generated

2. Run the test:
   ```bash
   cd packages/ai-trainer && npx tsx scripts/test-trajectory.ts
   ```

3. Verify expected output:
   - Should see 6 new features generated for connection games:
     - path-differential, forcing-position, bridge-potential (connection-specific)
     - expansion-room, central-mass (general spatial)
   - Should see 3 new features for capture games:
     - threat-differential (capture-specific)
     - expansion-room, central-mass (general spatial)

4. Clean up: Delete the test script after verification (temporary)

Note: This is verification only - if features aren't generating correctly, fix the template requirements or generate functions.
  </action>
  <verify>Test script runs without errors and shows expected feature counts</verify>
  <done>New trajectory features verified to generate correctly for both connection and capture game types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd packages/ai-trainer && pnpm build` succeeds
- [ ] All 6 new feature templates exist in FEATURE_TEMPLATES
- [ ] Helper functions created: countBridgeCells, countAdjacentEmpty, calculateCenterDistance
- [ ] Features generate correctly for connection games (verify with test)
- [ ] Features generate correctly for capture games (verify with test)
- [ ] `pnpm test -r` passes (no regressions)
</verification>

<success_criteria>
- All tasks completed
- TypeScript compiles without errors
- 6 new trajectory/momentum feature templates added
- Features properly categorized by game type
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/31-trajectory-objectives/31-01-SUMMARY.md` with:
- Summary of trajectory feature types added
- List of new templates and their categories
- Verification results
- Any design decisions made
</output>
