---
phase: 33-rave
plan: 01
type: execute
---

<objective>
Implement RAVE (Rapid Action Value Estimation) to improve MCTS move selection by learning from all simulations.

Purpose: RAVE uses the "All Moves As First" (AMAF) heuristic - moves that appear anywhere in a playout are credited to nodes where they could have been played first. This dramatically speeds up learning because each playout updates many move estimates, not just the moves actually selected in the tree.

Output: MCTS bot with optional RAVE support, configurable via `useRAVE` in BotConfig.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-move-ordering/32-01-SUMMARY.md

**Key source files:**
@packages/ai/src/types.ts
@packages/ai/src/mcts-bot.ts

**Algorithm Background:**
RAVE (Gelly & Silver, 2011) addresses a key MCTS weakness: each playout only updates the single path traversed in the tree. With RAVE:
- Track global move statistics (visits, value) across all playouts
- During selection, blend UCT value with RAVE value using a beta factor
- Beta starts high (trust RAVE early) and decreases as tree visits accumulate (trust UCT later)

**UCB1-RAVE Formula:**
```
value = (1 - beta) * UCT + beta * RAVE
beta = sqrt(k / (3*visits + k))  where k is a tuning constant (default: 500)
```

**Implementation approach:**
1. Add `raveTable: Map<string, { visits: number; value: number }>` to MCTSBot
2. Track moves played during playout in a list
3. After playout, update RAVE table for all moves in the playout path
4. Modify selectChild to blend UCT with RAVE values
5. Add `useRAVE` config option (default: true)

**Constraining decisions from prior phases:**
- Phase 32 added moveOrdering hook (RAVE complements this by improving early statistics)
- Phase 28.1 established incremental state management (RAVE tracks moves alongside)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RAVE data structures and config</name>
  <files>packages/ai/src/types.ts, packages/ai/src/mcts-bot.ts</files>
  <action>
1. In types.ts, add to BotConfig:
   - `useRAVE?: boolean` - Enable RAVE value estimation (default: true)
   - `raveK?: number` - RAVE beta decay constant (default: 500, higher = trust RAVE longer)

2. In mcts-bot.ts, add instance variables:
   - `raveTable: Map<string, { visits: number; value: number }>` - Global move statistics
   - Clear raveTable at start of each search (like transpositionTable)

3. Add helper method `getMoveKey(move: BotMove): string` that creates a unique key for a move.
   Use `${move.action}:${JSON.stringify(move.args)}` format.
  </action>
  <verify>TypeScript compiles without errors: `cd packages/ai && pnpm build`</verify>
  <done>BotConfig has useRAVE and raveK options, MCTSBot has raveTable Map</done>
</task>

<task type="auto">
  <name>Task 2: Track playout moves and update RAVE table</name>
  <files>packages/ai/src/mcts-bot.ts</files>
  <action>
1. Modify playoutIncremental to track moves played during playout:
   - Create `playoutMoves: BotMove[]` array at start of playout
   - Push each selected move to playoutMoves
   - Return both score AND playoutMoves from playout

2. Modify backpropagateWithUndo to accept playoutMoves:
   - After updating node statistics, update RAVE table for all playoutMoves
   - For each move in playoutMoves, update raveTable entry:
     - If not exists, create with { visits: 1, value: result }
     - If exists, update: visits++, value = running average

3. Also track tree path moves (from selection/expansion):
   - Collect moves from tree path during selectWithPath
   - Include both tree moves and playout moves in RAVE updates

NOTE: RAVE values are from the perspective of the player who made the move.
Handle perspective correctly - if bot is player 0 and opponent made a move,
that move's RAVE value should be updated with (1 - result) since a win for
bot is a loss for opponent's move quality.
  </action>
  <verify>Add console.log in backprop showing RAVE table size growing: run benchmark, see table grows</verify>
  <done>RAVE table is populated during search, entries show visits > 1 for common moves</done>
</task>

<task type="auto">
  <name>Task 3: Integrate RAVE into UCT selection</name>
  <files>packages/ai/src/mcts-bot.ts</files>
  <action>
1. Modify selectChild to blend UCT with RAVE:
   ```typescript
   private selectChild(node: MCTSNode): MCTSNode {
     const C = Math.sqrt(2);
     const k = this.config.raveK ?? 500;
     let best = node.children[0];
     let bestScore = -Infinity;

     for (const child of node.children) {
       // Standard UCT component
       const visits = child.visits + 1e-6;
       const exploitation = child.value / visits;
       const exploration = C * Math.sqrt(Math.log(node.visits + 1) / visits);
       const uct = exploitation + exploration;

       // RAVE component
       let score = uct;
       if (this.config.useRAVE !== false && child.parentMove) {
         const raveEntry = this.raveTable.get(this.getMoveKey(child.parentMove));
         if (raveEntry && raveEntry.visits > 0) {
           const raveValue = raveEntry.value / raveEntry.visits;
           const beta = Math.sqrt(k / (3 * visits + k));
           score = (1 - beta) * uct + beta * raveValue;
         }
       }

       if (score > bestScore) {
         bestScore = score;
         best = child;
       }
     }
     return best;
   }
   ```

2. Ensure RAVE values match perspective - raveValue should be from current player's perspective.
   If the move was made by opponent, flip the value.

3. Remove any debug console.log statements added in Task 2.
  </action>
  <verify>`cd packages/ai && pnpm build && pnpm test`</verify>
  <done>selectChild uses RAVE-UCT blend, build and tests pass</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm build` succeeds in packages/ai
- [ ] `pnpm test` passes in packages/ai
- [ ] Run benchmark: `cd packages/ai-trainer && pnpm benchmark --game go-fish --iterations 50 --games 20`
- [ ] Verify RAVE improves or maintains AI performance
</verification>

<success_criteria>

- RAVE data structures added to types.ts
- RAVE table populated during MCTS search
- UCT selection blends with RAVE values
- All existing tests pass
- Benchmark shows no regression (ideally improvement)
</success_criteria>

<output>
After completion, create `.planning/phases/33-rave/33-01-SUMMARY.md`:

# Phase 33 Plan 01: RAVE Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Task Commits

1. **Task 1:** [commit hash and message]
2. **Task 2:** [commit hash and message]
3. **Task 3:** [commit hash and message]

## Files Created/Modified

- `packages/ai/src/types.ts` - Added useRAVE, raveK config options
- `packages/ai/src/mcts-bot.ts` - RAVE table, playout tracking, UCT-RAVE selection

## Benchmark Results

- [Before/after comparison if applicable]

## Issues Encountered

[Any problems and how they were resolved]

## Next Phase Readiness

Ready for Phase 34: Gradient Objectives
</output>
