---
phase: 35-dynamic-uct
plan: 01
type: execute
---

<objective>
Adjust UCT exploration constant based on game phase to improve MCTS play quality.

Purpose: The UCT constant C controls exploration vs exploitation tradeoff. Different game phases benefit from different C values:
- Early game: Higher C (more exploration) to discover diverse strategies
- Late game: Lower C (more exploitation) to focus on winning lines

Output: Configurable UCT constant with Hex-specific phase-based tuning.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (RAVE and gradient objectives)
@.planning/phases/33-rave/33-01-SUMMARY.md
@.planning/phases/34-gradient-objectives/34-01-SUMMARY.md

# Key source files
@packages/ai/src/types.ts
@packages/ai/src/mcts-bot.ts
@packages/games/hex/rules/src/ai.ts

**Tech stack available:** MCTS with RAVE, gradient objectives, threat response
**Established patterns:** AIConfig hooks (objectives, threatResponseMoves, playoutPolicy, moveOrdering)
**Constraining decisions:**
- Phase 33: RAVE uses beta decay formula for blending with UCT
- Phase 34: Gradient objectives enable finer-grained evaluation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UCT configuration to types.ts</name>
  <files>packages/ai/src/types.ts</files>
  <action>
Add two new configuration options:

1. In BotConfig interface, add:
   - `uctC?: number` - Static UCT exploration constant override (default: sqrt(2) â‰ˆ 1.41)

2. In AIConfig interface, add:
   - `uctConstant?: (game: Game, playerIndex: number) => number` - Dynamic UCT constant based on game state

Add JSDoc explaining:
- Default value is Math.sqrt(2), theoretically optimal for minimax
- Higher values favor exploration, lower values favor exploitation
- Hook is evaluated once per move selection (not per tree node for performance)
- Typical range: 0.5 (very exploitative) to 2.0 (very explorative)
  </action>
  <verify>TypeScript compiles without errors: `cd packages/ai && pnpm build`</verify>
  <done>BotConfig has uctC option, AIConfig has uctConstant hook, both with JSDoc</done>
</task>

<task type="auto">
  <name>Task 2: Update MCTS selectChild() to use configurable C</name>
  <files>packages/ai/src/mcts-bot.ts</files>
  <action>
Modify selectChild() method to use configurable UCT constant:

1. Replace hardcoded `const C = Math.sqrt(2)` with:
   - Check if AIConfig.uctConstant hook exists, call it with (this.game, this.playerIndex)
   - Else use this.config.uctC if provided
   - Else default to Math.sqrt(2)

2. Cache the C value calculation at the start of playSingle() (once per move, not per selectChild call):
   - Add a private field `private cachedUctC: number = Math.sqrt(2)`
   - In playSingle(), before the MCTS loop, compute and cache:
     `this.cachedUctC = this.uctConstant?.(this.game, this.playerIndex) ?? this.config.uctC ?? Math.sqrt(2)`
   - In selectChild(), use `this.cachedUctC` instead of local C constant

3. Add uctConstant to the MCTSBot constructor parameters and store it alongside other AIConfig hooks

Note: Caching is important because selectChild() is called O(iterations) times and the hook should not recompute on each call.
  </action>
  <verify>
Run existing AI tests: `cd packages/ai && pnpm test`
Verify Hex AI still works: `cd packages/games/hex && pnpm test`
  </verify>
  <done>
- selectChild() uses cached UCT constant
- Default behavior unchanged (sqrt(2))
- AIConfig.uctConstant hook integrated
- BotConfig.uctC static override works
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement phase-based UCT for Hex</name>
  <files>packages/games/hex/rules/src/ai.ts</files>
  <action>
Add uctConstant hook to Hex AI configuration:

1. Define phase-based UCT constant function:
   ```typescript
   uctConstant: (game: HexGame, playerIndex: number) => {
     // Calculate game progress (0 = start, 1 = full board)
     const totalCells = game.board.all(HexCell).length;
     const filledCells = game.board.all(HexCell, { owner: (o: any) => o !== undefined }).length;
     const progress = filledCells / totalCells;

     // Early game (0-30%): High exploration C=1.8
     // Mid game (30-70%): Standard C=1.41
     // Late game (70%+): Exploitation C=1.0
     if (progress < 0.3) return 1.8;
     if (progress < 0.7) return Math.sqrt(2);
     return 1.0;
   }
   ```

2. Export the hook as part of hexAI configuration

3. Run benchmark comparison:
   - 40 AI vs AI games with standard C (for comparison)
   - 40 AI vs AI games with phase-based C
   - Compare P1 win rates, game lengths, and move times
   - Document results in SUMMARY.md

Design rationale:
- 1.8 early: Explore widely when many options matter
- sqrt(2) mid: Standard balanced play
- 1.0 late: Focus on forcing sequences when game is decided
  </action>
  <verify>
Benchmark command: `cd packages/ai-trainer && pnpm ts-node scripts/test-benchmark.ts --games 40`
Game tests pass: `cd packages/games/hex && pnpm test`
  </verify>
  <done>
- Hex AI has phase-based uctConstant hook
- Benchmark results show comparable or improved play
- No regression in game length or move times
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm build` succeeds across all packages
- [ ] `pnpm test` passes in packages/ai
- [ ] `pnpm test` passes in packages/games/hex
- [ ] Benchmark shows no regression in AI quality
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- UCT constant is configurable via both static config and dynamic hook
- Hex AI uses phase-based UCT constant
- Benchmark documents results (improvement not required, regression would warrant investigation)
</success_criteria>

<output>
After completion, create `.planning/phases/35-dynamic-uct/35-01-SUMMARY.md`:

# Phase 35 Plan 01: Dynamic UCT Summary

**[Substantive one-liner about what was achieved]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `packages/ai/src/types.ts` - Description
- `packages/ai/src/mcts-bot.ts` - Description
- `packages/games/hex/rules/src/ai.ts` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Benchmark Results

[AI vs AI comparison with and without phase-based UCT]

## Next Phase Readiness

Ready for Phase 36: Proof Number Search
</output>
