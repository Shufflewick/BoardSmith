---
phase: 37-pack-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/commands/pack.ts
  - packages/cli/src/cli.ts
autonomous: true

must_haves:
  truths:
    - "User can run `boardsmith pack` from monorepo root"
    - "Command discovers all public packages (no private: true)"
    - "Each package is packed with npm pack"
    - "Tarballs have timestamp-based versions (e.g., 1.0.0-20260118123456)"
    - "All tarballs are collected in output directory"
  artifacts:
    - path: "packages/cli/src/commands/pack.ts"
      provides: "Pack command implementation"
      exports: ["packCommand"]
    - path: "packages/cli/src/cli.ts"
      provides: "CLI entry point with pack command registered"
      contains: "packCommand"
  key_links:
    - from: "packages/cli/src/cli.ts"
      to: "packages/cli/src/commands/pack.ts"
      via: "import and program.command('pack')"
      pattern: "import.*packCommand.*from.*pack"
---

<objective>
Create `boardsmith pack` command that produces tarballs of all public packages with timestamp-based versions.

Purpose: Enable parallel development of BoardSmith and consumer games by creating immutable tarball snapshots that can be installed locally.

Output: Working `boardsmith pack` command that discovers packages, applies timestamp versions, runs npm pack, and collects tarballs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Existing CLI patterns
@packages/cli/src/cli.ts
@packages/cli/src/commands/build.ts
@packages/cli/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pack command implementation</name>
  <files>packages/cli/src/commands/pack.ts</files>
  <action>
Create `packages/cli/src/commands/pack.ts` with:

1. **Interface:**
```typescript
interface PackOptions {
  outDir?: string;  // Default: '.boardsmith/tarballs'
}
```

2. **discoverPackages()** function:
   - Read `packages/` directory recursively (depth 1 for most, depth 2 for games)
   - For each package.json found:
     - Parse JSON
     - Skip if `private: true`
     - Return array of `{ name, path, version }` objects
   - Use existing workspace patterns: `packages/*` and `packages/games/*`

3. **generateTimestampVersion()** function:
   - Takes base version (e.g., "0.0.1")
   - Returns version with timestamp: `${baseVersion}-${YYYYMMDDHHMMSS}`
   - Format: `1.0.0-20260118123456`

4. **packPackage()** function:
   - Takes package path and output directory
   - Read package.json, store original version
   - Write modified package.json with timestamp version
   - Run `npm pack` in package directory using child_process.execSync
   - Restore original package.json (use try/finally to ensure restoration)
   - Move generated .tgz to output directory
   - Return tarball filename

5. **packCommand()** export:
   - Validate running from monorepo root (check for root package.json with `"private": true` and workspaces)
   - Create output directory with `mkdirSync({ recursive: true })`
   - Discover all public packages
   - Show progress with ora spinner
   - Pack each package, collect results
   - Print summary: packages packed, output location, next steps

Use chalk for colored output. Use ora for spinners (follow build.ts pattern).
Handle errors with actionable messages (e.g., "npm pack failed for @boardsmith/engine: <error>").
  </action>
  <verify>
File exists at packages/cli/src/commands/pack.ts with:
- `packCommand` function exported
- Uses child_process for npm pack
- Handles timestamp versioning with restore
- Creates output directory
  </verify>
  <done>
pack.ts contains complete implementation for discovering packages, versioning, packing, and collecting tarballs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire pack command into CLI</name>
  <files>packages/cli/src/cli.ts</files>
  <action>
Update `packages/cli/src/cli.ts`:

1. Add import at top with other command imports:
```typescript
import { packCommand } from './commands/pack.js';
```

2. Add pack command registration after the build command (around line 56):
```typescript
// Packing for local development
program
  .command('pack')
  .description('Create tarballs of all public packages for local installation')
  .option('-o, --out-dir <dir>', 'Output directory for tarballs', '.boardsmith/tarballs')
  .action(packCommand);
```

3. Build the CLI to verify TypeScript compiles:
```bash
cd packages/cli && npm run build
```

4. Test the command exists:
```bash
./packages/cli/dist/cli.js pack --help
```
  </action>
  <verify>
```bash
cd /Users/jtsmith/board_game_service/BoardSmith && ./packages/cli/dist/cli.js pack --help
```
Shows pack command with --out-dir option.
  </verify>
  <done>
`boardsmith pack --help` displays command description and options. CLI compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Build CLI: `cd packages/cli && npm run build`
2. Run pack: `./packages/cli/dist/cli.js pack`
3. Verify output:
   - Tarballs appear in `.boardsmith/tarballs/`
   - Filenames contain timestamp version (e.g., `boardsmith-engine-0.0.1-20260118123456.tgz`)
   - All public packages are packed (engine, runtime, session, ai, client, testing, eslint-plugin, ui, worker, cli, server, ai-trainer)
   - Package.json files are restored to original versions
</verification>

<success_criteria>
- [ ] CLI-01: `boardsmith pack` command exists and runs
- [ ] CLI-02: All public packages discovered (no private: true packages)
- [ ] CLI-03: `npm pack` runs on each package
- [ ] CLI-04: Tarballs have timestamp versions (e.g., 1.0.0-20260118123456)
- [ ] CLI-05: All tarballs collected in output directory
</success_criteria>

<output>
After completion, create `.planning/phases/37-pack-command/37-01-SUMMARY.md`
</output>
