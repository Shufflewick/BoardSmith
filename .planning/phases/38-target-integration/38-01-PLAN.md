---
phase: 38-target-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/commands/pack.ts
  - packages/cli/src/cli.ts
autonomous: true

must_haves:
  truths:
    - "User can specify --target flag with path to consumer project"
    - "Tarballs are copied to target's vendor/ directory"
    - "Target's package.json has file: dependencies for all BoardSmith packages"
    - "npm install succeeds in target after pack completes"
  artifacts:
    - path: "packages/cli/src/commands/pack.ts"
      provides: "Target integration logic"
      contains: "--target"
    - path: "packages/cli/src/cli.ts"
      provides: "CLI flag registration"
      contains: "--target"
  key_links:
    - from: "packages/cli/src/cli.ts"
      to: "packages/cli/src/commands/pack.ts"
      via: "packCommand receives target option"
      pattern: "target.*<path>"
    - from: "packages/cli/src/commands/pack.ts"
      to: "target/package.json"
      via: "updates dependencies with file: protocol"
      pattern: "file:./vendor/"
---

<objective>
Add `--target` flag to `boardsmith pack` that copies tarballs to a consumer project and updates its package.json with file: dependencies.

Purpose: Enable seamless local BoardSmith development workflow where running `boardsmith pack --target /path/to/game` automatically installs the latest BoardSmith packages into the consumer project.

Output: Extended pack command with target integration (TGT-01 through TGT-05).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-pack-command/37-01-SUMMARY.md

# Current implementation to extend
@packages/cli/src/commands/pack.ts
@packages/cli/src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --target flag and target integration logic</name>
  <files>packages/cli/src/commands/pack.ts, packages/cli/src/cli.ts</files>
  <action>
1. In cli.ts, add `--target <path>` option to pack command:
   ```typescript
   .option('-t, --target <path>', 'Copy tarballs to target project and update dependencies')
   ```

2. In pack.ts, extend PackOptions interface:
   ```typescript
   interface PackOptions {
     outDir?: string;
     target?: string;
   }
   ```

3. Add target integration function after packCommand that:
   a. Validates target path exists and has package.json (error with actionable message if not)
   b. Creates `vendor/` directory in target if missing (TGT-02)
   c. Copies all tarballs from output directory to target's vendor/ (TGT-03)
   d. Reads target's package.json, updates/adds dependencies and devDependencies:
      - For each packed package, if it exists in dependencies or devDependencies, update to `file:./vendor/{tarball}`
      - Preserve the dep type (dependencies vs devDependencies)
      - Write updated package.json with proper formatting (JSON.stringify with 2-space indent)
   e. Runs `npm install` in target directory (TGT-05)
   f. Prints summary of what was updated

4. Call target integration at end of packCommand if options.target is set

Implementation notes:
- Use chalk for colored output (already imported)
- Use ora for spinner during npm install (already imported)
- Use copyFileSync from node:fs for tarball copying (add to imports)
- Validate target has package.json before any modifications
- Only update packages that are already in the target's dependencies (don't add new ones)
- Print which dependencies were updated at the end
  </action>
  <verify>
Run `boardsmith pack --help` and verify --target option appears.
Build the CLI: `npm run build -w @boardsmith/cli`
  </verify>
  <done>
--target flag exists and pack command accepts target path option
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end target integration</name>
  <files>packages/cli/src/commands/pack.ts</files>
  <action>
1. Create a temporary test directory with minimal package.json:
   ```bash
   mkdir -p /tmp/test-target
   echo '{"name":"test","dependencies":{"@boardsmith/engine":"^1.0.0","@boardsmith/runtime":"^1.0.0"}}' > /tmp/test-target/package.json
   ```

2. Run `boardsmith pack --target /tmp/test-target` from BoardSmith root

3. Verify:
   - /tmp/test-target/vendor/ directory exists
   - /tmp/test-target/vendor/ contains tarballs
   - /tmp/test-target/package.json has file: dependencies
   - npm install completed (node_modules exists)

4. Clean up test directory

5. If any verification fails, fix the issue in pack.ts and re-verify.
  </action>
  <verify>
All verifications pass:
- vendor/ directory created
- tarballs copied
- package.json updated with file:./vendor/* paths
- npm install succeeded
  </verify>
  <done>
Target integration works end-to-end: tarballs copied, deps updated, npm install runs
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run `boardsmith pack --help` and confirm --target option documented
2. Run `boardsmith pack` (without --target) and confirm original behavior unchanged
3. Run `boardsmith pack --target /path/to/test` with a test project and confirm:
   - vendor/ directory created
   - tarballs copied
   - package.json dependencies updated to file:./vendor/*.tgz format
   - npm install ran successfully

Requirements coverage:
- TGT-01: --target flag exists and accepts path
- TGT-02: vendor/ directory created
- TGT-03: tarballs copied to vendor/
- TGT-04: package.json updated with file: deps
- TGT-05: npm install runs in target
</verification>

<success_criteria>
- `boardsmith pack --target /path/to/project` completes without error
- Target's vendor/ directory contains all BoardSmith tarballs
- Target's package.json dependencies point to file:./vendor/*.tgz
- `npm install` runs successfully in target after pack
- Original pack behavior (without --target) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/38-target-integration/38-01-SUMMARY.md`
</output>
