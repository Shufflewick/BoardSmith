---
phase: 40-source-collapse
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/eslint-plugin/**
  - src/client/**
  - src/server/**
  - src/ui/**
  - src/worker/**
  - src/cli/**
autonomous: true

must_haves:
  truths:
    - "ESLint plugin source files exist in src/eslint-plugin/"
    - "Client source files exist in src/client/"
    - "Server source files exist in src/server/"
    - "UI source files exist in src/ui/"
    - "Worker source file exists in src/worker/"
    - "CLI source files exist in src/cli/"
    - "Git history preserved for all moved files"
  artifacts:
    - path: "src/eslint-plugin/index.ts"
      provides: "ESLint plugin barrel export"
    - path: "src/client/index.ts"
      provides: "Client barrel export"
    - path: "src/server/index.ts"
      provides: "Server barrel export"
    - path: "src/ui/index.ts"
      provides: "UI barrel export"
    - path: "src/worker/index.ts"
      provides: "Worker barrel export"
    - path: "src/cli/cli.ts"
      provides: "CLI entry point"
  key_links:
    - from: "packages/ui/src/"
      to: "src/ui/"
      via: "git mv"
      pattern: "renamed.*ui"
---

<objective>
Move peripheral package sources (eslint-plugin, client, server, ui, worker, cli) to unified src/ directory structure.

Purpose: Complete source collapse by moving remaining packages to single-package structure.
Output: 95 source files moved from packages/*/src/ to src/*/, git history preserved.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-source-collapse/40-RESEARCH.md
@.planning/phases/39-foundation/39-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure and move peripheral packages</name>
  <files>
    src/eslint-plugin/**
    src/client/**
    src/server/**
    src/ui/**
    src/worker/**
    src/cli/**
  </files>
  <action>
Create target directories and move peripheral packages using git mv:

1. Create directories:
```bash
mkdir -p src/eslint-plugin src/client src/server src/ui src/worker src/cli
```

2. Move each package's src/ contents:
```bash
# ESLint Plugin (6 files) - has rules/ subdirectory
git mv packages/eslint-plugin/src/* src/eslint-plugin/

# Client (6 files)
git mv packages/client/src/* src/client/

# Server (9 files) - has stores/, handlers/ subdirectories
git mv packages/server/src/* src/server/

# UI (54 files) - has animation/, assets/, components/, composables/ subdirectories
# NOTE: Includes CSS files, MP3 audio, .d.ts type declarations
git mv packages/ui/src/* src/ui/

# Worker (1 file)
git mv packages/worker/src/* src/worker/

# CLI (19 files) - has commands/, lib/, slash-command/ subdirectories
# NOTE: Includes markdown templates in slash-command/
git mv packages/cli/src/* src/cli/
```

3. Handle empty directories if they exist (git mv will fail on empty dirs):
   - packages/cli/src/templates/ - skip if empty
   - packages/cli/src/utils/ - skip if empty

4. Verify each move shows as "renamed" not "deleted/new" in git status.

IMPORTANT:
- Use `git mv` not `cp`/`rm` to preserve history
- Do NOT move test files (packages/*/tests/) - that's Phase 41
- Do NOT move packages/ui/vite.config.ts - it's outside src/
- The ui package has non-TypeScript files (CSS, MP3, .d.ts) - they should move too
  </action>
  <verify>
```bash
# Should show 95 files total in these directories
find src/eslint-plugin src/client src/server src/ui src/worker src/cli -type f | wc -l

# Should show "renamed:" for all files, no "deleted:" or "new file:"
git status | grep -E "renamed:|deleted:|new file:" | head -20

# Verify non-TS files moved for ui package
ls src/ui/animation/*.css src/ui/assets/*.mp3 src/ui/assets/*.d.ts 2>/dev/null
```
  </verify>
  <done>
- src/eslint-plugin/ contains 6 files (including rules/ subdirectory)
- src/client/ contains 6 files
- src/server/ contains 9 files (including stores/, handlers/ subdirectories)
- src/ui/ contains 54 files (including animation/, assets/, components/, composables/ subdirectories)
- src/worker/ contains 1 file
- src/cli/ contains 19 files (including commands/, lib/, slash-command/ subdirectories)
- All files show as "renamed" in git status
- Non-TypeScript files (CSS, MP3, .d.ts, .md) moved correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Commit peripheral package moves</name>
  <files>None (git operation only)</files>
  <action>
Commit all peripheral package moves as a single atomic commit:

```bash
git add -A
git commit -m "refactor(40-02): move peripheral packages to src/

Move remaining package sources to unified src/ structure:
- eslint-plugin (6 files) -> src/eslint-plugin/
- client (6 files) -> src/client/
- server (9 files) -> src/server/
- ui (54 files) -> src/ui/
- worker (1 file) -> src/worker/
- cli (19 files) -> src/cli/

Total: 95 files moved, git history preserved.
Includes non-TS files: CSS animations, MP3 audio, .d.ts declarations, .md templates.
Imports not updated yet (Phase 43).

Requirements: SRC-02, SRC-04, SRC-06, SRC-09, SRC-10, SRC-12"
```
  </action>
  <verify>
```bash
# Commit should exist
git log --oneline -1

# Working tree should be clean
git status --porcelain | wc -l
```
  </verify>
  <done>
- Commit created with descriptive message
- Working tree is clean
- 95 files committed as renames
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete source collapse</name>
  <files>None (verification only)</files>
  <action>
Verify the entire source collapse is complete:

1. Count total files in src/:
```bash
find src -type f | wc -l
# Expected: 179 (84 from Plan 01 + 95 from Plan 02)
```

2. List all src/ subdirectories:
```bash
ls -la src/
# Should show all 12 directories: engine, runtime, ai, ai-trainer, testing, session,
# eslint-plugin, client, server, ui, worker, cli
```

3. Verify packages/*/src/ directories are empty or gone:
```bash
for pkg in engine runtime ai ai-trainer testing session eslint-plugin client server ui worker cli; do
  if ls packages/$pkg/src/*.ts 2>/dev/null; then
    echo "ERROR: $pkg still has files"
  fi
done
```

4. Verify git history preserved for a few key files:
```bash
git log --follow --oneline src/engine/index.ts | head -3
git log --follow --oneline src/ui/index.ts | head -3
```
  </action>
  <verify>
All verifications pass:
- 179 files in src/
- 12 subdirectories in src/
- No .ts files remaining in packages/*/src/
- Git history preserved
  </verify>
  <done>
- Source collapse complete: all 179 files moved to src/
- All 12 package directories exist under src/
- packages/*/src/ directories empty (only non-src files remain in packages/)
- Git history preserved for all files
- Ready for Phase 41 (Test Colocation)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Total file count:**
   ```bash
   find src -type f | wc -l
   # Expected: 179
   ```

2. **All 12 directories present:**
   ```bash
   ls src/ | wc -l
   # Expected: 12
   ```

3. **Specific file types present:**
   ```bash
   # TypeScript files
   find src -name "*.ts" | wc -l

   # Vue files
   find src -name "*.vue" | wc -l

   # CSS files
   find src -name "*.css" | wc -l

   # Markdown templates
   find src -name "*.md" | wc -l
   ```

4. **Requirements coverage:**
   - SRC-02: src/ui/ has Vue components
   - SRC-04: src/cli/ has CLI commands
   - SRC-06: src/eslint-plugin/ has ESLint rules
   - SRC-09: src/client/ has client runtime
   - SRC-10: src/server/ has server runtime
   - SRC-12: src/worker/ has web worker
</verification>

<success_criteria>
- SRC-02 satisfied: src/ui/ contains Vue components (54 files)
- SRC-04 satisfied: src/cli/ contains CLI commands (19 files)
- SRC-06 satisfied: src/eslint-plugin/ contains ESLint rules (6 files)
- SRC-09 satisfied: src/client/ contains client runtime (6 files)
- SRC-10 satisfied: src/server/ contains server runtime (9 files)
- SRC-12 satisfied: src/worker/ contains web worker (1 file)
- All 179 files now in src/ (combined with Plan 01)
- All 12 SRC requirements (SRC-01 through SRC-12) satisfied
- Git history preserved for all files
- Ready for Phase 41 (Test Colocation)
</success_criteria>

<output>
After completion, create `.planning/phases/40-source-collapse/40-02-SUMMARY.md`
</output>
