---
phase: 41-test-colocation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - src/engine/element/game-element.test.ts
  - src/engine/action/action.test.ts
  - src/engine/flow/engine.test.ts
  - src/engine/utils/dev-state.test.ts
  - src/engine/command/executor.test.ts
  - src/runtime/runner.test.ts
  - src/engine/utils/serializer.test.ts
  - src/engine/utils/snapshot.test.ts
  - src/ai/mcts-bot.test.ts
  - src/ai/mcts-cache.test.ts
  - src/ai/cribbage-bot.test.ts
  - src/ai-trainer/evolution.test.ts
  - src/ai-trainer/parallel-simulator.test.ts
  - src/ui/composables/useActionController.test.ts
  - src/ui/composables/useActionController.selections.test.ts
  - src/ui/composables/useActionController.helpers.ts
  - src/session/checkpoint-manager.test.ts
autonomous: true

must_haves:
  truths:
    - "All library tests are colocated next to their source files"
    - "Tests are visible as direct siblings to code (pit of success)"
    - "npm test runs all library tests successfully"
    - "Game tests remain in packages/games/ (deferred to Phase 44)"
  artifacts:
    - path: "src/engine/element/game-element.test.ts"
      provides: "Element tests colocated"
    - path: "src/engine/action/action.test.ts"
      provides: "Action tests colocated"
    - path: "src/engine/flow/engine.test.ts"
      provides: "Flow tests colocated"
    - path: "src/ai/mcts-bot.test.ts"
      provides: "MCTS bot tests colocated"
    - path: "src/ui/composables/useActionController.test.ts"
      provides: "UI composable tests colocated"
    - path: "vitest.config.ts"
      provides: "Updated test pattern for src/**/*.test.ts"
      contains: "src/**/*.test.ts"
  key_links:
    - from: "vitest.config.ts"
      to: "src/**/*.test.ts"
      via: "include pattern"
      pattern: "src/\\*\\*/\\*.test.ts"
    - from: "src/engine/element/game-element.test.ts"
      to: "src/engine/index.ts"
      via: "import"
      pattern: "from.*['\"]\\.\\.?/.*index"
---

<objective>
Move all library tests from packages/*/tests/ to be colocated as direct siblings of source files in src/.

Purpose: Requirement SRC-13 - tests live next to code they test. Pit of success: obvious where tests are, obvious where new tests go.
Output: 14 test files + 1 helper moved to src/, vitest config updated, all tests passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-test-colocation/41-CONTEXT.md
@.planning/phases/41-test-colocation/41-RESEARCH.md
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update vitest configuration for colocated tests</name>
  <files>vitest.config.ts</files>
  <action>
Update vitest.config.ts to include the new colocated test pattern:

```typescript
export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: [
      'src/**/*.test.ts',                      // Colocated library tests (new)
      'packages/games/**/tests/**/*.test.ts',  // Game tests (until Phase 44)
    ],
  },
});
```

This adds the new pattern AND keeps game tests discoverable. The old `packages/**/tests/**/*.test.ts` pattern is removed since only game tests remain in packages/.
  </action>
  <verify>Run `npm test -- --run` (or `npx vitest run`) - tests should still pass (same files, found via old pattern until moved)</verify>
  <done>vitest.config.ts updated with src/**/*.test.ts pattern, tests still run</done>
</task>

<task type="auto">
  <name>Task 2: Move library test files with git mv and update imports</name>
  <files>
    src/engine/element/game-element.test.ts
    src/engine/action/action.test.ts
    src/engine/flow/engine.test.ts
    src/engine/utils/dev-state.test.ts
    src/engine/command/executor.test.ts
    src/runtime/runner.test.ts
    src/engine/utils/serializer.test.ts
    src/engine/utils/snapshot.test.ts
    src/ai/mcts-bot.test.ts
    src/ai/mcts-cache.test.ts
    src/ai/cribbage-bot.test.ts
    src/ai-trainer/evolution.test.ts
    src/ai-trainer/parallel-simulator.test.ts
    src/ui/composables/useActionController.test.ts
    src/ui/composables/useActionController.selections.test.ts
    src/ui/composables/useActionController.helpers.ts
    src/session/checkpoint-manager.test.ts
  </files>
  <action>
Move each test file using `git mv` to preserve history. After moving, update imports from `../src/index.js` to relative sibling paths.

**Move commands (14 tests + 1 helper):**

Engine tests (5):
- `git mv packages/engine/tests/element.test.ts src/engine/element/game-element.test.ts`
- `git mv packages/engine/tests/action.test.ts src/engine/action/action.test.ts`
- `git mv packages/engine/tests/flow.test.ts src/engine/flow/engine.test.ts`
- `git mv packages/engine/tests/dev-state.test.ts src/engine/utils/dev-state.test.ts`
- `git mv packages/engine/tests/command-undo.test.ts src/engine/command/executor.test.ts`

Runtime tests (3):
- `git mv packages/runtime/tests/runner.test.ts src/runtime/runner.test.ts`
- `git mv packages/runtime/tests/serializer.test.ts src/engine/utils/serializer.test.ts`
- `git mv packages/runtime/tests/snapshot.test.ts src/engine/utils/snapshot.test.ts`

AI tests (3):
- `git mv packages/ai/tests/mcts-bot.test.ts src/ai/mcts-bot.test.ts`
- `git mv packages/ai/tests/mcts-cache.test.ts src/ai/mcts-cache.test.ts`
- `git mv packages/ai/tests/cribbage-bot.test.ts src/ai/cribbage-bot.test.ts`

AI-trainer tests (2):
- `git mv packages/ai-trainer/tests/evolution.test.ts src/ai-trainer/evolution.test.ts`
- `git mv packages/ai-trainer/tests/parallel-simulator.test.ts src/ai-trainer/parallel-simulator.test.ts`

UI tests (2 + 1 helper):
- `git mv packages/ui/tests/useActionController.test.ts src/ui/composables/useActionController.test.ts`
- `git mv packages/ui/tests/useActionController.selections.test.ts src/ui/composables/useActionController.selections.test.ts`
- `git mv packages/ui/tests/useActionController.helpers.ts src/ui/composables/useActionController.helpers.ts`

Session test (1):
- `git mv packages/session/tests/checkpoint-manager.test.ts src/session/checkpoint-manager.test.ts`

**Import updates after move:**

Each test file currently imports from `../src/index.js`. Update to relative sibling paths:

| Test Location | Old Import | New Import |
|---------------|------------|------------|
| src/engine/element/game-element.test.ts | `../src/index.js` | `../index.js` |
| src/engine/action/action.test.ts | `../src/index.js` | `../index.js` |
| src/engine/flow/engine.test.ts | `../src/index.js` | `../index.js` |
| src/engine/utils/dev-state.test.ts | `../src/index.js` | `../../index.js` |
| src/engine/command/executor.test.ts | `../src/index.js` | `../index.js` |
| src/runtime/runner.test.ts | `../src/index.js` | `./index.js` |
| src/engine/utils/serializer.test.ts | imports from runtime and engine | update both |
| src/engine/utils/snapshot.test.ts | imports from runtime and engine | update both |
| src/ai/*.test.ts | `../src/index.js` | `./index.js` |
| src/ai-trainer/*.test.ts | check imports | update to relative |
| src/ui/composables/*.test.ts | `../src/index.js` | `../index.js` |
| src/session/checkpoint-manager.test.ts | `../src/index.js` | `./index.js` |

The helper file `useActionController.helpers.ts` may have internal imports that also need updating.

**Important:** Read each test file before moving to understand its exact imports, then update them after the move.
  </action>
  <verify>Run `npx tsc --noEmit` - no TypeScript errors. Run `npm test -- --run` - all tests pass</verify>
  <done>All 14 test files + 1 helper moved to src/, all imports updated, TypeScript compiles, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Clean up empty directories and verify</name>
  <files>packages/engine/tests/, packages/runtime/tests/, packages/ai/tests/, packages/ai-trainer/tests/, packages/ui/tests/, packages/session/tests/</files>
  <action>
1. Remove empty test directories that no longer contain files:
   - `rmdir packages/engine/tests` (should be empty)
   - `rmdir packages/runtime/tests` (should be empty)
   - `rmdir packages/ai/tests` (should be empty)
   - `rmdir packages/ai-trainer/tests` (should be empty)
   - `rmdir packages/ui/tests` (should be empty)
   - `rmdir packages/session/tests` (should be empty)

2. Verify game test directories still exist with their tests:
   - `packages/games/*/tests/` directories should still have their game.test.ts files

3. Run full test suite to verify everything works:
   - `npm test -- --run`

4. Verify test count matches expectations:
   - Library tests: 14 tests in src/
   - Game tests: 10 tests in packages/games/
   - Total: 24 test files discovered
  </action>
  <verify>
- `ls packages/engine/tests 2>/dev/null || echo "Cleaned"` shows "Cleaned"
- `ls packages/games/hex/tests/game.test.ts` shows game tests still exist
- `npm test -- --run` passes all tests
  </verify>
  <done>Empty test directories removed, game tests preserved in packages/games/, full test suite passes</done>
</task>

</tasks>

<verification>
1. All library test files are in src/ as siblings to source files
2. No test files remain in packages/*/tests/ (except packages/games/)
3. vitest.config.ts includes src/**/*.test.ts pattern
4. All tests pass: `npm test -- --run`
5. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- 14 library test files colocated in src/
- 1 helper file moved with tests
- All imports updated to relative paths
- vitest discovers all tests (library + game)
- Full test suite passes
- Requirement SRC-13 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/41-test-colocation/41-01-SUMMARY.md`
</output>
