---
phase: 43-import-rewrite
plan: 02
type: execute
wave: 2
depends_on: [43-01]
files_modified:
  - src/server/types.ts
  - src/server/core.ts
  - src/server/handlers/games.ts
  - src/server/stores/in-memory-games.ts
  - src/server/stores/sqlite-games.ts
  - src/server/stores/sqlite-storage.ts
  - src/ui/index.ts
  - src/ui/types.ts
  - src/ui/components/GameShell.vue
  - src/ui/composables/useActionAnimations.ts
  - src/ui/composables/useActionController.ts
  - src/ui/composables/useAutoAnimations.ts
  - src/ui/composables/useAutoFLIP.ts
  - src/ui/composables/useAutoFlyToStat.ts
  - src/ui/composables/useCardDisplay.ts
  - src/ui/composables/useDragDrop.ts
  - src/ui/composables/useElementChangeTracker.ts
  - src/ui/composables/useFLIPAnimation.ts
  - src/ui/composables/useGameGrid.ts
  - src/ui/composables/useHexGrid.ts
  - src/ui/composables/usePlayerStatAnimation.ts
  - src/worker/index.ts
  - src/client/index.ts
  - src/client/vue.ts
  - src/cli/local-server.ts
  - src/cli/commands/train-ai.ts
  - src/cli/commands/evolve-ai-weights.ts
  - vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "All @boardsmith/* imports in src/ use relative paths (except templates/docs)"
    - "Vitest config only has aliases for game packages (checkers, cribbage, go-fish)"
    - "TypeScript compilation succeeds with 0 errors"
    - "All tests pass"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Game package aliases only"
      contains: "@boardsmith/checkers-rules"
    - path: "src/ui/index.ts"
      provides: "Relative import to session"
      contains: "../session/index.js"
    - path: "src/worker/index.ts"
      provides: "Relative imports to session, engine, server"
      contains: "../session/index.js"
  key_links:
    - from: "src/ui/components/GameShell.vue"
      to: "../client/index.js"
      via: "relative import"
      pattern: "from ['\"]\\.\\./"
    - from: "vitest.config.ts"
      to: "packages/games/"
      via: "alias config"
      pattern: "@boardsmith/.*-rules"
---

<objective>
Rewrite peripheral layer imports and update vitest config

Purpose: Complete Phase 43 by rewriting imports in server, ui, worker, client, and cli modules, then update vitest.config.ts to remove internal package aliases. After this plan, all internal @boardsmith/* imports will use relative paths.

Output: 28 files with rewritten imports, updated vitest config with only game package aliases, passing tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-import-rewrite/43-RESEARCH.md
@.planning/phases/43-import-rewrite/43-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite server, worker, client, and cli imports</name>
  <files>
    src/server/types.ts
    src/server/core.ts
    src/server/handlers/games.ts
    src/server/stores/in-memory-games.ts
    src/server/stores/sqlite-games.ts
    src/server/stores/sqlite-storage.ts
    src/worker/index.ts
    src/client/index.ts
    src/client/vue.ts
    src/cli/local-server.ts
    src/cli/commands/train-ai.ts
    src/cli/commands/evolve-ai-weights.ts
  </files>
  <action>
    Rewrite all `@boardsmith/*` imports to relative paths in server, worker, client, and cli modules.

    **Mapping:**
    - `@boardsmith/engine` -> `../engine/index.js` (or `../../engine/index.js` for nested files)
    - `@boardsmith/runtime` -> `../runtime/index.js`
    - `@boardsmith/ai` -> `../ai/index.js`
    - `@boardsmith/ai-trainer` -> `../ai-trainer/index.js`
    - `@boardsmith/session` -> `../session/index.js`
    - `@boardsmith/server` -> `../server/index.js`

    **Rules:**
    1. All relative imports MUST end in `.js` (ESM requirement)
    2. For files in subdirectories (e.g., src/server/stores/), add extra `../` prefix
    3. SKIP template files: src/cli/commands/init.ts, src/cli/lib/project-scaffold.ts, src/cli/slash-command/generate-ai-instructions.md
    4. Preserve `import type` vs `import` distinction

    **src/server/ (7 occurrences in 6 files):**
    - types.ts: @boardsmith/session (2 imports)
    - core.ts: @boardsmith/session
    - handlers/games.ts: @boardsmith/session (path: ../../session/index.js)
    - stores/in-memory-games.ts: @boardsmith/session (path: ../../session/index.js)
    - stores/sqlite-games.ts: @boardsmith/session (path: ../../session/index.js)
    - stores/sqlite-storage.ts: @boardsmith/session (path: ../../session/index.js)

    **src/worker/ (5 occurrences in 1 file):**
    - index.ts: @boardsmith/session, @boardsmith/engine, @boardsmith/server

    **src/client/ (2 occurrences in 2 files):**
    - index.ts: @boardsmith/engine (1 import)
    - vue.ts: @boardsmith/engine (1 import)

    **src/cli/ (4 occurrences in 3 files - skip templates):**
    - local-server.ts: @boardsmith/server
    - commands/train-ai.ts: @boardsmith/engine, @boardsmith/ai-trainer (path: ../../engine/index.js)
    - commands/evolve-ai-weights.ts: @boardsmith/ai-trainer (path: ../../ai-trainer/index.js)
  </action>
  <verify>
    Run `npx tsc --noEmit` - should complete without errors.
    Run `grep -r "from '@boardsmith/" src/server src/worker src/client src/cli | grep -v init.ts | grep -v project-scaffold | grep -v generate-ai-instructions` - should return empty.
  </verify>
  <done>
    All 12 server/worker/client/cli files (excluding templates) use relative imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite UI imports</name>
  <files>
    src/ui/index.ts
    src/ui/types.ts
    src/ui/components/GameShell.vue
    src/ui/composables/useActionAnimations.ts
    src/ui/composables/useActionController.ts
    src/ui/composables/useAutoAnimations.ts
    src/ui/composables/useAutoFLIP.ts
    src/ui/composables/useAutoFlyToStat.ts
    src/ui/composables/useCardDisplay.ts
    src/ui/composables/useDragDrop.ts
    src/ui/composables/useElementChangeTracker.ts
    src/ui/composables/useFLIPAnimation.ts
    src/ui/composables/useGameGrid.ts
    src/ui/composables/useHexGrid.ts
    src/ui/composables/usePlayerStatAnimation.ts
  </files>
  <action>
    Rewrite all `@boardsmith/*` imports to relative paths in the UI module.

    **Mapping:**
    - `@boardsmith/session` -> `../session/index.js` (for src/ui/*.ts files)
    - `@boardsmith/session` -> `../../session/index.js` (for src/ui/composables/*.ts files)
    - `@boardsmith/client` -> `../client/index.js` (for src/ui/*.ts files)
    - `@boardsmith/client` -> `../../client/index.js` (for src/ui/composables/*.ts files)
    - `@boardsmith/client/vue` -> `../../client/vue.js` (for src/ui/components/*.vue files)
    - `@boardsmith/engine` -> `../../engine/index.js` (for nested files)

    **Rules:**
    1. All relative imports MUST end in `.js` (ESM requirement)
    2. For files in subdirectories (composables/, components/), add extra `../` prefix
    3. Preserve `import type` vs `import` distinction

    **src/ui/ (17 occurrences in 15 files):**
    - index.ts: @boardsmith/session (1 re-export)
    - types.ts: @boardsmith/session (1 import)
    - components/GameShell.vue: @boardsmith/client, @boardsmith/client/vue (2 imports)
    - composables/ (13 files): various @boardsmith/session imports

    **Special case - GameShell.vue:**
    ```vue
    // BEFORE
    import { MeepleClient, GameConnection } from '@boardsmith/client';
    import { useGame } from '@boardsmith/client/vue';

    // AFTER
    import { MeepleClient, GameConnection } from '../../client/index.js';
    import { useGame } from '../../client/vue.js';
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` - should complete without errors.
    Run `grep -r "from '@boardsmith/" src/ui` - should return empty.
  </verify>
  <done>
    All 15 UI files use relative imports. No @boardsmith/* imports remain in src/ui/.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update vitest config and verify everything</name>
  <files>
    vitest.config.ts
  </files>
  <action>
    Update vitest.config.ts to remove internal package aliases (they're now using relative imports), keeping only game package aliases.

    **BEFORE:**
    ```typescript
    resolve: {
      alias: {
        // Workspace package aliases for colocated tests in src/
        '@boardsmith/engine': resolve(__dirname, 'src/engine/index.ts'),
        '@boardsmith/runtime': resolve(__dirname, 'src/runtime/index.ts'),
        '@boardsmith/ai': resolve(__dirname, 'src/ai/index.ts'),
        '@boardsmith/ai-trainer': resolve(__dirname, 'src/ai-trainer/index.ts'),
        '@boardsmith/session': resolve(__dirname, 'src/session/index.ts'),
        '@boardsmith/ui': resolve(__dirname, 'src/ui/index.ts'),
        '@boardsmith/testing': resolve(__dirname, 'src/testing/index.ts'),
        // Game rules packages (still in packages/)
        '@boardsmith/checkers-rules': resolve(__dirname, 'packages/games/checkers/rules/src/index.ts'),
        '@boardsmith/cribbage-rules': resolve(__dirname, 'packages/games/cribbage/rules/src/index.ts'),
        '@boardsmith/go-fish-rules': resolve(__dirname, 'packages/games/go-fish/rules/src/index.ts'),
      },
    }
    ```

    **AFTER:**
    ```typescript
    resolve: {
      alias: {
        // Game rules packages (still in packages/ until Phase 44)
        '@boardsmith/checkers-rules': resolve(__dirname, 'packages/games/checkers/rules/src/index.ts'),
        '@boardsmith/cribbage-rules': resolve(__dirname, 'packages/games/cribbage/rules/src/index.ts'),
        '@boardsmith/go-fish-rules': resolve(__dirname, 'packages/games/go-fish/rules/src/index.ts'),
      },
    }
    ```

    Remove the 7 internal package aliases (@boardsmith/engine, runtime, ai, ai-trainer, session, ui, testing). Keep the 3 game package aliases.
  </action>
  <verify>
    1. Run TypeScript compilation:
       ```bash
       npx tsc --noEmit
       ```
       Must complete with 0 errors.

    2. Run all tests:
       ```bash
       npm test
       ```
       All tests must pass.

    3. Verify no internal @boardsmith/* imports remain:
       ```bash
       grep -r "from '@boardsmith/" src/ | grep -v init.ts | grep -v project-scaffold | grep -v generate-ai-instructions | grep -v code-generator | grep -v ".md:" | grep -v "helpers.ts"
       ```
       Should only show test files importing game packages (@boardsmith/checkers-rules, etc.)

    4. Verify vitest config has only game aliases:
       ```bash
       grep "@boardsmith" vitest.config.ts
       ```
       Should show only checkers-rules, cribbage-rules, go-fish-rules.
  </verify>
  <done>
    - vitest.config.ts has only 3 game package aliases
    - TypeScript compiles with 0 errors
    - All tests pass
    - No internal @boardsmith/* imports remain in src/ (excluding templates/docs/code-generator)
  </done>
</task>

</tasks>

<verification>
**Final Phase 43 Verification:**

1. **Requirements IMP-01, IMP-02, IMP-03 complete:**
   ```bash
   # Should return only:
   # - Game package imports in test files (@boardsmith/*-rules)
   # - Template/doc files that intentionally use @boardsmith/* for external consumers
   grep -rn "from '@boardsmith/" src/ | grep -v ".test.ts:.*-rules" | grep -v init.ts | grep -v project-scaffold | grep -v generate-ai-instructions | grep -v code-generator | grep -v ".md:" | grep -v "helpers.ts.*@example"
   ```
   Should return empty.

2. **TypeScript compilation:** `npx tsc --noEmit` - 0 errors

3. **All tests pass:** `npm test`

4. **Relative import format correct:**
   ```bash
   grep -r "../engine/index.js" src/ | wc -l
   ```
   Should show ~25+ occurrences with .js extension.
</verification>

<success_criteria>
- [ ] 27 peripheral layer files have @boardsmith/* imports rewritten to relative paths
- [ ] vitest.config.ts has only 3 game package aliases
- [ ] TypeScript compiles with 0 errors
- [ ] All tests pass
- [ ] Requirements IMP-01, IMP-02, IMP-03 verified complete
</success_criteria>

<output>
After completion, create `.planning/phases/43-import-rewrite/43-02-SUMMARY.md`
</output>
