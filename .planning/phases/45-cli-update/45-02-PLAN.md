---
phase: 45-cli-update
plan: 02
type: execute
wave: 2
depends_on: [45-01]
files_modified:
  - src/cli/commands/dev.ts
  - src/cli/commands/build.ts
  - src/cli/commands/pack.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "boardsmith dev works in standalone game projects"
    - "boardsmith build produces correct bundles in standalone projects"
    - "boardsmith test runs tests in standalone projects"
    - "boardsmith pack gives clear message when run in standalone projects"
    - "All CLI commands still work in monorepo context"
    - "CLI help output has no @boardsmith/* references"
  artifacts:
    - path: "src/cli/commands/dev.ts"
      provides: "Context-aware dev server"
      contains: "getProjectContext"
    - path: "src/cli/commands/build.ts"
      provides: "Build command with correct externals"
      contains: "boardsmith"
    - path: "src/cli/commands/pack.ts"
      provides: "Pack command with standalone detection"
      contains: "standalone"
  key_links:
    - from: "src/cli/commands/dev.ts"
      to: "boardsmith package"
      via: "import resolution"
      pattern: "boardsmith"
---

<objective>
Update CLI commands (dev, build, pack) to work with standalone game projects that use the `boardsmith` package.

Purpose: Existing commands assume monorepo context with `@boardsmith/*` packages. They need to detect context and behave appropriately for standalone games. This covers CLI-02, CLI-03, CLI-05, and CLI-06.

Note: test.ts (CLI-04) requires NO changes - it already works correctly with `npx vitest run` and has no `@boardsmith/*` references.

Output: Updated command files that work in both monorepo and standalone contexts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-cli-update/45-RESEARCH.md
@.planning/phases/45-cli-update/45-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dev.ts with context detection</name>
  <files>src/cli/commands/dev.ts</files>
  <action>
Update dev.ts to detect project context and handle standalone games correctly:

1. **Add context detection function** at the top of the file (after imports):
   ```typescript
   /**
    * Detect if we're running in the BoardSmith monorepo or a standalone game project.
    * - Monorepo: Has src/engine/ directory (collapsed structure)
    * - Standalone: Has boardsmith.json but no src/engine/
    */
   function getProjectContext(cwd: string): 'monorepo' | 'standalone' {
     const hasSrcEngine = existsSync(join(cwd, 'src', 'engine'));
     const hasBoardsmithJson = existsSync(join(cwd, 'boardsmith.json'));

     // If we're in the monorepo root, it has src/engine
     if (hasSrcEngine) return 'monorepo';

     // Standalone game project
     if (hasBoardsmithJson) return 'standalone';

     // Fallback - treat as standalone (will fail with proper error if neither)
     return 'standalone';
   }
   ```

2. **Update boardsmithResolvePlugin() to be context-aware**:
   - Make it return an empty plugin (noop) for standalone context
   - Only intercept `@boardsmith/*` imports in monorepo context
   - Add `context` parameter to the function

3. **Update boardsmithVitePlugin similarly**:
   - Make it context-aware - only resolve in monorepo context
   - For standalone games, don't intercept - let Vite resolve from node_modules

4. **Update devCommand()** to detect context and configure plugins:
   ```typescript
   const context = getProjectContext(cwd);

   // In standalone context, don't need custom resolution - node_modules handles it
   const esbuildPlugins = context === 'monorepo' ? [boardsmithResolvePlugin()] : [];
   const vitePlugins = context === 'monorepo' ? [boardsmithVitePlugin] : [];
   ```

5. **Update the esbuild call** in loadGameDefinition():
   - Pass plugins array that may be empty for standalone
   - Ensure it still works when no plugins are provided

6. **Update optimizeDeps.exclude** in Vite config:
   - Only exclude `@boardsmith/*` packages in monorepo context
   - For standalone, exclude `boardsmith` instead to pick up local changes during dev
  </action>
  <verify>
# After building, verify dev works in both contexts:
# 1. In monorepo root - should still work with internal resolution
# 2. In extracted game - should work with node_modules resolution
cd /Users/jtsmith/board_game_service/BoardSmith && npm run build
  </verify>
  <done>dev.ts detects context and only applies custom resolution plugins in monorepo context</done>
</task>

<task type="auto">
  <name>Task 2: Update build.ts for standalone projects</name>
  <files>src/cli/commands/build.ts</files>
  <action>
Update build.ts to use correct external package names:

1. **Update rollupOptions.external** in the rules build:
   - Change from: `external: ['@boardsmith/engine']`
   - To: `external: ['boardsmith', /^boardsmith\//]`
   - This marks `boardsmith` and all subpath exports (boardsmith/ui, boardsmith/ai, etc.) as external

2. **Add context detection** (same pattern as dev.ts):
   - Import existsSync from 'node:fs'
   - Add getProjectContext function
   - Detect context at start of buildCommand

3. **For monorepo context** (building BoardSmith itself):
   - Keep current behavior or skip rules build (library doesn't have rules)
   - Actually, when building from monorepo root, this command shouldn't be used - it's for games

4. **Add helpful error message** if run from wrong context:
   ```typescript
   const context = getProjectContext(cwd);
   if (context === 'monorepo') {
     console.error(chalk.red('Error: boardsmith build is for game projects, not the BoardSmith library'));
     console.error(chalk.dim('To build BoardSmith itself, use: npm run build'));
     process.exit(1);
   }
   ```

This ensures `boardsmith build` is only run in game project context where it makes sense.
  </action>
  <verify>
grep "boardsmith" src/cli/commands/build.ts | head -5
# Should show boardsmith in external array
  </verify>
  <done>build.ts marks 'boardsmith' as external and validates context</done>
</task>

<task type="auto">
  <name>Task 3: Update pack.ts for new single-package structure</name>
  <files>src/cli/commands/pack.ts</files>
  <action>
Update pack.ts to work with the new single-package structure:

1. **Add context detection** at start of packCommand:
   ```typescript
   function getProjectContext(cwd: string): 'monorepo' | 'standalone' {
     const hasSrcEngine = existsSync(join(cwd, 'src', 'engine'));
     const hasBoardsmithJson = existsSync(join(cwd, 'boardsmith.json'));
     if (hasSrcEngine) return 'monorepo';
     if (hasBoardsmithJson) return 'standalone';
     return 'standalone';
   }
   ```

2. **Update validateMonorepoRoot()** for new structure:
   - The monorepo no longer has `workspaces` array (it's a single package now)
   - Instead, check for `src/engine/` directory as the indicator
   - Update the function to:
     ```typescript
     function validateMonorepoRoot(cwd: string): void {
       const rootPkgJson = join(cwd, 'package.json');
       if (!existsSync(rootPkgJson)) {
         console.error(chalk.red('Error: package.json not found'));
         process.exit(1);
       }

       // Check for src/engine/ which indicates BoardSmith repo
       const srcEngine = join(cwd, 'src', 'engine');
       if (!existsSync(srcEngine)) {
         console.error(chalk.red('Error: This command must be run from the BoardSmith repository root'));
         console.error(chalk.dim('Current directory does not contain src/engine/'));
         process.exit(1);
       }
     }
     ```

3. **Simplify discoverPackages()** for single package:
   - The monorepo now has a single `boardsmith` package at root
   - Return just the root package info:
     ```typescript
     function discoverPackages(monorepoRoot: string): PackageInfo[] {
       const rootPkgJson = join(monorepoRoot, 'package.json');
       const pkgJson = JSON.parse(readFileSync(rootPkgJson, 'utf-8'));
       return [{
         name: pkgJson.name || 'boardsmith',
         path: monorepoRoot,
         version: pkgJson.version || '0.0.1',
       }];
     }
     ```

4. **Update isBoardSmithPackage()** to recognize the new package name:
   - Add check for `boardsmith` (the new single package name)
   - Keep `@boardsmith/*` check for backwards compatibility during transition

5. **Handle standalone context with clear error**:
   ```typescript
   if (getProjectContext(cwd) === 'standalone') {
     console.error(chalk.red('Error: boardsmith pack is for packaging the BoardSmith library itself'));
     console.error(chalk.dim('You are in a standalone game project.'));
     console.error(chalk.dim('Games depend on boardsmith from npm or a local file: link.'));
     process.exit(1);
   }
   ```
  </action>
  <verify>
grep -E "src/engine|standalone" src/cli/commands/pack.ts
# Should show context detection logic
  </verify>
  <done>pack.ts works with single-package structure and gives clear error for standalone projects</done>
</task>

<task type="auto">
  <name>Task 4: Test all commands and verify help text</name>
  <files></files>
  <action>
Build and test all updated commands, including CLI-06 verification:

1. **Build the CLI**:
   ```bash
   cd /Users/jtsmith/board_game_service/BoardSmith
   npm run build
   ```

2. **Verify CLI help text has no @boardsmith/* references** (CLI-06):
   ```bash
   # Check main help
   npx ./dist/cli/cli.js --help 2>&1 | grep -i "@boardsmith" && echo "FAIL: Found @boardsmith in help" || echo "PASS: No @boardsmith in main help"

   # Check subcommand help
   for cmd in init dev build test pack validate lint analyze; do
     npx ./dist/cli/cli.js $cmd --help 2>&1 | grep -i "@boardsmith" && echo "FAIL: Found @boardsmith in $cmd help" || true
   done
   echo "PASS: Help text verification complete"
   ```

3. **Test in standalone game context** (use extracted hex game):
   ```bash
   cd /private/tmp/boardsmith-test-target/hex

   # Test dev starts without errors (just check it starts, then Ctrl+C)
   timeout 5 npx /Users/jtsmith/board_game_service/BoardSmith/dist/cli/cli.js dev 2>&1 | head -20 || true

   # Test build
   npx /Users/jtsmith/board_game_service/BoardSmith/dist/cli/cli.js build
   ls -la dist/

   # Test test (if tests exist)
   npm test || echo "No tests or test failure (expected for some games)"
   ```

4. **Test pack error message in standalone context**:
   ```bash
   cd /private/tmp/boardsmith-test-target/hex
   npx /Users/jtsmith/board_game_service/BoardSmith/dist/cli/cli.js pack 2>&1 | grep -E "Error|standalone"
   # Should show error about being in standalone project
   ```

5. **Test in monorepo context**:
   ```bash
   cd /Users/jtsmith/board_game_service/BoardSmith

   # Test pack works from monorepo
   npx ./dist/cli/cli.js pack --out-dir /tmp/boardsmith-pack-test 2>&1 | head -20
   ls /tmp/boardsmith-pack-test/
   rm -rf /tmp/boardsmith-pack-test
   ```

6. **Clean up build artifacts**:
   ```bash
   rm -rf /private/tmp/boardsmith-test-target/hex/dist
   ```
  </action>
  <verify>
# Commands should work in appropriate contexts:
# - help: no @boardsmith/* references in any command help
# - dev: works in both contexts
# - build: works in standalone, error in monorepo
# - test: works in both contexts (no changes needed to test.ts)
# - pack: works in monorepo, clear error in standalone
  </verify>
  <done>All CLI commands work correctly in their appropriate contexts, and help text is clean of @boardsmith/* references</done>
</task>

</tasks>

<verification>
Comprehensive verification of all CLI commands:

```bash
# Build CLI
cd /Users/jtsmith/board_game_service/BoardSmith && npm run build

# CLI-06: Verify help text has no @boardsmith/* references
echo "=== Verifying CLI help text (CLI-06) ==="
npx ./dist/cli/cli.js --help 2>&1 | grep -i "@boardsmith" || echo "PASS: Main help clean"
npx ./dist/cli/cli.js dev --help 2>&1 | grep -i "@boardsmith" || echo "PASS: dev help clean"
npx ./dist/cli/cli.js build --help 2>&1 | grep -i "@boardsmith" || echo "PASS: build help clean"
npx ./dist/cli/cli.js test --help 2>&1 | grep -i "@boardsmith" || echo "PASS: test help clean"
npx ./dist/cli/cli.js pack --help 2>&1 | grep -i "@boardsmith" || echo "PASS: pack help clean"

# Test in standalone game (hex)
cd /private/tmp/boardsmith-test-target/hex

echo ""
echo "=== Testing dev (5 second timeout) ==="
timeout 5 npx /Users/jtsmith/board_game_service/BoardSmith/dist/cli/cli.js dev 2>&1 | head -10 || echo "Dev started successfully (killed by timeout)"

echo ""
echo "=== Testing build ==="
npx /Users/jtsmith/board_game_service/BoardSmith/dist/cli/cli.js build
ls dist/

echo ""
echo "=== Testing pack (should fail in standalone) ==="
npx /Users/jtsmith/board_game_service/BoardSmith/dist/cli/cli.js pack 2>&1 | grep -i error || echo "Expected error"

# Clean up
rm -rf dist/

# Test pack in monorepo
cd /Users/jtsmith/board_game_service/BoardSmith
echo ""
echo "=== Testing pack in monorepo ==="
npx ./dist/cli/cli.js pack --out-dir /tmp/pack-test 2>&1 | head -10
ls /tmp/pack-test/ 2>/dev/null || echo "Pack output"
rm -rf /tmp/pack-test
```
</verification>

<success_criteria>
- [ ] `boardsmith dev` starts successfully in standalone game projects
- [ ] `boardsmith dev` still works in monorepo context
- [ ] `boardsmith build` produces correct bundles with `boardsmith` as external
- [ ] `boardsmith build` gives helpful error if run in monorepo root
- [ ] `boardsmith test` runs tests in standalone projects (no changes needed - already works)
- [ ] `boardsmith pack` works in monorepo, packing single boardsmith package
- [ ] `boardsmith pack` gives clear error message in standalone context
- [ ] CLI help output has no `@boardsmith/*` references (CLI-06)
- [ ] All CLI commands have no `@boardsmith/*` references in generated output
</success_criteria>

<output>
After completion, create `.planning/phases/45-cli-update/45-02-SUMMARY.md`
</output>
