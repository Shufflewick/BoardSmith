---
phase: 64-engine-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/engine/dist/element/game.js
  - packages/engine/dist/element/game.d.ts
autonomous: true

must_haves:
  truths:
    - "Game developer can access player.color and receive a hex string"
    - "Game developer can define colors array in game config and players are assigned from it"
    - "Game developer can set colorSelectionEnabled: false to disable color selection"
    - "Player joining seat N receives color at index N-1 from the palette"
    - "Engine throws helpful error if playerCount exceeds available colors"
    - "Default color palette used when game doesn't specify custom colors"
  artifacts:
    - path: "packages/engine/dist/element/game.js"
      provides: "GameOptions extension, DEFAULT_COLOR_PALETTE, color assignment logic"
      contains: "DEFAULT_COLOR_PALETTE"
    - path: "packages/engine/dist/element/game.d.ts"
      provides: "TypeScript types for colors and colorSelectionEnabled"
      contains: "colors?: string[]"
  key_links:
    - from: "Game constructor"
      to: "Player.color"
      via: "palette[i - 1] assignment during player creation loop"
      pattern: "player\\.color\\s*=\\s*palette"
    - from: "GameOptions.colors"
      to: "game.settings"
      via: "settings.colors and settings.colorSelectionEnabled storage"
      pattern: "settings\\.colors"
---

<objective>
Add engine-level player color management to BoardSmith.

Purpose: Eliminate duplicated color assignment logic across games by moving it into the engine. Games can configure colors via GameOptions, and players automatically receive colors based on seat position.

Output: Modified game.js and game.d.ts with color configuration support, default palette, validation, and auto-assignment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/64-engine-layer/64-RESEARCH.md

Key files to reference:
@packages/engine/dist/element/game.js
@packages/engine/dist/element/game.d.ts
@packages/engine/dist/player/player.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DEFAULT_COLOR_PALETTE and extend GameOptions types</name>
  <files>
    packages/engine/dist/element/game.d.ts
    packages/engine/dist/element/game.js
  </files>
  <action>
    1. In game.d.ts, extend the GameOptions type to add:
       ```typescript
       /** Available color palette for players (hex strings) */
       colors?: string[];
       /** Whether players can change colors in lobby (default: true) */
       colorSelectionEnabled?: boolean;
       ```

    2. In game.js, add DEFAULT_COLOR_PALETTE constant BEFORE the Game class definition:
       ```javascript
       /**
        * Default player color palette.
        * Used when games don't specify custom colors in GameOptions.
        * 8 colors to support up to 8 players.
        */
       export const DEFAULT_COLOR_PALETTE = [
         '#e74c3c',  // Red
         '#3498db',  // Blue
         '#27ae60',  // Green
         '#f39c12',  // Yellow/Orange
         '#9b59b6',  // Purple
         '#1abc9c',  // Teal
         '#e67e22',  // Orange
         '#2c3e50',  // Dark Blue/Black
       ];
       ```

    3. In game.d.ts, add the export for DEFAULT_COLOR_PALETTE:
       ```typescript
       /**
        * Default player color palette.
        * Used when games don't specify custom colors in GameOptions.
        * 8 colors to support up to 8 players.
        */
       export declare const DEFAULT_COLOR_PALETTE: readonly string[];
       ```

    IMPORTANT: The engine package only has compiled JS and .d.ts files (no .ts source). Edit the files directly.
  </action>
  <verify>
    grep -n "DEFAULT_COLOR_PALETTE" packages/engine/dist/element/game.js
    grep -n "colors?:" packages/engine/dist/element/game.d.ts
    grep -n "colorSelectionEnabled" packages/engine/dist/element/game.d.ts
  </verify>
  <done>
    GameOptions type includes colors and colorSelectionEnabled properties.
    DEFAULT_COLOR_PALETTE exported from game.js and declared in game.d.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add color validation and auto-assignment in Game constructor</name>
  <files>packages/engine/dist/element/game.js</files>
  <action>
    Modify the Game constructor to add color management. In the constructor function (around line 265), add the following logic AFTER the existing player creation loop (lines 297-302):

    1. BEFORE the player creation loop (around line 291), add validation:
       ```javascript
       // Resolve color palette
       const colorPalette = options.colors ?? DEFAULT_COLOR_PALETTE;

       // Validate color count early (fail-fast)
       if (options.playerCount > colorPalette.length) {
         throw new Error(
           `Cannot create ${options.playerCount} players: only ${colorPalette.length} colors available. ` +
           `Provide more colors in gameOptions.colors or reduce playerCount.`
         );
       }
       ```

    2. MODIFY the player creation loop (around line 297-302) to assign colors:
       The current code is:
       ```javascript
       for (let i = 0; i < options.playerCount; i++) {
           const playerName = options.playerNames?.[i] ?? `Player ${i + 1}`;
           const player = this.create(PlayerClassToUse, playerName, { position: i + 1 });
           if (i === 0)
               player.setCurrent(true);
       }
       ```

       Change to:
       ```javascript
       for (let i = 0; i < options.playerCount; i++) {
           const playerName = options.playerNames?.[i] ?? `Player ${i + 1}`;
           const player = this.create(PlayerClassToUse, playerName, { position: i + 1 });
           // Auto-assign color from palette (seat 1 = index 0, seat 2 = index 1, etc.)
           player.color = colorPalette[i];
           if (i === 0)
               player.setCurrent(true);
       }
       ```

    3. AFTER the player creation loop, store color config in settings:
       ```javascript
       // Store color configuration for session layer access
       this.settings.colors = colorPalette;
       this.settings.colorSelectionEnabled = options.colorSelectionEnabled ?? true;
       ```

    Note: The comment about seat/index is important because player.position is 1-indexed (seat 1, 2, 3...) but the loop variable i is 0-indexed, so colorPalette[i] correctly maps seat 1 to index 0.
  </action>
  <verify>
    # Verify color validation exists
    grep -n "Cannot create.*players.*colors available" packages/engine/dist/element/game.js

    # Verify color assignment in loop
    grep -n "player.color = colorPalette" packages/engine/dist/element/game.js

    # Verify settings storage
    grep -n "settings.colorSelectionEnabled" packages/engine/dist/element/game.js
  </verify>
  <done>
    Game constructor validates playerCount vs color count.
    Game constructor assigns colors to players during creation.
    Color configuration stored in game.settings for session layer.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test color auto-assignment with existing game</name>
  <files>None (testing only)</files>
  <action>
    Create a quick test to verify the implementation works:

    1. Navigate to the hex game directory (or any BoardSmithGames project)

    2. Start the dev server and create a new game

    3. In browser console or via test, verify:
       - game.all(Player)[0].color returns a hex string like '#e74c3c'
       - game.all(Player)[1].color returns a different hex string like '#3498db'
       - game.settings.colors is an array of 8 colors
       - game.settings.colorSelectionEnabled is true

    4. Test validation by temporarily modifying a game to use more players than colors:
       ```javascript
       // This should throw an error during game creation
       const game = new HexGame({ playerCount: 10 });
       ```
       Expected error: "Cannot create 10 players: only 8 colors available..."

    5. Test custom colors by passing colors option:
       ```javascript
       const game = new HexGame({
         playerCount: 2,
         colors: ['#ff0000', '#00ff00']
       });
       // Verify players get the custom colors
       ```

    IMPORTANT: The hex game still has its own applyPlayerColors() method. That's fine for now - it will override the engine-assigned colors. Phase 68 will remove those manual color assignments from games.
  </action>
  <verify>
    # Run hex game dev server and test in browser
    # Or create a simple test script that imports the engine and creates a game

    # Quick smoke test - try to import and check exports
    cd /Users/jtsmith/BoardSmithGames/hex && node -e "
      import('@boardsmith/engine').then(m => {
        console.log('DEFAULT_COLOR_PALETTE exists:', !!m.DEFAULT_COLOR_PALETTE);
        console.log('Palette length:', m.DEFAULT_COLOR_PALETTE?.length);
      });
    "
  </verify>
  <done>
    Engine color auto-assignment verified working.
    Default palette provides 8 colors.
    Validation throws helpful error when playerCount exceeds colors.
    Custom colors can be provided via GameOptions.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Type checking: Verify game.d.ts is valid TypeScript
   ```bash
   cd /Users/jtsmith/BoardSmith && npx tsc packages/engine/dist/element/game.d.ts --noEmit 2>&1 || echo "Note: .d.ts files may need context"
   ```

2. Export verification:
   ```bash
   grep -n "export.*DEFAULT_COLOR_PALETTE" packages/engine/dist/element/game.js
   grep -n "export declare const DEFAULT_COLOR_PALETTE" packages/engine/dist/element/game.d.ts
   ```

3. Integration check - verify a game can import and use the new exports:
   ```bash
   cd /Users/jtsmith/BoardSmithGames/hex && node -e "
     import('@boardsmith/engine').then(m => {
       console.log('DEFAULT_COLOR_PALETTE:', m.DEFAULT_COLOR_PALETTE);
     });
   "
   ```
</verification>

<success_criteria>
- [x] ENG-01: player.color property accessible (already existed, now auto-assigned)
- [x] ENG-02: GameOptions.colors array configures available colors
- [x] ENG-03: GameOptions.colorSelectionEnabled flag with default true
- [x] ENG-04: Players auto-assigned colors from palette by seat index
- [x] ENG-05: Error thrown if playerCount > colors.length
- [x] ENG-06: DEFAULT_COLOR_PALETTE provides 8-color default
</success_criteria>

<output>
After completion, create `.planning/phases/64-engine-layer/64-01-SUMMARY.md`
</output>
