---
phase: 66-ui-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/session/types.ts
  - src/session/lobby-manager.ts
  - src/ui/components/WaitingRoom.vue
  - src/ui/components/PlayersPanel.vue
autonomous: true

must_haves:
  truths:
    - "Lobby shows color picker when game has colorSelectionEnabled: true"
    - "Lobby hides color picker when game has colorSelectionEnabled: false"
    - "Color picker visually distinguishes available vs occupied colors"
    - "PlayerStats displays player color indicator when colorSelectionEnabled: true"
    - "PlayerStats hides color indicator when colorSelectionEnabled: false"
  artifacts:
    - path: "src/session/types.ts"
      provides: "LobbyInfo with colorSelectionEnabled and colors"
      contains: "colorSelectionEnabled"
    - path: "src/session/lobby-manager.ts"
      provides: "getLobbyInfo returning colorSelectionEnabled and colors"
      contains: "colorSelectionEnabled"
    - path: "src/ui/components/WaitingRoom.vue"
      provides: "Conditional color picker rendering"
      contains: "colorSelectionEnabled"
    - path: "src/ui/components/PlayersPanel.vue"
      provides: "Conditional color indicator rendering"
      contains: "colorSelectionEnabled"
  key_links:
    - from: "src/session/lobby-manager.ts"
      to: "src/session/types.ts"
      via: "getLobbyInfo returns LobbyInfo with color fields"
      pattern: "colorSelectionEnabled.*colors"
    - from: "src/ui/components/WaitingRoom.vue"
      to: "LobbyInfo"
      via: "lobby prop with colorSelectionEnabled"
      pattern: "lobby\\.colorSelectionEnabled"
    - from: "src/ui/components/PlayersPanel.vue"
      to: "colorSelectionEnabled prop"
      via: "conditional v-if"
      pattern: "colorSelectionEnabled && player\\.color"
---

<objective>
Add conditional color UI to Lobby (WaitingRoom) and PlayerStats (PlayersPanel)

Purpose: Complete the UI layer of player colors refactor - users can see and select colors in lobby when enabled, and see color indicators during gameplay.

Output: WaitingRoom auto-shows color picker when colorSelectionEnabled is true (using game's colors array), PlayersPanel shows color swatch conditionally.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-session-layer/65-01-SUMMARY.md
@.planning/phases/66-ui-layer/66-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend LobbyInfo with color configuration</name>
  <files>
    src/session/types.ts
    src/session/lobby-manager.ts
  </files>
  <action>
1. In src/session/types.ts, add two new optional fields to LobbyInfo interface (after maxPlayers):
   - colorSelectionEnabled?: boolean - whether players can select colors
   - colors?: string[] - available color palette (hex strings)

2. In src/session/lobby-manager.ts getLobbyInfo() method, populate these new fields:
   - colorSelectionEnabled: this.#storedState.colorSelectionEnabled (from game settings)
   - colors: this.#storedState.colors (from game settings)

Note: The storedState already has access to colorSelectionEnabled and colors from Phase 64 engine layer. They're stored in game.settings and passed through to StoredGameState during game creation.

Check StoredGameState interface in types.ts - it may need colorSelectionEnabled and colors fields added if not already present. Add them if needed.
  </action>
  <verify>
TypeScript compiles without errors: `npm run build` passes.
  </verify>
  <done>
LobbyInfo includes colorSelectionEnabled and colors fields, and getLobbyInfo() populates them from stored state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auto-injected color option to WaitingRoom</name>
  <files>
    src/ui/components/WaitingRoom.vue
  </files>
  <action>
Update WaitingRoom to auto-show a color picker when colorSelectionEnabled is true:

1. Add colorSelectionEnabled and colors to the local LobbyInfo interface (already partially defined in the component):
   - colorSelectionEnabled?: boolean
   - colors?: string[]

2. Create a computed property `effectivePlayerOptions` that:
   - Returns props.playerOptions if colorSelectionEnabled is false or undefined
   - When colorSelectionEnabled is true, auto-injects a 'color' option using lobby.colors:
     ```typescript
     const colorOption = {
       type: 'color' as const,
       label: 'Color',
       choices: (props.lobby.colors || []).map(c => ({ value: c, label: c })),
     };
     return { color: colorOption, ...props.playerOptions };
     ```

3. Update the template where playerOptions are used:
   - Replace `standardPlayerOptions` references to use new computed that filters from `effectivePlayerOptions`
   - The existing color picker UI (lines 707-721) will render automatically since it handles `type: 'color'`

4. The existing `isChoiceTaken` and `getMyOptionValue` functions already work correctly for color checking.

Key: The color option should appear in the "Your Settings" panel below the name field when colorSelectionEnabled is true.
  </action>
  <verify>
Create a test game with colorSelectionEnabled: true (or use default since it defaults to true). Lobby should show color swatches in "Your Settings" section. Color picker should NOT appear when colorSelectionEnabled is explicitly false.
  </verify>
  <done>
WaitingRoom shows color picker when lobby.colorSelectionEnabled is true, using lobby.colors for the palette. Color picker is hidden when colorSelectionEnabled is false.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add conditional color indicator to PlayersPanel</name>
  <files>
    src/ui/components/PlayersPanel.vue
  </files>
  <action>
Update PlayersPanel to conditionally show player color based on colorSelectionEnabled:

1. Add new optional prop:
   - colorSelectionEnabled?: boolean - whether to show player color indicators

2. Update the template (line 40):
   - Current: `<span v-if="player.color" class="player-color" ...>`
   - Change to: `<span v-if="colorSelectionEnabled && player.color" class="player-color" ...>`

3. Update GameShell.vue to pass colorSelectionEnabled to PlayersPanel:
   - Add a computed property that derives colorSelectionEnabled from game state
   - For lobby state: use lobbyInfo.colorSelectionEnabled
   - For game state: use state.value?.state.players[0]?.color !== undefined (if any player has color, it's enabled)
   - Pass as prop: `:color-selection-enabled="colorSelectionEnabled"`

Wait - simpler approach: During gameplay, players array already has color property. The presence of player.color indicates colors are enabled. But for consistency with lobby behavior, let's make it explicit:

Actually simplest approach: In PlayersPanel, don't change the v-if at all. The existing `v-if="player.color"` already does the right thing:
- If colorSelectionEnabled is false, player.color won't be set -> hidden
- If colorSelectionEnabled is true, player.color will be set -> shown

BUT wait - Phase 64 auto-assigns colors even when colorSelectionEnabled is false. So player.color is ALWAYS set.

Therefore we DO need the prop. Let me check Phase 64 implementation...

Actually looking at Phase 64 summary: "Default colorSelectionEnabled to true (opt-out, not opt-in)" and colors are auto-assigned. So:
- colorSelectionEnabled: true -> players have colors and can change them -> show in UI
- colorSelectionEnabled: false -> players have colors (auto-assigned) but can't change them -> HIDE in UI

The requirement is clear: UI-04 says show when true, UI-05 says hide when false.

Implementation:
1. Add colorSelectionEnabled prop to PlayersPanel
2. Change v-if to: `v-if="colorSelectionEnabled && player.color"`
3. In GameShell, compute colorSelectionEnabled from state (check if first player has a 'colorSelectionEnabled' field in game metadata, or just use the presence in lobbyInfo which persists)

Hmm, during gameplay we don't have LobbyInfo. We need game state to carry this.

Simpler: During gameplay, the game.settings.colorSelectionEnabled should be available. Check if PlayerGameState includes it or can be added.

Actually, looking at the code - GameShell already has access to lobbyInfo during waiting, and during game it has state. Let's:
1. Store colorSelectionEnabled in GameShell as a ref that persists from lobby to game
2. Set it when lobby info is received
3. Pass to PlayersPanel
  </action>
  <verify>
1. Create game with colorSelectionEnabled: true (default) - PlayersPanel shows color swatches next to player names
2. Create game with colorSelectionEnabled: false - PlayersPanel hides color swatches (only shows names and turn indicators)
  </verify>
  <done>
PlayersPanel shows player color indicators when colorSelectionEnabled is true and hides them when false.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build` passes without errors
2. Create new game (default colorSelectionEnabled: true):
   - Lobby shows color swatches in "Your Settings"
   - Selecting a color updates playerOptions
   - During game, PlayersPanel shows color indicators
3. Modify a test game to use colorSelectionEnabled: false:
   - Lobby does NOT show color picker
   - During game, PlayersPanel does NOT show color indicators
4. Color conflict handling still works (from Phase 65):
   - Selecting a taken color shows error toast
</verification>

<success_criteria>
- [ ] LobbyInfo type includes colorSelectionEnabled and colors
- [ ] getLobbyInfo() returns colorSelectionEnabled and colors from stored state
- [ ] WaitingRoom shows color picker only when colorSelectionEnabled is true
- [ ] WaitingRoom uses lobby.colors for the color palette
- [ ] PlayersPanel shows color indicator only when colorSelectionEnabled is true
- [ ] All existing functionality preserved (ready states, name editing, slot management)
</success_criteria>

<output>
After completion, create `.planning/phases/66-ui-layer/66-01-SUMMARY.md`
</output>
