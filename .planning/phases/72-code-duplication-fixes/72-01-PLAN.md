---
phase: 72-code-duplication-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/flow/engine.ts
  - src/ui/composables/useActionController.ts
autonomous: true

must_haves:
  truths:
    - "FlowEngine resume() and resumeAfterExternalAction() share completion logic via extracted helper"
    - "useActionController auto-fill pattern is extracted and reused in start(), startFollowUp(), and watcher"
    - "No behavioral changes - refactoring only"
    - "All existing tests pass"
  artifacts:
    - path: "src/engine/flow/engine.ts"
      provides: "handleActionStepCompletion and completeActionStep private methods"
      contains: "handleActionStepCompletion"
    - path: "src/ui/composables/useActionController.ts"
      provides: "tryAutoFillSelection and fetchAndAutoFill helper functions"
      contains: "tryAutoFillSelection"
  key_links:
    - from: "FlowEngine.resume()"
      to: "FlowEngine.handleActionStepCompletion()"
      via: "method call"
      pattern: "this\\.handleActionStepCompletion\\(result\\)"
    - from: "FlowEngine.resumeAfterExternalAction()"
      to: "FlowEngine.handleActionStepCompletion()"
      via: "method call"
      pattern: "this\\.handleActionStepCompletion\\(result\\)"
    - from: "useActionController.start()"
      to: "fetchAndAutoFill()"
      via: "function call"
      pattern: "await fetchAndAutoFill\\("
    - from: "useActionController.startFollowUp()"
      to: "fetchAndAutoFill()"
      via: "function call"
      pattern: "await fetchAndAutoFill\\("
---

<objective>
Extract shared logic patterns from FlowEngine and useActionController to eliminate code duplication.

Purpose: DUP-01 and DUP-02 identified ~40 lines of duplicated completion logic in FlowEngine and ~50 lines of duplicated auto-fill logic in useActionController. Extracting these patterns reduces maintenance burden and creates a single source of truth for each behavior.

Output: Refactored FlowEngine with handleActionStepCompletion/completeActionStep helpers, and refactored useActionController with tryAutoFillSelection/fetchAndAutoFill helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/72-code-duplication-fixes/72-RESEARCH.md

@src/engine/flow/engine.ts
@src/ui/composables/useActionController.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract FlowEngine action step completion helpers</name>
  <files>src/engine/flow/engine.ts</files>
  <action>
Extract the duplicated action step completion logic from `resume()` (lines 182-223) and `resumeAfterExternalAction()` (lines 248-288) into two private helper methods:

1. Create `private handleActionStepCompletion(result: ActionResult): boolean` that:
   - Gets the current frame from the stack
   - Returns false early if not an action-step
   - Returns true if result has followUp (caller should run() immediately)
   - Increments move count in frame.data
   - Checks completion conditions (maxMoves, repeatUntil, no-limits)
   - Calls completeActionStep() when appropriate
   - Returns false otherwise

2. Create `private completeActionStep(frame: ExecutionFrame): void` that:
   - Sets frame.completed = true
   - Sets this.currentActionConfig = undefined
   - Sets this.moveCount = 0

3. Update `resume()` to use the helper:
   - After action execution and clearing error/awaiting state
   - Replace the inline completion logic with: `if (this.handleActionStepCompletion(result)) { return this.run(); }`
   - Keep the final `return this.run();`

4. Update `resumeAfterExternalAction()` to use the helper:
   - After clearing awaitingInput
   - Replace the inline completion logic with: `if (this.handleActionStepCompletion(result)) { return this.run(); }`
   - Keep the final `return this.run();`

Place the new methods in the "Resume Handling" section (after resumeSimultaneousAction, around line 395).

Preserve all existing behavior - the extracted logic must be identical to the current inline code.
  </action>
  <verify>
Run `npm test -- --run src/engine/flow` to verify all FlowEngine tests pass.
Run `npm run typecheck` to verify no type errors.
  </verify>
  <done>
FlowEngine.resume() and FlowEngine.resumeAfterExternalAction() both use handleActionStepCompletion() helper. No duplicated completion logic remains in these methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract useActionController auto-fill helpers</name>
  <files>src/ui/composables/useActionController.ts</files>
  <action>
Extract the duplicated fetch-and-auto-fill logic from `start()` (lines 1065-1113) and `startFollowUp()` (lines 960-1003) into two helper functions inside the useActionController composable:

1. Create `function tryAutoFillSelection(selection: PickMetadata): boolean` that:
   - Returns false early if !getAutoFill() || isExecuting.value
   - Gets choices via getChoices(selection)
   - Returns false if choices.length !== 1 || selection.optional
   - Gets the single choice
   - Sets currentArgs.value[selection.name] = choice.value
   - Updates actionSnapshot.value.collectedPicks with value/display/skipped
   - Returns true

2. Create `async function fetchAndAutoFill(selection: PickMetadata): Promise<void>` that:
   - Returns early if selection.type is not 'choice', 'element', or 'elements'
   - Sets suppressNextWatcherFetch = true
   - Calls await fetchChoicesForPick(selection.name)
   - Calls tryAutoFillSelection(selection)
   - If auto-fill succeeded, gets next selection via getNextSelection(selection.name)
   - If next selection exists and is fetchable type, recursively calls await fetchAndAutoFill(nextSel)

3. Update `start()` to use the helpers:
   - After setting up actionSnapshot, find first unfilled selection
   - Replace the fetch/auto-fill block (lines 1066-1113) with: `if (selectionToFetch) { await fetchAndAutoFill(selectionToFetch); }`

4. Update `startFollowUp()` to use the helpers:
   - After setting up actionSnapshot, find first unfilled selection
   - Replace the fetch/auto-fill block (lines 960-1003) with: `if (selectionToFetch) { await fetchAndAutoFill(selectionToFetch); }`

5. The currentPick watcher (lines 653-671) has a simpler pattern - it only does single auto-fill without recursive next-selection. Update it to use tryAutoFillSelection() but NOT fetchAndAutoFill() (since it handles fetch separately and has prefill logic). Specifically:
   - Keep the existing fetch and prefill logic unchanged
   - Replace lines 655-671 (the auto-fill block) with: `tryAutoFillSelection(sel);`

Place the helper functions near other internal helpers (around line 456, after buildServerArgs).

Preserve all existing behavior including the suppressNextWatcherFetch flag coordination.
  </action>
  <verify>
Run `npm test -- --run src/ui/composables/useActionController` to verify all action controller tests pass.
Run `npm run typecheck` to verify no type errors.
  </verify>
  <done>
useActionController start(), startFollowUp(), and currentPick watcher use the extracted helpers. Auto-fill logic has a single source of truth.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. Run full test suite: `npm test -- --run`
2. Run typecheck: `npm run typecheck`
3. Verify no functional changes by checking test coverage hasn't changed
</verification>

<success_criteria>
- DUP-01: FlowEngine completion logic extracted to handleActionStepCompletion/completeActionStep
- DUP-02: useActionController auto-fill logic extracted to tryAutoFillSelection/fetchAndAutoFill
- All existing tests pass
- No type errors
- No behavioral changes (pure refactoring)
</success_criteria>

<output>
After completion, create `.planning/phases/72-code-duplication-fixes/72-01-SUMMARY.md`
</output>
