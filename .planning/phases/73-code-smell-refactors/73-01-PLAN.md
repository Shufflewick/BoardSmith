---
phase: 73-code-smell-refactors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/composables/useActionControllerTypes.ts
  - src/ui/composables/useActionController.ts
autonomous: true

must_haves:
  truths:
    - "No module-level mutable state for watcher coordination"
    - "fetchedSelections Set prevents double-fetch same as the flag did"
    - "injectBoardInteraction returns unknown (not unknown | undefined)"
    - "All existing tests pass"
  artifacts:
    - path: "src/ui/composables/useActionControllerTypes.ts"
      provides: "ActionStateSnapshot with fetchedSelections field"
      contains: "fetchedSelections"
    - path: "src/ui/composables/useActionController.ts"
      provides: "Refactored coordination using scoped state"
      exports: ["useActionController", "injectBoardInteraction"]
  key_links:
    - from: "src/ui/composables/useActionController.ts"
      to: "actionSnapshot.value.fetchedSelections"
      via: "Set.add() before fetch, Set.has() in watcher"
      pattern: "fetchedSelections\\.(add|has)"
---

<objective>
Fix two code smells in useActionController: replace module-level flag with scoped state and fix redundant return type

Purpose: Eliminate fragile module-level mutable state that can cause race conditions, and clean up redundant type annotations
Output: Refactored useActionController with proper coordination pattern and clean types
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/73-code-smell-refactors/73-RESEARCH.md
@src/ui/composables/useActionController.ts
@src/ui/composables/useActionControllerTypes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace suppressNextWatcherFetch with fetchedSelections Set</name>
  <files>
    src/ui/composables/useActionControllerTypes.ts
    src/ui/composables/useActionController.ts
  </files>
  <action>
Replace the module-level `suppressNextWatcherFetch` flag with a `fetchedSelections` Set in ActionStateSnapshot.

1. In useActionControllerTypes.ts, add to ActionStateSnapshot interface:
   ```typescript
   /** Set of selection names that have been fetched (prevents double-fetch) */
   fetchedSelections: Set<string>;
   ```

2. In useActionController.ts:
   - Remove line 210: `let suppressNextWatcherFetch = false;`
   - Update `start()` and `startFollowUp()` to initialize `fetchedSelections: new Set()` in the actionSnapshot
   - Update `fetchAndAutoFill()` (lines 490-506):
     - Remove `suppressNextWatcherFetch = true;` (line 496)
     - Add `actionSnapshot.value?.fetchedSelections.add(selection.name);` BEFORE the await fetchChoicesForPick call
   - Update the currentPick watcher (lines 649-707):
     - Replace the flag check (lines 654-657) with:
       ```typescript
       const alreadyFetched = actionSnapshot.value?.fetchedSelections.has(sel.name) ?? false;
       ```
     - Remove the flag clearing logic
     - Change the condition to use `alreadyFetched` instead of `shouldSkipFetch`
     - When fetching in the watcher (line 663), also add to fetchedSelections BEFORE fetching:
       ```typescript
       actionSnapshot.value?.fetchedSelections.add(sel.name);
       ```

The key behavioral requirement: fetchedSelections.add() must happen BEFORE the async fetch to prevent the watcher from racing ahead.
  </action>
  <verify>
    - `npm run test -- --grep "useActionController"` passes
    - `npm run typecheck` passes
    - No usages of `suppressNextWatcherFetch` in codebase: `grep -r "suppressNextWatcherFetch" src/`
  </verify>
  <done>
    - Module-level `suppressNextWatcherFetch` variable is removed
    - ActionStateSnapshot has `fetchedSelections: Set<string>` field
    - start() and startFollowUp() initialize the Set
    - fetchAndAutoFill() adds to Set before fetching
    - Watcher checks Set instead of flag
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix redundant unknown | undefined return type</name>
  <files>src/ui/composables/useActionController.ts</files>
  <action>
Fix the redundant return type in `injectBoardInteraction()`.

At line 1471, change:
```typescript
export function injectBoardInteraction(): unknown | undefined {
  return inject<unknown | undefined>('boardInteraction', undefined);
}
```

To:
```typescript
export function injectBoardInteraction(): unknown {
  return inject('boardInteraction', undefined);
}
```

The `unknown` type is TypeScript's top type and already includes `undefined`, making `| undefined` redundant. The inject call still uses the default value of `undefined` which is fine, but the return type annotation doesn't need the union.
  </action>
  <verify>
    - `npm run typecheck` passes
    - Function signature shows `unknown` not `unknown | undefined`
  </verify>
  <done>
    - injectBoardInteraction() returns `unknown` (not `unknown | undefined`)
    - TypeScript compilation succeeds
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npm run test` - All tests pass
2. `npm run typecheck` - No type errors
3. `grep -r "suppressNextWatcherFetch" src/` - Returns nothing (flag removed)
4. Manual inspection: ActionStateSnapshot interface includes `fetchedSelections: Set<string>`
5. Manual inspection: injectBoardInteraction returns `unknown`
</verification>

<success_criteria>
- SMELL-01: No module-level mutable state for coordination; fetchedSelections Set in ActionStateSnapshot handles double-fetch prevention
- SMELL-02: injectBoardInteraction() return type is clean `unknown`
- All existing tests continue to pass
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/73-code-smell-refactors/73-01-SUMMARY.md`
</output>
