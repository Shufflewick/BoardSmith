---
phase: 75-engine-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/action/types.ts
  - src/engine/action/action-builder.ts
  - src/engine/action/index.ts
autonomous: true

must_haves:
  truths:
    - "AnnotatedChoice<T> type exists with { value: T, disabled: string | false }"
    - "ChoiceSelection, ElementSelection, and ElementsSelection interfaces each have optional disabled callback"
    - "chooseFrom, chooseElement, and fromElements builder methods accept disabled option and store it on the selection"
    - "AnnotatedChoice is exported from engine action index and engine index"
  artifacts:
    - path: "src/engine/action/types.ts"
      provides: "AnnotatedChoice type and disabled on selection interfaces"
      contains: "AnnotatedChoice"
    - path: "src/engine/action/action-builder.ts"
      provides: "Builder methods accepting disabled option"
      contains: "disabled"
    - path: "src/engine/action/index.ts"
      provides: "AnnotatedChoice export"
      contains: "AnnotatedChoice"
  key_links:
    - from: "src/engine/action/action-builder.ts"
      to: "src/engine/action/types.ts"
      via: "imports ChoiceSelection/ElementSelection/ElementsSelection with disabled field"
      pattern: "disabled.*options\\.disabled"
---

<objective>
Add the AnnotatedChoice type, disabled callback to selection interfaces, and disabled option to all three builder methods.

Purpose: Establishes the type foundation and builder API that Plan 02 will consume to implement getChoices annotation, validation, and path checking.
Output: Updated types.ts with AnnotatedChoice and disabled fields, updated action-builder.ts with disabled option on chooseFrom/chooseElement/fromElements, updated index.ts exporting AnnotatedChoice.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/75-engine-core/75-RESEARCH.md
@docs/plans/2026-02-05-disabled-selections-design.md
@src/engine/action/types.ts
@src/engine/action/action-builder.ts
@src/engine/action/index.ts
@src/engine/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AnnotatedChoice type and disabled to selection interfaces</name>
  <files>src/engine/action/types.ts, src/engine/action/index.ts, src/engine/index.ts</files>
  <action>
In `src/engine/action/types.ts`:

1. Add the `AnnotatedChoice<T>` type near the top of the file (after the `SelectionType` definition, before the selection interfaces):

```typescript
/**
 * A choice annotated with its disabled status.
 * Returned by getChoices() for all selection types.
 */
export type AnnotatedChoice<T> = {
  /** The actual choice value */
  value: T;
  /**
   * Disabled reason string, or false if selectable.
   * No bare `true` -- forces a reason string for good UX.
   */
  disabled: string | false;
};
```

2. Add `disabled` callback to `ChoiceSelection<T>` interface (after the existing `multiSelect` field):

```typescript
/**
 * Check if a choice should be disabled (visible but not selectable).
 * Returns a reason string if disabled, or false if selectable.
 * Only runs on items that passed filter (filter = visibility, disabled = selectability).
 */
disabled?: (choice: T, context: ActionContext) => string | false;
```

3. Add `disabled` callback to `ElementSelection<T>` interface (after the existing `repeat`/`repeatUntil` fields):

```typescript
/**
 * Check if an element should be disabled (visible but not selectable).
 * Returns a reason string if disabled, or false if selectable.
 * Only runs on elements that passed filter (filter = visibility, disabled = selectability).
 */
disabled?: (element: T, context: ActionContext) => string | false;
```

4. Add `disabled` callback to `ElementsSelection<T>` interface (after the existing `repeat`/`repeatUntil` fields):

```typescript
/**
 * Check if an element should be disabled (visible but not selectable).
 * Returns a reason string if disabled, or false if selectable.
 */
disabled?: (element: T, context: ActionContext) => string | false;
```

In `src/engine/action/index.ts`:

5. Add `AnnotatedChoice` to the type re-exports from `./types.js` (in the existing `export type { ... } from './types.js'` block).

In `src/engine/index.ts`:

6. Add `AnnotatedChoice` to the type re-exports from the action module. Find the existing `export type { ... }` block that re-exports action types and add `AnnotatedChoice` to it.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- should compile with no errors. The new type and fields are additive (optional), so no existing code should break.

Verify the type exists:
```
grep -n "AnnotatedChoice" src/engine/action/types.ts
grep -n "AnnotatedChoice" src/engine/action/index.ts
grep -n "AnnotatedChoice" src/engine/index.ts
```

Verify disabled fields exist on all three interfaces:
```
grep -n "disabled?.*context.*ActionContext" src/engine/action/types.ts
```
Should show 3 matches (ChoiceSelection, ElementSelection, ElementsSelection).
  </verify>
  <done>
AnnotatedChoice type exported from engine. ChoiceSelection, ElementSelection, and ElementsSelection each have optional `disabled` callback with signature `(item, context) => string | false`. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add disabled option to builder methods</name>
  <files>src/engine/action/action-builder.ts</files>
  <action>
Update `action-builder.ts` to thread `disabled` through all three builder methods.

1. **`chooseFrom<T>`** method (starts ~line 152):
   - Add `disabled?: (choice: T, context: ActionContext) => string | false` to the options parameter type (after `multiSelect`)
   - Add `disabled: options.disabled` to the `ChoiceSelection<T>` object construction (after `multiSelect: options.multiSelect`)

2. **`chooseElement<T>`** method (starts ~line 244):
   - Add `disabled?: (element: T, context: ActionContext) => string | false` to the options parameter type (after `dependsOn`)
   - Add `disabled: options.disabled` to the `ElementSelection<T>` object construction (after `dependsOn: options.dependsOn`)

3. **`fromElements<T>`** method (starts ~line 304):
   - Add `disabled?: (element: T, context: ActionContext) => string | false` to the options parameter type (after `repeatUntil`)
   - Add `disabled: options.disabled` to BOTH the `ElementsSelection<T>` object (multiSelect branch, ~line 348) and the `ElementSelection<T>` object (single-select branch, ~line 365)
   - For the `ElementsSelection<T>` branch, add after `repeatUntil: options.repeatUntil`
   - For the `ElementSelection<T>` branch, add after `repeatUntil: options.repeatUntil`

Add JSDoc comments on each `disabled` option matching the pattern:
```
/** Check if item should be disabled. Returns reason string or false. */
```

Do NOT add `ActionContext` to the imports at the top -- it is already imported.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with no errors.

Run existing tests to ensure nothing broke:
```
npx vitest run src/engine/action/action.test.ts
```
All existing tests should pass (disabled is optional, so existing usage is unaffected).

Verify disabled is accepted by creating a quick type-check: search for `disabled: options.disabled` in action-builder.ts -- should appear 4 times (chooseFrom, chooseElement, fromElements multiSelect branch, fromElements single-select branch).
  </verify>
  <done>
All three builder methods (chooseFrom, chooseElement, fromElements) accept `disabled` option and store it on the selection definition. Existing tests still pass. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run src/engine/action/action.test.ts` -- all existing tests pass
3. `AnnotatedChoice` type is exported from `src/engine/action/index.ts` and `src/engine/index.ts`
4. `disabled` callback field exists on ChoiceSelection, ElementSelection, and ElementsSelection interfaces
5. `disabled` option accepted by chooseFrom, chooseElement, and fromElements builder methods
</verification>

<success_criteria>
- AnnotatedChoice<T> type exists with `{ value: T, disabled: string | false }`
- All three selection interfaces have optional `disabled` callback
- All three builder methods accept and store `disabled` option
- TypeScript compiles cleanly, all existing tests pass
- Type is properly exported from engine module
</success_criteria>

<output>
After completion, create `.planning/phases/75-engine-core/75-01-SUMMARY.md`
</output>
