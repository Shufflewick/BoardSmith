---
phase: 77-ui-integration
plan: 02
type: execute
wave: 2
depends_on: ["77-01"]
files_modified:
  - src/ui/components/auto-ui/ActionPanel.vue
  - src/ui/components/auto-ui/AutoElement.vue
autonomous: true

must_haves:
  truths:
    - "ActionPanel disabled element buttons have :disabled attribute and title tooltip with reason"
    - "ActionPanel disabled choice buttons have :disabled attribute and title tooltip with reason"
    - "Multi-select checkboxes for disabled items are uncheckable"
    - "Board elements marked disabled get CSS class bs-element-disabled"
    - "Clicking a disabled board element on the game board does nothing"
    - "Choice-with-refs board click on disabled choice does nothing"
  artifacts:
    - path: "src/ui/components/auto-ui/ActionPanel.vue"
      provides: "Disabled rendering on all 6 button templates, disabled-aware setValidElements mapping, disabled-aware onSelect for choice-with-refs"
      contains: ":disabled"
    - path: "src/ui/components/auto-ui/AutoElement.vue"
      provides: "bs-element-disabled CSS class on disabled board elements"
      contains: "bs-element-disabled"
  key_links:
    - from: "src/ui/components/auto-ui/ActionPanel.vue"
      to: "src/ui/composables/useBoardInteraction.ts"
      via: "setValidElements passes disabled field through"
      pattern: "disabled.*ve\\.disabled"
    - from: "src/ui/components/auto-ui/AutoElement.vue"
      to: "src/ui/composables/useBoardInteraction.ts"
      via: "isDisabledElement computed reads disabled state"
      pattern: "isDisabledElement"
---

<objective>
Add disabled rendering to all ActionPanel button templates and AutoElement board elements.

Purpose: Players see disabled items greyed out with reason tooltips. Disabled items cannot be selected through any UI path (buttons, checkboxes, or board clicks). This is the visual layer of the disabled selections feature.

Output: Updated ActionPanel with disabled attributes on all 6 button templates, disabled-aware board interaction mapping, and AutoElement with bs-element-disabled CSS class.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-ui-integration/77-RESEARCH.md
@src/ui/components/auto-ui/ActionPanel.vue
@src/ui/components/auto-ui/AutoElement.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add disabled rendering to all ActionPanel button templates</name>
  <files>src/ui/components/auto-ui/ActionPanel.vue</files>
  <action>
There are 6 button/checkbox templates that need disabled support. Each needs `:disabled` and `:title` attributes. Search for ALL occurrences of `class="choice-btn"` and `class="element-btn"` and `type="checkbox"` within the selection input section.

**Template 1: Element selection buttons** (~line 1441-1450)
Add to the `<button>` for single element picks:
```vue
:disabled="!!element.disabled"
:title="element.disabled || undefined"
```

**Template 2: Elements multiSelect checkboxes** (~line 1476-1481)
The checkbox already has a `:disabled` binding for max-reached logic. Make it a compound condition:
```vue
:disabled="!!element.disabled || (!isMultiSelectValueSelected(element.id) && currentMultiSelect?.max !== undefined && (multiSelectState?.selectedValues?.length ?? 0) >= currentMultiSelect.max)"
```
Also add `:title="element.disabled || undefined"` on the parent `<label>` element.

**Template 3: Elements without multiSelect buttons** (~line 1502-1510)
Add to the `<button>`:
```vue
:disabled="!!element.disabled"
:title="element.disabled || undefined"
```

**Template 4: MultiSelect choice checkboxes** (~line 1537-1541)
Compound condition like Template 2:
```vue
:disabled="!!choice.disabled || (!isMultiSelectValueSelected(choice.value) && currentMultiSelect?.max !== undefined && (multiSelectState?.selectedValues?.length ?? 0) >= currentMultiSelect.max)"
```
Also add `:title="choice.disabled || undefined"` on the parent `<label>` element.

**Template 5: FilterBy/dependsOn choice buttons** (~line 1563-1571)
Add to the `<button>`:
```vue
:disabled="!!choice.disabled"
:title="choice.disabled || undefined"
```

**Template 6: Regular choice buttons** (~line 1586-1594)
Add to the `<button>`:
```vue
:disabled="!!choice.disabled"
:title="choice.disabled || undefined"
```

**Update setValidElements mapping** (~line 587-590):
The current mapping only passes `{ id, ref }`. Add `disabled`:
```typescript
validElems = filteredValidElements.value.map(ve => ({
  id: ve.id,
  ref: ve.ref || { id: ve.id },
  disabled: ve.disabled,
}));
```

**Guard choice-with-refs onSelect callback** (~line 631-644):
In the `onSelect` callback for choice selections with refs, check disabled before selecting. After `const entry = refToChoice.get(elementId);`, add a disabled check. But the `refToChoice` map only stores `{ value, ref }` -- we need to also store disabled. Update the map building (~line 615-624):
```typescript
const refToChoice = new Map<number, { value: any; ref: any; disabled?: string }>();
choicesWithRefs.forEach((choice: any) => {
  const ref = choice.targetRef || choice.sourceRef;
  if (ref?.id !== undefined) {
    refToChoice.set(ref.id, { value: choice.value, ref, disabled: choice.disabled });
  }
});
```
Then in onSelect (~line 631-644), add early return:
```typescript
onSelect = (elementId: number) => {
  const entry = refToChoice.get(elementId);
  if (entry !== undefined && !entry.disabled) {
    // ... existing logic
  }
};
```

**Also update the validElems for choice-with-refs** (~line 626-629):
```typescript
validElems = Array.from(refToChoice.entries()).map(([id, { ref, disabled }]) => ({
  id,
  ref,
  disabled,
}));
```
This ensures board interaction knows which choice-ref elements are disabled.

NOTE: The HTML `disabled` attribute on `<button>` natively prevents click events and applies `:disabled` pseudo-class styling. No additional click guards are needed in the button click handlers -- `@click` won't fire on disabled buttons.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors.
Run `npx vitest run` to confirm no regressions.
Grep for all `class="choice-btn"` and `class="element-btn"` in ActionPanel.vue -- each must have a `:disabled` binding.
Grep for `type="checkbox"` in the selection-input section -- each must include disabled logic for `choice.disabled` or `element.disabled`.
  </verify>
  <done>
- All 6 button templates have `:disabled="!!element.disabled"` or `:disabled="!!choice.disabled"` (or compound for multi-select)
- All 6 templates have `:title` with the disabled reason
- setValidElements mapping includes `disabled` field
- Choice-with-refs board click checks disabled before selecting
- Requirements UI-01, UI-02 fully addressed
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bs-element-disabled CSS class to AutoElement</name>
  <files>src/ui/components/auto-ui/AutoElement.vue</files>
  <action>
Add a computed that checks if the current element is disabled for the current action selection. This uses the `isDisabledElement()` method added to board interaction in Plan 01.

1. Add a computed property (after the `isActionSelectable` computed, ~line 210-233):
```typescript
const isDisabledForAction = computed(() => {
  if (!boardInteraction) return false;
  return boardInteraction.isDisabledElement({
    id: props.element.id,
    name: props.element.name,
    notation: elementNotation.value || undefined,
  });
});
```

2. Add the `bs-element-disabled` class to the root element's class binding in the template (~line 893-908). Add to the class object:
```vue
'bs-element-disabled': !!isDisabledForAction,
```

3. Add CSS styles for `bs-element-disabled` in the `<style scoped>` section. Place after the existing `.is-hidden` styles:
```css
/* Disabled for current action (visible but not selectable) */
.bs-element-disabled {
  opacity: 0.5;
  filter: grayscale(0.5);
  cursor: not-allowed;
}
```

4. Override `action-selectable` styles when element is also disabled. A disabled element should NOT show the green selectable highlight even if it's in the valid elements list (it's in the list so it renders, but disabled). Add:
```css
/* Disabled overrides action-selectable */
.bs-element-disabled .card-container.action-selectable,
.bs-element-disabled .die-container.action-selectable,
.bs-element-disabled .grid-cell.action-selectable,
.bs-element-disabled .hex-cell.action-selectable,
.bs-element-disabled .hex-polygon.action-selectable {
  cursor: not-allowed;
  animation: none;
  outline-color: rgba(128, 128, 128, 0.4);
}
```

5. Add a `title` attribute to the root `.auto-element` div that shows the disabled reason when present. Update the root div (~line 892):
```vue
:title="(typeof isDisabledForAction === 'string' && isDisabledForAction) || undefined"
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors.
Run `npx vitest run` to confirm no regressions.
Grep for `bs-element-disabled` in AutoElement.vue -- should appear in class binding and CSS.
  </verify>
  <done>
- AutoElement applies `bs-element-disabled` class when boardInteraction.isDisabledElement() returns a reason string
- CSS makes disabled elements visually muted (opacity + grayscale)
- Disabled elements override action-selectable green highlighting
- Title tooltip shows reason on hover
- Requirement UI-05 fully addressed
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run` passes
- All 6 ActionPanel button templates have disabled bindings
- AutoElement has bs-element-disabled class and CSS
- setValidElements passes disabled through to board interaction
- Choice-with-refs onSelect guards against disabled
</verification>

<success_criteria>
Players see disabled items greyed out with reason tooltips in ActionPanel buttons. Board elements get bs-element-disabled CSS class. No interaction path allows selecting a disabled item through the ActionPanel or board. Requirements UI-01, UI-02, UI-05 fully addressed. UI-04 board click guard from Plan 01 is now visible via CSS.
</success_criteria>

<output>
After completion, create `.planning/phases/77-ui-integration/77-02-SUMMARY.md`
</output>
