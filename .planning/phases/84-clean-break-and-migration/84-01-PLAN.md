---
phase: 84-clean-break-and-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/element/game.ts
  - src/engine/element/index.ts
  - src/engine/index.ts
  - src/ui/index.ts
  - src/engine/element/animation-events.test.ts
  - src/engine/element/mutation-capture.test.ts
  - src/engine/element/theatre-state.test.ts
  - src/session/animation-events.test.ts
autonomous: true

must_haves:
  truths:
    - "emitAnimationEvent() does not exist on Game class -- calling it produces a compile error"
    - "EmitAnimationEventOptions type does not exist in any export"
    - "All existing tests pass using only game.animate()"
    - "tsc --noEmit succeeds with zero errors"
  artifacts:
    - path: "src/engine/element/game.ts"
      provides: "Game class without emitAnimationEvent method or EmitAnimationEventOptions interface"
      contains: "animate("
    - path: "src/engine/element/index.ts"
      provides: "Clean exports without EmitAnimationEventOptions"
    - path: "src/engine/index.ts"
      provides: "Clean re-exports without EmitAnimationEventOptions"
    - path: "src/ui/index.ts"
      provides: "Clean re-exports without EmitAnimationEventOptions"
    - path: "src/engine/element/animation-events.test.ts"
      provides: "Tests rewritten to use game.animate() exclusively"
    - path: "src/engine/element/mutation-capture.test.ts"
      provides: "Compatibility describe block removed, remaining tests use game.animate()"
    - path: "src/engine/element/theatre-state.test.ts"
      provides: "All tests use game.animate() exclusively"
    - path: "src/session/animation-events.test.ts"
      provides: "All tests use game.animate() exclusively"
  key_links:
    - from: "src/engine/element/game.ts"
      to: "src/engine/element/index.ts"
      via: "type export"
      pattern: "AnimationEvent.*from.*game\\.js"
    - from: "src/engine/element/index.ts"
      to: "src/engine/index.ts"
      via: "re-export"
      pattern: "AnimationEvent.*from.*element/index"
---

<objective>
Remove `emitAnimationEvent()` and `EmitAnimationEventOptions` from the BoardSmith library entirely, then migrate all library test files to use `game.animate()` exclusively.

Purpose: This is the "clean break" -- after this plan, the old fire-and-forget animation API no longer exists. TypeScript will enforce that all consumers (games, tests) use the new scoped-callback API. This must happen before game migration so that `tsc --noEmit` can catch any missed references.

Output: Library compiles cleanly with only `game.animate()` as the animation API. All tests pass.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-clean-break-and-migration/84-RESEARCH.md
@src/engine/element/game.ts
@src/engine/element/index.ts
@src/engine/index.ts
@src/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove emitAnimationEvent API and clean exports</name>
  <files>
    src/engine/element/game.ts
    src/engine/element/index.ts
    src/engine/index.ts
    src/ui/index.ts
  </files>
  <action>
    In `src/engine/element/game.ts`:
    1. DELETE the `EmitAnimationEventOptions` interface (around line 169-172):
       ```typescript
       export interface EmitAnimationEventOptions {
         group?: string;
       }
       ```
    2. DELETE the entire `emitAnimationEvent()` method (around line 2387-2401), including its JSDoc comment block (starts around line 2362 with `/**`). The JSDoc block contains example code showing `emitAnimationEvent` usage and grouped events -- delete all of it.
    3. UPDATE the JSDoc comment on the `mutations` field of `AnimationEvent` interface (around line 162). Change:
       `/** Mutations captured during an animate() callback. Undefined for emitAnimationEvent(). */`
       to:
       `/** Mutations captured during the animate() callback */`

    In `src/engine/element/index.ts` line 25:
    Remove `EmitAnimationEventOptions` from the type export. Change:
    `export type { GameOptions, GamePhase, PlayerViewFunction, AnimationEvent, EmitAnimationEventOptions } from './game.js';`
    to:
    `export type { GameOptions, GamePhase, PlayerViewFunction, AnimationEvent } from './game.js';`

    In `src/engine/index.ts` around line 42:
    Remove `EmitAnimationEventOptions` from the type export block. It appears in the list with `AnimationEvent` -- remove only `EmitAnimationEventOptions`, keep `AnimationEvent`.

    In `src/ui/index.ts` around line 295:
    Change:
    `export type { AnimationEvent, EmitAnimationEventOptions } from '../engine/index.js';`
    to:
    `export type { AnimationEvent } from '../engine/index.js';`

    After all removals, run `npx tsc --noEmit` from the BoardSmith root. The library source should compile. Test files will fail since they still reference the old API -- that's expected and handled in Task 2.
  </action>
  <verify>
    `grep -r "emitAnimationEvent" src/engine/element/game.ts` returns no matches.
    `grep -r "EmitAnimationEventOptions" src/` returns no matches (except test files which are fixed in Task 2).
    `grep -r "EmitAnimationEventOptions" src/engine/element/index.ts src/engine/index.ts src/ui/index.ts` returns no matches.
  </verify>
  <done>
    `emitAnimationEvent` method and `EmitAnimationEventOptions` interface deleted from game.ts. All barrel exports cleaned. The old API is gone from the library source (non-test files).
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all library tests to game.animate()</name>
  <files>
    src/engine/element/animation-events.test.ts
    src/engine/element/mutation-capture.test.ts
    src/engine/element/theatre-state.test.ts
    src/session/animation-events.test.ts
  </files>
  <action>
    Read each test file and migrate every `emitAnimationEvent` call to `game.animate()`. The pattern is:

    **Before:**
    ```typescript
    game.emitAnimationEvent('type', { key: 'value' });
    ```

    **After:**
    ```typescript
    game.animate('type', { key: 'value' }, () => {});
    ```

    For tests where `emitAnimationEvent` was called with state mutations nearby, wrap those mutations inside the animate callback instead of using an empty callback.

    **Specific file instructions:**

    1. `src/engine/element/animation-events.test.ts` (~32 refs):
       - The entire `describe('emitAnimationEvent', ...)` block (starting at line 14) contains tests for the OLD API. Rewrite every test inside to use `game.animate()` instead of `game.emitAnimationEvent()`. The test assertions about event shape (id, type, data, timestamp) should still pass since `animate()` produces the same `AnimationEvent` structure.
       - Key difference: `animate()` returns `AnimationEvent` just like `emitAnimationEvent()` did, so `const event = game.animate(...)` works.
       - Events from `animate()` always have `mutations: []` (array), while `emitAnimationEvent()` had `mutations: undefined`. Update any assertions that check `mutations` to expect an array (possibly empty) rather than undefined.
       - Rename the describe block from `'emitAnimationEvent'` to `'animate'` or `'animation events'`.

    2. `src/engine/element/mutation-capture.test.ts` (~15 refs):
       - DELETE the entire `describe('emitAnimationEvent compatibility', ...)` block (starting around line 255). These tests specifically tested interleaving old and new APIs -- they're no longer relevant.
       - Any remaining `emitAnimationEvent` calls outside that block: convert to `game.animate()`.

    3. `src/engine/element/theatre-state.test.ts` (~5 refs):
       - Convert all `emitAnimationEvent` calls to `game.animate()` with empty callback.
       - Update any assertions about `mutations` being undefined to expect empty array.

    4. `src/session/animation-events.test.ts` (~12 refs):
       - Convert all `emitAnimationEvent` calls to `game.animate()` with empty callback or with mutations moved inside callback where appropriate.
       - These are session-level tests (GameSession integration), so the `animate()` call is likely on `session.game.animate()` or similar.

    After migrating all test files, run:
    - `npx tsc --noEmit` -- should pass with zero errors
    - `npx vitest run src/engine/element/animation-events.test.ts src/engine/element/mutation-capture.test.ts src/engine/element/theatre-state.test.ts src/session/animation-events.test.ts` -- all tests should pass

    Also run the full test suite: `npx vitest run` to verify nothing else broke.
  </action>
  <verify>
    `grep -r "emitAnimationEvent" src/` returns zero matches.
    `grep -r "EmitAnimationEventOptions" src/` returns zero matches.
    `npx tsc --noEmit` passes with zero errors.
    `npx vitest run` -- all tests pass.
  </verify>
  <done>
    All 4 test files migrated to use `game.animate()` exclusively. No references to `emitAnimationEvent` or `EmitAnimationEventOptions` remain anywhere in `src/`. Full test suite passes. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "emitAnimationEvent\|EmitAnimationEventOptions" src/` returns zero matches
2. `npx tsc --noEmit` passes with zero errors
3. `npx vitest run` passes -- all tests green
4. The `animate()` method still exists and works (confirmed by tests passing)
</verification>

<success_criteria>
- Zero references to `emitAnimationEvent` or `EmitAnimationEventOptions` in the entire `src/` directory
- TypeScript compiles cleanly (`tsc --noEmit` exits 0)
- Full test suite passes (`vitest run` exits 0)
- The `game.animate()` method is the sole animation API
</success_criteria>

<output>
After completion, create `.planning/phases/84-clean-break-and-migration/84-01-SUMMARY.md`
</output>
