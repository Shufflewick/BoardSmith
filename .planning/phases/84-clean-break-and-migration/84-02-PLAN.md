---
phase: 84-clean-break-and-migration
plan: 02
type: execute
wave: 2
depends_on: ["84-01"]
files_modified:
  - ~/BoardSmithGames/demo-animation/src/rules/actions.ts
  - ~/BoardSmithGames/demo-animation/src/ui/components/GameTable.vue
  - ~/BoardSmithGames/cribbage/src/rules/game.ts
  - ~/BoardSmithGames/CLAUDE.md
  - ~/BoardSmithGames/.planning/codebase/ARCHITECTURE.md
autonomous: false

must_haves:
  truths:
    - "Demo animation game uses game.animate() and animations play correctly in the browser"
    - "Cribbage game uses game.animate() and scoring/pegging animations play correctly in the browser"
    - "Neither game references emitAnimationEvent anywhere"
    - "Both games compile cleanly with tsc --noEmit"
  artifacts:
    - path: "~/BoardSmithGames/demo-animation/src/rules/actions.ts"
      provides: "createAnimationEventAction using game.animate() with empty callback"
      contains: "game.animate"
    - path: "~/BoardSmithGames/cribbage/src/rules/game.ts"
      provides: "scoreRoundAndBuildSummary() using game.animate() with addPoints in callbacks"
      contains: "game.animate"
    - path: "~/BoardSmithGames/demo-animation/src/ui/components/GameTable.vue"
      provides: "Updated reference text (no mention of emitAnimationEvent)"
    - path: "~/BoardSmithGames/CLAUDE.md"
      provides: "Updated documentation referencing game.animate()"
  key_links:
    - from: "~/BoardSmithGames/cribbage/src/rules/game.ts"
      to: "boardsmith Game.animate()"
      via: "method call"
      pattern: "game\\.animate\\("
    - from: "~/BoardSmithGames/demo-animation/src/rules/actions.ts"
      to: "boardsmith Game.animate()"
      via: "method call"
      pattern: "game\\.animate\\("
---

<objective>
Migrate the demo-animation and cribbage example games from `emitAnimationEvent()` to `game.animate()`, then verify animations play correctly in the browser.

Purpose: Example games are the reference implementations that game developers learn from. They must demonstrate the current best API (`game.animate()`) -- not the removed one. This validates the full stack end-to-end: engine -> session -> UI.

Output: Both games compile, run, and animate correctly using `game.animate()`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-clean-break-and-migration/84-RESEARCH.md
@~/BoardSmithGames/demo-animation/src/rules/actions.ts
@~/BoardSmithGames/demo-animation/src/ui/components/GameTable.vue
@~/BoardSmithGames/cribbage/src/rules/game.ts
@~/BoardSmithGames/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate demo-animation and cribbage to game.animate()</name>
  <files>
    ~/BoardSmithGames/demo-animation/src/rules/actions.ts
    ~/BoardSmithGames/demo-animation/src/ui/components/GameTable.vue
    ~/BoardSmithGames/cribbage/src/rules/game.ts
    ~/BoardSmithGames/CLAUDE.md
    ~/BoardSmithGames/.planning/codebase/ARCHITECTURE.md
  </files>
  <action>
    **Demo-animation migration (1 call site):**

    In `~/BoardSmithGames/demo-animation/src/rules/actions.ts`, the `createAnimationEventAction` function (around line 336):

    Change:
    ```typescript
    game.emitAnimationEvent('demo', {
      cardId: card.id,
      cardName: card.name,
      message: `Animation event for ${card.rank}${card.suit}`,
      rank: card.rank,
      suit: card.suit,
    });
    ```
    To:
    ```typescript
    game.animate('demo', {
      cardId: card.id,
      cardName: card.name,
      message: `Animation event for ${card.rank}${card.suit}`,
      rank: card.rank,
      suit: card.suit,
    }, () => {
      // Pure UI signal -- no state mutations
    });
    ```

    Also update the JSDoc comment above `createAnimationEventAction` (around line 307-314) to reference `game.animate()` instead of `emitAnimationEvent`.

    In `~/BoardSmithGames/demo-animation/src/ui/components/GameTable.vue`:
    - Line 71 comment: change "populated by game.emitAnimationEvent" to "populated by game.animate()"
    - Line 766 reference table text: change "via game.emitAnimationEvent()" to "via game.animate()"

    **Cribbage migration (9 call sites):**

    In `~/BoardSmithGames/cribbage/src/rules/game.ts`, the `scoreRoundAndBuildSummary()` method has 3 scoring sections (non-dealer hand, dealer hand, crib). Each section has 3 event types:

    1. `score-hand-start` -- pure UI signal, use empty callback
    2. `score-item` (in loop) -- pure UI signal, use empty callback
    3. `score-hand-complete` -- wrap the `addPoints()` call (and the "No points" message) INSIDE the animate callback

    **Non-dealer hand section (around lines 606-644):**

    Replace:
    ```typescript
    this.emitAnimationEvent('score-hand-start', { source: 'nonDealerHand', ... });
    ```
    With:
    ```typescript
    game.animate('score-hand-start', { source: 'nonDealerHand', ... }, () => {});
    ```

    Replace the score-item loop:
    ```typescript
    this.emitAnimationEvent('score-item', { source: 'nonDealerHand', ... });
    ```
    With:
    ```typescript
    game.animate('score-item', { source: 'nonDealerHand', ... }, () => {});
    ```

    Replace score-hand-complete AND wrap the addPoints call:
    ```typescript
    // BEFORE:
    this.emitAnimationEvent('score-hand-complete', { source: 'nonDealerHand', playerName: nonDealer.name, total: nonDealerScore.total });
    if (nonDealerScore.total > 0) {
      this.addPoints(nonDealer, nonDealerScore.total, 'Hand');
    } else {
      this.message('  No points');
    }

    // AFTER:
    game.animate('score-hand-complete', {
      source: 'nonDealerHand',
      playerName: nonDealer.name,
      total: nonDealerScore.total,
    }, () => {
      if (nonDealerScore.total > 0) {
        this.addPoints(nonDealer, nonDealerScore.total, 'Hand');
      } else {
        this.message('  No points');
      }
    });
    ```

    **CRITICAL: Preserve the win-check order.** The `if (this.isFinished()) return` check MUST remain AFTER the `animate()` call that contains `addPoints()`. Since `animate()` executes synchronously, the addPoints inside the callback runs immediately, so `isFinished()` will see the updated score. The existing control flow (animate -> check win -> next section) is preserved naturally.

    Apply the same pattern to the **dealer hand section** (around lines 652-701) and **crib section** (around lines 703-751). The crib section also has `this.crib.contentsVisible()` before the events -- leave that call BEFORE the animate calls (it's not part of any animation event).

    Note: In `scoreRoundAndBuildSummary()`, `this` is the CribbageGame instance which extends Game. Use `this.animate()` (not `game.animate()`) since the method is on the Game class and we're inside a method. Actually, check how the existing code calls it -- if it uses `this.emitAnimationEvent()`, then use `this.animate()`. If it references a local `game` variable, use `game.animate()`.

    Also update the JSDoc comment on `scoreRoundAndBuildSummary()` (around line 593-595) to reference `game.animate()` instead of "animation events".

    **Documentation updates:**

    In `~/BoardSmithGames/CLAUDE.md`:
    - Line 46: Change `emitAnimationEvent()` to `game.animate()`
    - Line 85: Change `emitAnimationEvent()` to `game.animate()`

    In `~/BoardSmithGames/.planning/codebase/ARCHITECTURE.md`:
    - Line 142: Change `game.emitAnimationEvent()` to `game.animate()`

    **Verification:**

    After all changes:
    1. Run `npx tsc --noEmit` in `~/BoardSmithGames/demo-animation/` -- must pass
    2. Run `npx tsc --noEmit` in `~/BoardSmithGames/cribbage/` -- must pass
    3. `grep -r "emitAnimationEvent" ~/BoardSmithGames/` returns zero matches
  </action>
  <verify>
    `grep -r "emitAnimationEvent" ~/BoardSmithGames/` returns zero matches.
    `npx tsc --noEmit` passes in both `~/BoardSmithGames/demo-animation/` and `~/BoardSmithGames/cribbage/`.
  </verify>
  <done>
    All 10 `emitAnimationEvent` call sites migrated to `game.animate()` across demo-animation (1) and cribbage (9). Documentation references updated. Both games compile cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Migrated demo-animation and cribbage games from emitAnimationEvent() to game.animate(). The demo game has 1 call site (pure UI signal), and cribbage has 9 call sites across 3 scoring sections where addPoints() is now wrapped inside animate() callbacks.</what-built>
  <how-to-verify>
    1. Start the demo-animation game:
       ```
       cd ~/BoardSmithGames/demo-animation && npx boardsmith dev
       ```
    2. Open the game in browser. Click the "Animation Event" button, select a card.
    3. Verify the animation toast appears showing the card info (plays for 5 seconds).
    4. Stop the demo server.

    5. Start the cribbage game:
       ```
       cd ~/BoardSmithGames/cribbage && npx boardsmith dev
       ```
    6. Open the game in browser. Play through to the scoring phase (deal, discard 2 cards each, play cards, then scoring begins).
    7. Verify scoring animations play: score-hand-start events trigger, individual score-item events appear, score-hand-complete events award points correctly.
    8. Verify the score updates correctly (non-dealer hand first, then dealer hand, then crib).
    9. Verify no console errors.
    10. Stop the cribbage server.
  </how-to-verify>
  <resume-signal>Type "approved" if both games animate correctly, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `grep -r "emitAnimationEvent" ~/BoardSmithGames/` returns zero matches
2. Demo-animation compiles: `cd ~/BoardSmithGames/demo-animation && npx tsc --noEmit` exits 0
3. Cribbage compiles: `cd ~/BoardSmithGames/cribbage && npx tsc --noEmit` exits 0
4. Demo animation event plays correctly in browser
5. Cribbage scoring animations play correctly in browser with correct point totals
</verification>

<success_criteria>
- Zero references to `emitAnimationEvent` in `~/BoardSmithGames/`
- Both games compile with `tsc --noEmit`
- Demo animation event toast appears and plays for 5 seconds
- Cribbage scoring shows animated reveal of each combination with correct point totals
- Win detection still works (non-dealer scoring first can end the game before dealer scores)
</success_criteria>

<output>
After completion, create `.planning/phases/84-clean-break-and-migration/84-02-SUMMARY.md`
</output>
