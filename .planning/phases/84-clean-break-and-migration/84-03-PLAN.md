---
phase: 84-clean-break-and-migration
plan: 03
type: execute
wave: 2
depends_on: ["84-01"]
files_modified:
  - BREAKING.md
  - docs/ui-components.md
  - docs/nomenclature.md
autonomous: true

must_haves:
  truths:
    - "BREAKING.md documents the emitAnimationEvent to animate() migration with before/after examples"
    - "docs/ui-components.md shows game.animate() as the animation API with theatre view concepts"
    - "docs/nomenclature.md reflects game.animate(), theatre view, and current view terminology"
    - "No documentation references emitAnimationEvent as a current API"
  artifacts:
    - path: "BREAKING.md"
      provides: "v2.9 migration guide for emitAnimationEvent removal"
      contains: "game.animate"
      min_lines: 30
    - path: "docs/ui-components.md"
      provides: "Animation Events section rewritten for game.animate() and theatre view"
      contains: "game.animate"
    - path: "docs/nomenclature.md"
      provides: "Updated Animation Event entry plus Theatre View and Current View entries"
      contains: "game.animate"
  key_links:
    - from: "BREAKING.md"
      to: "docs/ui-components.md"
      via: "cross-reference"
      pattern: "ui-components"
    - from: "docs/nomenclature.md"
      to: "docs/ui-components.md"
      via: "related documentation link"
      pattern: "ui-components"
---

<objective>
Create BREAKING.md with the v2.9 migration guide and update all documentation to reflect `game.animate()` and theatre view concepts.

Purpose: Documentation is part of the shippable release. Game developers migrating from the old API need a clear before/after guide. New developers should learn the current API as the only API. The theatre view concepts from phases 80-83 have no documentation yet -- this plan adds them.

Output: BREAKING.md exists with migration instructions. ui-components.md and nomenclature.md reflect the current animation API and theatre view system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-clean-break-and-migration/84-RESEARCH.md
@docs/ui-components.md
@docs/nomenclature.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BREAKING.md with v2.9 migration guide</name>
  <files>BREAKING.md</files>
  <action>
    Create `BREAKING.md` at the project root. This is a new file (does not exist yet).

    Structure:
    ```markdown
    # Breaking Changes

    ## v2.9 -- Theatre View

    ### `emitAnimationEvent()` removed

    The fire-and-forget `emitAnimationEvent()` method has been replaced by `game.animate()`, a scoped-callback API that captures mutations for the theatre view system.

    **Before (v2.8):**
    [code example showing emitAnimationEvent with separate state mutations]

    **After (v2.9):**
    [code example showing game.animate() wrapping mutations in callback]

    ### Migration checklist
    [Numbered steps: find calls, wrap mutations, handle pure UI signals, run tsc]

    ### Pure UI signals (no mutations)
    [Show empty callback pattern for events that don't change state]

    ### Theatre view (new concept)
    [Brief explanation: animate() captures mutations, theatre state shows pre-animation snapshot, acknowledging advances theatre state]

    ### What changed in AnimationEvent
    [mutations field is now always present (array, possibly empty)]
    ```

    Include these specific code examples from the research:

    1. **Basic migration** -- combat example showing state mutations moving inside the callback
    2. **Pure UI signal** -- empty callback pattern for events that only signal the UI
    3. **Scoring pattern** -- cribbage-style example where addPoints() moves inside the final animate() callback

    Keep the tone direct and practical. No fluff -- just what changed, before/after, and how to migrate.

    Also add a "Removed types" section noting that `EmitAnimationEventOptions` was removed. The `group` option on animate events is no longer available -- if developers need grouping, they can use the event `type` field with a naming convention.
  </action>
  <verify>
    File exists: `BREAKING.md`
    Contains: "emitAnimationEvent", "game.animate", before/after code blocks, migration checklist
    Does NOT present emitAnimationEvent as a current/valid API -- only as the thing being replaced
  </verify>
  <done>
    BREAKING.md exists at project root with v2.9 migration guide covering: API removal rationale, before/after examples for basic migration, pure UI signals, scoring pattern, removed types, and theatre view explanation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ui-components.md and nomenclature.md</name>
  <files>
    docs/ui-components.md
    docs/nomenclature.md
  </files>
  <action>
    **docs/ui-components.md:**

    Rewrite the "Engine-Side: Emitting Events" section (around lines 1102-1150). This section currently shows `game.emitAnimationEvent()` with examples and a parameters table.

    Replace with content covering:

    1. **`game.animate()` API** -- the scoped-callback method:
       ```typescript
       game.animate('combat', {
         attackerId: attacker.id,
         targetId: target.id,
         damage,
       }, () => {
         target.health -= damage;
         if (target.health <= 0) {
           target.putInto(this.graveyard);
         }
       });
       ```

    2. **Parameters table** (updated):
       | Parameter | Type | Description |
       | `type` | `string` | Event type identifier |
       | `data` | `Record<string, unknown>` | Event-specific payload (JSON-serializable) |
       | `callback` | `() => void` | Synchronous callback -- mutations inside are captured for theatre view |

    3. **Mutation capture** -- explain that element operations (putInto, create, remove) and property changes inside the callback are automatically recorded as `CapturedMutation[]` on the event. These mutations drive the theatre view system.

    4. **Theatre view concept** -- brief explanation: after `animate()` runs, the game state has already advanced (mutations applied immediately), but the theatre state holds a pre-animation snapshot. As clients acknowledge events, the theatre state advances one event at a time, so UI components never show "the future" while animations play.

    5. **Empty callbacks for pure UI signals:**
       ```typescript
       game.animate('score-reveal', { playerId: player.id, total: 42 }, () => {
         // Pure UI signal -- no state changes
       });
       ```

    6. **No nesting** -- `animate()` throws if called inside another `animate()` callback. Each event must be a separate call.

    Remove the "Grouped events" example that showed `{ group: groupId }` -- the group option no longer exists.

    Also update the "Key Concepts" section at the top of the Animation Events block (around lines 1092-1100). The current text says "animation events are UI hints, NOT commands or state mutations" and mentions "soft continuation." Update to reflect that `animate()` DOES capture mutations (they're still applied immediately, but captured for theatre view). The soft continuation concept still applies -- state advances immediately. But the key difference is mutations inside the callback are recorded.

    **docs/nomenclature.md:**

    1. Update the "Animation Event" entry (around line 432):
       - Change `**In Code:** \`AnimationEvent\` interface; \`game.emitAnimationEvent()\` method`
         to `**In Code:** \`AnimationEvent\` interface; \`game.animate()\` method`
       - Update the definition to mention mutation capture: "A structured event emitted during game execution via `game.animate()` that captures state mutations and flows to UI consumers for asynchronous playback."
       - Update the Related Terms to include "Theatre View, Current View, Mutation Capture"

    2. Update the "Soft Continuation" entry (around line 449):
       - Keep the definition but update the usage example to mention theatre view: "The theatre view renders the pre-animation state while the truth has already advanced"

    3. Add THREE new entries to the Animation section (after "Soft Continuation", before the `---` divider):

       **Theatre View:**
       - Definition: The frozen snapshot of game state shown to players during animation playback. Starts as a copy of game state when the first `animate()` call occurs, then advances one event at a time as animations are acknowledged.
       - In Code: `game.theatreState` getter; `game.acknowledgeAnimationEvents(upToId)` method
       - Related Terms: Current View, Animation Event, Mutation Capture
       - Usage examples

       **Current View:**
       - Definition: The real, up-to-date game state available as an opt-in for components that need truth (AI controllers, post-game summaries). While theatre view shows "what the player has seen so far," current view shows "what actually happened."
       - In Code: `useCurrentView()` composable; `currentView` field in `PlayerGameState`
       - Related Terms: Theatre View, Animation Event
       - Usage examples

       **Mutation Capture:**
       - Definition: The system that automatically records element operations (moves, creates, removals) and property changes made inside a `game.animate()` callback. Captured mutations drive the theatre view advancement system.
       - In Code: `CapturedMutation` type; `MutationCaptureContext` on `Game`
       - Related Terms: Theatre View, Animation Event
       - Usage examples

    4. Update the Quick Reference table at the top to add Theatre View, Current View, and Mutation Capture entries.
  </action>
  <verify>
    `grep "emitAnimationEvent" docs/ui-components.md docs/nomenclature.md` returns zero matches (the old API name should not appear as a current API reference).
    `grep "game.animate" docs/ui-components.md` returns at least 3 matches.
    `grep "Theatre View" docs/nomenclature.md` returns at least 2 matches.
    `grep "Current View" docs/nomenclature.md` returns at least 2 matches.
    `grep "Mutation Capture" docs/nomenclature.md` returns at least 2 matches.
  </verify>
  <done>
    ui-components.md Animation Events section rewritten to show game.animate() with mutation capture, theatre view explanation, empty callback pattern, and no-nesting rule. nomenclature.md updated with game.animate() reference plus three new entries: Theatre View, Current View, Mutation Capture.
  </done>
</task>

</tasks>

<verification>
1. `BREAKING.md` exists and contains migration guide with before/after examples
2. `docs/ui-components.md` shows `game.animate()` as the animation API (no `emitAnimationEvent` as current API)
3. `docs/nomenclature.md` has entries for Theatre View, Current View, and Mutation Capture
4. `grep -r "emitAnimationEvent" docs/ BREAKING.md` -- only appears in BREAKING.md as the "removed API" reference, not as current documentation
</verification>

<success_criteria>
- BREAKING.md exists with v2.9 section containing before/after migration examples
- ui-components.md Animation Events section uses game.animate() exclusively
- nomenclature.md defines Theatre View, Current View, and Mutation Capture
- No documentation file references emitAnimationEvent as a current/working API
</success_criteria>

<output>
After completion, create `.planning/phases/84-clean-break-and-migration/84-03-SUMMARY.md`
</output>
