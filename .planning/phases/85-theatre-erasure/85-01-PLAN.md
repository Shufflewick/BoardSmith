---
phase: 85-theatre-erasure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/element/theatre-state.ts
  - src/engine/element/mutation-capture.ts
  - src/engine/element/game.ts
  - src/engine/element/game-element.ts
  - src/engine/element/piece.ts
  - src/engine/element/index.ts
  - src/engine/index.ts
  - src/engine/element/theatre-state.test.ts
  - src/engine/element/mutation-capture.test.ts
  - src/engine/element/animation-events.test.ts
autonomous: true

must_haves:
  truths:
    - "Theatre state types (CapturedMutation, MutationCaptureContext) no longer exist in the codebase"
    - "Game class has no theatre properties (_theatreSnapshot, _captureContext, theatreState, theatreStateForPlayer)"
    - "animate() method is removed from Game"
    - "Animation event infrastructure (_animationEvents, pendingAnimationEvents, AnimationEvent type) is preserved without mutation fields"
    - "acknowledgeAnimationEvents() on Game is simplified to buffer clearing only (no theatre mutation application)"
  artifacts:
    - path: "src/engine/element/theatre-state.ts"
      provides: "DELETED"
    - path: "src/engine/element/mutation-capture.ts"
      provides: "DELETED"
    - path: "src/engine/element/theatre-state.test.ts"
      provides: "DELETED"
    - path: "src/engine/element/mutation-capture.test.ts"
      provides: "DELETED"
    - path: "src/engine/element/animation-events.test.ts"
      provides: "DELETED"
    - path: "src/engine/element/game.ts"
      provides: "Game class without theatre code"
    - path: "src/engine/element/index.ts"
      provides: "Clean exports without theatre/mutation-capture re-exports"
    - path: "src/engine/index.ts"
      provides: "Clean re-exports without CapturedMutation types or applyMutation functions"
  key_links:
    - from: "src/engine/element/game.ts"
      to: "theatre-state.ts / mutation-capture.ts"
      via: "imports removed"
      pattern: "no import.*theatre-state|mutation-capture"
    - from: "src/engine/element/game-element.ts"
      to: "game._captureContext"
      via: "_captureContext block removed from create()"
      pattern: "no _captureContext"
    - from: "src/engine/element/piece.ts"
      to: "game._captureContext"
      via: "_captureContext block removed from putInto()"
      pattern: "no _captureContext"
---

<objective>
Delete all theatre view, mutation capture, and related code from the engine layer. This removes the foundation that the rest of the codebase depends on -- theatre types, snapshot properties, mutation capture machinery, and the old animate() method. The animation event buffer infrastructure is preserved (without mutation fields) for Phase 86 to rebuild on.

Purpose: The engine is Layer 1 of the theatre system. All other layers (session, server, client, UI) import types and call methods that live here. Removing the engine theatre code first creates TypeScript errors everywhere that references it, which subsequent plans will fix layer by layer.

Output: Engine compiles with `tsc --noEmit` (engine only). Theatre/mutation files deleted. Game class stripped. Export chains cleaned.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/85-theatre-erasure/85-RESEARCH.md

@src/engine/element/game.ts
@src/engine/element/theatre-state.ts
@src/engine/element/mutation-capture.ts
@src/engine/element/game-element.ts
@src/engine/element/piece.ts
@src/engine/element/index.ts
@src/engine/index.ts
@src/engine/element/animation-events.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete theatre files and strip Game class</name>
  <files>
    src/engine/element/theatre-state.ts
    src/engine/element/mutation-capture.ts
    src/engine/element/game.ts
    src/engine/element/game-element.ts
    src/engine/element/piece.ts
  </files>
  <action>
    **Delete entire files:**
    - `src/engine/element/theatre-state.ts` (159 lines -- applicators, tree helpers, mutation dispatcher)
    - `src/engine/element/mutation-capture.ts` (79 lines -- CapturedMutation types, MutationCaptureContext interface)

    **Strip `src/engine/element/game.ts`:**
    Remove ALL of these (see research for exact line numbers, but use search to find current positions):

    1. Imports from `theatre-state.js` and `mutation-capture.js` (search for `import.*theatre-state` and `import.*mutation-capture`)
    2. `mutations` field on the `AnimationEvent` interface (search `mutations?: CapturedMutation[]`) -- KEEP the rest of the AnimationEvent interface
    3. `_theatreSnapshot` property declaration (search `_theatreSnapshot`)
    4. `_captureContext` property declaration (search `_captureContext`)
    5. `'_captureContext'` and `'_theatreSnapshot'` from `_safeProperties` array
    6. `'_captureContext'` and `'_theatreSnapshot'` from `unserializableAttributes` array
    7. `animate()` method ENTIRELY (search `animate(` -- the method that does mutation capture, property diffing, element attribute diffing)
    8. `_snapshotCustomProperties()` private method
    9. `_diffCustomProperties()` private method
    10. `_snapshotElementAttributes()` private method
    11. `_diffElementAttributes()` private method
    12. `theatreState` getter (search `get theatreState`)
    13. `theatreStateForPlayer()` method (large method ~130 lines)
    14. `acknowledgeAnimationEvents()` -- REWRITE to just buffer clearing:
        ```typescript
        acknowledgeAnimationEvents(upToId: number): void {
          this._animationEvents = this._animationEvents.filter(e => e.id > upToId);
        }
        ```
        Remove ALL theatre snapshot logic (applyMutations, _theatreSnapshot checks, _theatreSnapshot = null)
    15. `theatreSnapshot` from `toJSON()` return -- search for `theatreSnapshot` in toJSON, remove the conditional spread
    16. Theatre snapshot restoration from `restoreGame()` -- search for `theatreSnapshot` in restoreGame, remove

    **KEEP these (for Phase 86):**
    - `_animationEvents` property (the buffer array)
    - `_animationEventSeq` property (the sequence counter)
    - `pendingAnimationEvents` getter
    - `AnimationEvent` interface (without mutations field)
    - Animation event serialization in toJSON() (animationEvents, animationEventSeq)
    - Animation event restoration in restoreGame()
    - The simplified `acknowledgeAnimationEvents()` (buffer clearing only)

    **Strip `src/engine/element/game-element.ts`:**
    Remove the `_captureContext` block in the `create()` method (search for `_captureContext` -- it is an `if (this.game._captureContext)` block that records CREATE mutations, approximately 20 lines)

    **Strip `src/engine/element/piece.ts`:**
    Remove the `_captureContext` block in the `putInto()` method (search for `_captureContext` -- it is an `if (this.game._captureContext)` block that records MOVE mutations, approximately 10 lines)
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | head -50` -- expect TypeScript errors ONLY in files OUTSIDE the engine (session, server, client, UI). The engine itself should have zero errors. If engine files still have errors, fix them.

    Verify deletions with grep:
    - `grep -r "_captureContext" src/engine/` returns nothing
    - `grep -r "theatreSnapshot" src/engine/` returns nothing
    - `grep -r "theatreState" src/engine/` returns nothing
    - `grep -r "mutation-capture" src/engine/` returns nothing (no imports)
    - `grep -r "theatre-state" src/engine/` returns nothing (no imports)
    - `ls src/engine/element/theatre-state.ts` fails (file gone)
    - `ls src/engine/element/mutation-capture.ts` fails (file gone)
  </verify>
  <done>
    Theatre source files deleted. Game class stripped of all theatre properties, methods, and imports. Only animation event buffer infrastructure remains (without mutation fields). game-element.ts and piece.ts capture context hooks removed. Engine directory has zero references to theatre, captureContext, or mutation capture.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean export chains and delete engine tests</name>
  <files>
    src/engine/element/index.ts
    src/engine/index.ts
    src/engine/element/theatre-state.test.ts
    src/engine/element/mutation-capture.test.ts
    src/engine/element/animation-events.test.ts
  </files>
  <action>
    **Clean `src/engine/element/index.ts`:**
    Remove these export lines (search for each):
    - `export type { CapturedMutation, CreateMutation, MoveMutation, SetAttributeMutation, SetPropertyMutation, MutationCaptureContext } from './mutation-capture.js'`
    - `export { applyMutation, applyMutations, findElementById, removeElementFromParent } from './theatre-state.js'`

    **Clean `src/engine/index.ts`:**
    Remove these re-export lines (search for each):
    - All re-exports of CapturedMutation, CreateMutation, MoveMutation, SetAttributeMutation, SetPropertyMutation, MutationCaptureContext (type re-exports)
    - All re-exports of applyMutation, applyMutations, findElementById, removeElementFromParent (function re-exports)

    Be careful to only remove the specific lines referencing these deleted items. Do NOT accidentally remove neighboring export lines.

    **Delete test files entirely:**
    - `src/engine/element/theatre-state.test.ts` (1057 lines -- all theatre state tests)
    - `src/engine/element/mutation-capture.test.ts` (569 lines -- all mutation capture tests)
    - `src/engine/element/animation-events.test.ts` (199 lines -- all tests use game.animate() which is removed; Phase 86 rebuilds)
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | head -80` -- verify no NEW errors introduced by bad export cleanup. Errors should only be in session/, server/, client/, ui/ files referencing removed APIs.

    Verify:
    - `grep -r "mutation-capture" src/engine/element/index.ts src/engine/index.ts` returns nothing
    - `grep -r "theatre-state" src/engine/element/index.ts src/engine/index.ts` returns nothing
    - `grep -r "CapturedMutation\|applyMutation\|findElementById\|removeElementFromParent\|MutationCaptureContext" src/engine/index.ts` returns nothing
    - `ls src/engine/element/theatre-state.test.ts` fails
    - `ls src/engine/element/mutation-capture.test.ts` fails
    - `ls src/engine/element/animation-events.test.ts` fails
  </verify>
  <done>
    Export chains cleaned -- no engine barrel file references deleted theatre/mutation-capture modules. Three test files deleted (theatre-state, mutation-capture, animation-events). Engine layer is fully clean of theatre code.
  </done>
</task>

</tasks>

<verification>
- `grep -r "theatre\|Theatre\|_captureContext\|MutationCapture\|CapturedMutation" src/engine/` returns zero results
- `ls src/engine/element/theatre-state.ts src/engine/element/mutation-capture.ts 2>&1` shows both files missing
- `ls src/engine/element/theatre-state.test.ts src/engine/element/mutation-capture.test.ts src/engine/element/animation-events.test.ts 2>&1` shows all three test files missing
- `npx tsc --noEmit 2>&1 | grep "src/engine/"` returns zero engine-specific errors
- `AnimationEvent` interface still exists in game.ts but WITHOUT mutations field
- `_animationEvents`, `pendingAnimationEvents`, `acknowledgeAnimationEvents` still exist in game.ts
</verification>

<success_criteria>
1. Zero theatre-related code in the engine directory
2. Export chains (element/index.ts, engine/index.ts) are clean
3. Three test files deleted, two source files deleted
4. Animation event buffer infrastructure preserved (without mutation fields)
5. Engine compiles cleanly (only downstream modules have errors)
</success_criteria>

<output>
After completion, create `.planning/phases/85-theatre-erasure/85-01-SUMMARY.md`
</output>
