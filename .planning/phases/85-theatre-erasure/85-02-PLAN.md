---
phase: 85-theatre-erasure
plan: 02
type: execute
wave: 2
depends_on: ["85-01"]
files_modified:
  - src/session/game-session.ts
  - src/session/utils.ts
  - src/session/types.ts
  - src/server/core.ts
  - src/session/animation-events.test.ts
autonomous: true

must_haves:
  truths:
    - "GameSession.acknowledgeAnimations() method no longer exists"
    - "buildPlayerState() produces a single view field using toJSONForPlayer() -- no theatre/currentView split"
    - "acknowledgeAnimations WebSocket message case is removed from server"
    - "Session types no longer reference currentView or acknowledgeAnimations"
    - "Session animation tests pass without theatre-view tests"
  artifacts:
    - path: "src/session/game-session.ts"
      provides: "GameSession without acknowledgeAnimations method"
    - path: "src/session/utils.ts"
      provides: "buildPlayerState using toJSONForPlayer directly"
    - path: "src/session/types.ts"
      provides: "PlayerGameState without currentView, WebSocketMessage without acknowledgeAnimations"
    - path: "src/server/core.ts"
      provides: "Server without acknowledgeAnimations handler"
    - path: "src/session/animation-events.test.ts"
      provides: "Tests without theatre-view section"
  key_links:
    - from: "src/session/utils.ts"
      to: "runner.game.toJSONForPlayer()"
      via: "buildPlayerState calls toJSONForPlayer directly"
      pattern: "toJSONForPlayer"
    - from: "src/server/core.ts"
      to: "acknowledgeAnimations"
      via: "case removed from switch"
      pattern: "no acknowledgeAnimations"
---

<objective>
Remove all theatre acknowledgment code from the session and server layers. The session no longer tracks animation playback (no acknowledgeAnimations method), buildPlayerState sends truth as the only view (no theatre/currentView split), and the server no longer accepts acknowledgeAnimations WebSocket messages.

Purpose: The session layer was the primary consumer of theatre state -- it called theatreStateForPlayer() to build player views and managed the acknowledge protocol. With engine theatre code gone (Plan 01), these call sites now reference nonexistent methods. This plan fixes all session and server compile errors.

Output: Session and server compile cleanly with `tsc --noEmit`. Session animation-events tests pass.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/85-theatre-erasure/85-RESEARCH.md

@src/session/game-session.ts
@src/session/utils.ts
@src/session/types.ts
@src/server/core.ts
@src/session/animation-events.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove acknowledgeAnimations from session and server</name>
  <files>
    src/session/game-session.ts
    src/session/types.ts
    src/server/core.ts
  </files>
  <action>
    **`src/session/game-session.ts`:**
    Remove the `acknowledgeAnimations()` method entirely (search for `acknowledgeAnimations` -- it is a method that delegates to the runner's game). Remove the entire method, not just the body.

    **`src/session/types.ts`:**
    1. Remove `currentView` field from `PlayerGameState` interface (search `currentView` -- it is an optional field with a comment about truth view during animation)
    2. Remove `acknowledgeAnimations` from the WebSocket message union type (search `acknowledgeAnimations` in the message type -- it has a `type: 'acknowledgeAnimations'` member with `upToId` field). Remove the entire union member.

    **`src/server/core.ts`:**
    Remove the `case 'acknowledgeAnimations':` block from the WebSocket message handler switch statement (search `acknowledgeAnimations` -- it is a case block approximately 18 lines that validates the message, calls session.acknowledgeAnimations(), and broadcasts). Remove the entire case including break.
  </action>
  <verify>
    - `grep -r "acknowledgeAnimations" src/session/ src/server/` returns zero results
    - `grep "currentView" src/session/types.ts` returns zero results
    - Run `npx tsc --noEmit 2>&1 | grep -E "src/(session|server)/"` -- expect zero errors in session and server files
  </verify>
  <done>
    Session and server have zero references to acknowledgeAnimations or currentView. The acknowledge protocol is fully removed from the server-side.
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify buildPlayerState and fix session tests</name>
  <files>
    src/session/utils.ts
    src/session/animation-events.test.ts
  </files>
  <action>
    **`src/session/utils.ts` -- Simplify buildPlayerState():**
    Find `buildPlayerState` function (search for it). The function currently:
    1. Calls `runner.game.theatreStateForPlayer(playerPosition)` to get the theatre view
    2. Computes `currentView` from `runner.getPlayerView(playerPosition).state` when animations pending
    3. Returns both `view` (theatre) and `currentView` (truth) on `PlayerGameState`

    Replace with:
    1. Call `runner.getPlayerView(playerPosition).state` to get the truth view directly
    2. Set `view` to this truth value
    3. Remove all `currentView` computation and the conditional spread
    4. Remove any `theatreStateForPlayer` call
    5. Remove any `hasPendingAnimations` check for currentView computation

    The result should be simpler: `view` is truth, always. No conditional logic around theatre vs current.

    **`src/session/animation-events.test.ts` -- Remove theatre tests:**
    Read the file first. It has two major sections:
    1. First half: `Session Animation Events` -- tests basic animation event lifecycle (buildPlayerState animation fields, etc.)
    2. Second half: `Theatre view in PlayerGameState` -- tests theatre view, currentView, acknowledge advancement

    DELETE the entire "Theatre view in PlayerGameState" describe block and all tests within it.

    For the first half ("Session Animation Events"):
    - Keep tests that verify animation events appear in buildPlayerState output
    - Remove any tests that reference `acknowledgeAnimations`, `currentView`, or `theatreStateForPlayer`
    - If tests call `game.animate()` which was removed in Plan 01, those tests must also be removed (Phase 86 will rebuild)
    - Be careful: read the tests to see if they use `game.animate()` directly. If they do, they are dead and should be removed.

    If ALL tests in the file depend on `game.animate()`, delete the entire file. Phase 86 rebuilds session animation tests.
  </action>
  <verify>
    - `grep -r "theatreStateForPlayer\|theatreState\|currentView" src/session/utils.ts` returns zero results
    - `grep -r "Theatre view\|currentView\|theatreState" src/session/animation-events.test.ts 2>/dev/null` returns zero results (or file is deleted)
    - Run `npx tsc --noEmit 2>&1 | grep "src/session/"` -- expect zero session errors
    - Run `npx vitest run src/session/ 2>&1 | tail -10` -- all remaining session tests pass
  </verify>
  <done>
    buildPlayerState produces a single truth view. No theatre/currentView split. Session animation tests are cleaned of theatre references (or deleted if all depended on animate()). Session layer compiles and all tests pass.
  </done>
</task>

</tasks>

<verification>
- `grep -r "theatre\|Theatre\|acknowledgeAnimations\|currentView" src/session/ src/server/` returns zero results (excluding comments about the migration)
- `npx tsc --noEmit 2>&1 | grep -E "src/(session|server)/"` returns zero errors
- `npx vitest run src/session/ 2>&1` -- all remaining session tests pass
- buildPlayerState returns a PlayerGameState with `view` as truth (no currentView field)
</verification>

<success_criteria>
1. acknowledgeAnimations method removed from GameSession
2. acknowledgeAnimations WebSocket handler removed from server
3. buildPlayerState uses toJSONForPlayer/getPlayerView for truth (no theatreStateForPlayer)
4. currentView removed from PlayerGameState type
5. Session and server compile cleanly
6. All remaining session tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/85-theatre-erasure/85-02-SUMMARY.md`
</output>
