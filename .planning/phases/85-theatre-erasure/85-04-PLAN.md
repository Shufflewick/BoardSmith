---
phase: 85-theatre-erasure
plan: 04
type: execute
wave: 3
depends_on: ["85-02", "85-03"]
files_modified:
  - BREAKING.md
autonomous: true

must_haves:
  truths:
    - "BREAKING.md exists at repo root documenting every removed API"
    - "Each removed API has a migration pattern (before v2.9 / after v3.0)"
    - "Full test suite passes with zero failures"
    - "tsc --noEmit passes with zero errors"
    - "No references to theatre, captureContext, or mutation capture remain in src/"
  artifacts:
    - path: "BREAKING.md"
      provides: "Complete migration guide for v3.0 theatre removal"
      min_lines: 80
  key_links:
    - from: "BREAKING.md"
      to: "removed APIs"
      via: "documents every API from research inventory"
      pattern: "theatreState|theatreStateForPlayer|acknowledgeAnimationEvents|MutationCaptureContext|CapturedMutation|useCurrentView|CURRENT_VIEW_KEY"
---

<objective>
Create BREAKING.md documenting all removed APIs with migration paths, then run full verification to confirm the theatre erasure is complete -- zero compile errors, all remaining tests pass, no theatre references survive in source code.

Purpose: This is the final plan in the phase. It confirms the deletion is complete across all layers and produces the required documentation (DOC-01 requirement). The BREAKING.md serves as the migration guide that Phase 90 will reference and expand.

Output: BREAKING.md at repo root. Full green build (tsc + vitest). Clean grep confirming zero theatre references.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/85-theatre-erasure/85-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BREAKING.md</name>
  <files>BREAKING.md</files>
  <action>
    Create `BREAKING.md` at the repo root with the following structure. Use the research inventory (85-RESEARCH.md "BREAKING.md Template" section) as the basis, but ensure EVERY removed API from the research inventory is documented.

    Structure:
    ```
    # Breaking Changes

    ## v3.0 - Animation Timeline

    ### Removed: Theatre View System

    Brief description: The server-side theatre view system has been removed.
    Animation playback is now 100% client-owned.

    #### Removed APIs

    Table listing EVERY removed API:
    | API | Module | Replacement |
    |-----|--------|-------------|
    Include ALL of these (from research):
    - game.theatreState (engine) -> game.toJSON()
    - game.theatreStateForPlayer(seat) (engine) -> game.toJSONForPlayer(seat)
    - game.acknowledgeAnimationEvents(id) (engine) -> No replacement
    - game._captureContext (engine) -> Removed
    - game.animate() (engine) -> Rebuilt in v3.0 as pure data emitter
    - GameSession.acknowledgeAnimations() (session) -> Removed
    - acknowledgeAnimations WebSocket message (server) -> Removed
    - GameConnection.acknowledgeAnimations() (client) -> Removed
    - useCurrentView() (ui) -> Use gameView from GameShell
    - CURRENT_VIEW_KEY (ui) -> Removed
    - CapturedMutation type (engine) -> Removed
    - MutationCaptureContext type (engine) -> Removed
    - applyMutation() (engine) -> Removed
    - applyMutations() (engine) -> Removed
    - findElementById() (engine) -> Removed
    - removeElementFromParent() (engine) -> Removed

    #### Removed: Mutation Capture

    Explain that mutations field on AnimationEvent is removed.
    Before/after code example showing old animate() with callback vs new pure data approach.

    #### Removed: Acknowledgment Protocol

    Explain the server no longer tracks animation playback.
    Before/after showing old ws.send acknowledgeAnimations vs new client-local approach.

    #### Removed: currentView / Theatre View Split

    Explain PlayerGameState no longer has separate view/currentView.
    Before/after showing old dual fields vs new single view field.
    ```

    Be thorough. Every API in the research inventory must appear. Use clear before/after code examples.
  </action>
  <verify>
    - `ls BREAKING.md` exists
    - `grep "theatreState" BREAKING.md` finds documentation entries
    - `grep "acknowledgeAnimations" BREAKING.md` finds documentation entries
    - `grep "CapturedMutation" BREAKING.md` finds documentation entries
    - `grep "useCurrentView" BREAKING.md` finds documentation entries
    - `grep "currentView" BREAKING.md` finds documentation entries
    - `wc -l BREAKING.md` shows at least 80 lines (thorough documentation)
  </verify>
  <done>
    BREAKING.md documents every removed API with module, replacement, and before/after code examples. Covers theatre view, mutation capture, acknowledgment protocol, and currentView split.
  </done>
</task>

<task type="auto">
  <name>Task 2: Full verification -- build, tests, grep</name>
  <files></files>
  <action>
    Run three verification checks in sequence:

    1. **TypeScript compilation:**
       `npx tsc --noEmit`
       Must produce ZERO errors. If any errors remain, they indicate missed theatre references -- fix them before proceeding.

    2. **Full test suite:**
       `npx vitest run`
       All remaining tests must pass. Expected test count: approximately 500-530 (down from 633 due to deleted theatre/mutation-capture/animation-events test files). The exact number depends on how many tests were in the deleted files, but the KEY metric is zero failures.

    3. **Clean grep:**
       Search for any surviving theatre references in source code (not BREAKING.md, not .planning/):
       ```
       grep -r "theatreState\|theatreStateForPlayer\|_theatreSnapshot\|_captureContext\|MutationCaptureContext\|CapturedMutation\|mutation-capture\|theatre-state" src/
       ```
       Must return ZERO results.

       Also check for useCurrentView references:
       ```
       grep -r "useCurrentView\|CURRENT_VIEW_KEY" src/
       ```
       Must return ZERO results.

    If any check fails, investigate and fix the issue. The phase is not complete until all three checks pass clean.
  </action>
  <verify>
    - `npx tsc --noEmit` exits with code 0
    - `npx vitest run` exits with code 0, all tests pass, zero failures
    - `grep -r "theatreState\|_theatreSnapshot\|_captureContext\|MutationCaptureContext\|CapturedMutation\|mutation-capture\|theatre-state" src/` returns empty
    - `grep -r "useCurrentView\|CURRENT_VIEW_KEY" src/` returns empty
  </verify>
  <done>
    Full codebase compiles with zero errors. All remaining tests pass. Zero theatre references survive in source code. Phase 85 success criteria are met:
    1. _theatreSnapshot, theatreState, theatreStateForPlayer(), acknowledgeAnimationEvents() (theatre version) removed from Game
    2. MutationCaptureContext, property diffing, element attribute diffing deleted
    3. acknowledgeAnimations WebSocket handler and GameSession.acknowledgeAnimations() removed
    4. All theatre-related tests removed; remaining tests pass
    5. BREAKING.md documents every removed API with migration paths
  </done>
</task>

</tasks>

<verification>
- BREAKING.md exists at repo root with comprehensive migration documentation
- `npx tsc --noEmit` passes clean
- `npx vitest run` passes clean (zero failures)
- `grep -r "theatre\|Theatre\|_captureContext\|MutationCapture\|CapturedMutation\|useCurrentView\|CURRENT_VIEW_KEY" src/` returns zero results
- Test count is in expected range (approximately 500-530 passing)
</verification>

<success_criteria>
Phase 85 complete when ALL of these are true:
1. _theatreSnapshot, theatreState, theatreStateForPlayer(), acknowledgeAnimationEvents() removed from Game class
2. MutationCaptureContext, property diffing, element attribute diffing code deleted -- no mutation-capture.ts or theatre-state.ts files remain
3. acknowledgeAnimations WebSocket message handler and GameSession.acknowledgeAnimations() are gone
4. All theatre-related tests removed; all remaining tests pass with zero regressions
5. BREAKING.md exists documenting every removed API with before/after migration patterns
</success_criteria>

<output>
After completion, create `.planning/phases/85-theatre-erasure/85-04-SUMMARY.md`
</output>
