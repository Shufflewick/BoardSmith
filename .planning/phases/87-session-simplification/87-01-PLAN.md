---
phase: 87-session-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/session/build-player-state.test.ts
  - src/ui/composables/useAnimationEvents.ts
  - .planning/REQUIREMENTS.md
  - .planning/ROADMAP.md
  - .planning/STATE.md
autonomous: true

must_haves:
  truths:
    - "buildPlayerState() returns a single `view` field with truth state and no `currentView` field"
    - "buildPlayerState() includes animationEvents array when game has pending animation events"
    - "buildPlayerState() omits animationEvents when game buffer is empty"
    - "buildPlayerState() includes lastAnimationEventId matching the last event ID"
    - "acknowledgeAnimations method does not exist on GameSession"
    - "acknowledgeAnimations is not a valid WebSocket message type"
    - "SES-01 through SES-04 are marked complete in REQUIREMENTS.md"
  artifacts:
    - path: "src/session/build-player-state.test.ts"
      provides: "Integration tests proving SES-01 and SES-02 requirements"
      min_lines: 80
    - path: "src/ui/composables/useAnimationEvents.ts"
      provides: "Cleaned JSDoc without stale session.acknowledgeAnimations references"
    - path: ".planning/REQUIREMENTS.md"
      provides: "SES-01 through SES-04 marked [x]"
    - path: ".planning/ROADMAP.md"
      provides: "Phase 87 marked complete with plan count"
  key_links:
    - from: "src/session/build-player-state.test.ts"
      to: "src/session/utils.ts"
      via: "import { buildPlayerState }"
      pattern: "import.*buildPlayerState.*from.*utils"
    - from: "src/session/build-player-state.test.ts"
      to: "src/engine/element/game.ts"
      via: "game.animate() populates pendingAnimationEvents"
      pattern: "game\\.animate\\("
---

<objective>
Verify, test, and document that all four SES requirements (SES-01 through SES-04) are already satisfied in the current codebase, then clean up stale references.

Purpose: Phase 85 removed the theatre/currentView split and acknowledgeAnimations from session+server. Phase 86 added animation event buffer integration. The code is already correct -- this plan proves it with tests, cleans stale JSDoc, and updates tracking documents.

Output: Integration test file `src/session/build-player-state.test.ts`, cleaned JSDoc in `useAnimationEvents.ts`, updated REQUIREMENTS.md, ROADMAP.md, and STATE.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/87-session-simplification/87-RESEARCH.md
@src/session/utils.ts (buildPlayerState at lines 346-453)
@src/session/types.ts (PlayerGameState at lines 407-431, WebSocketMessage at line 530)
@src/runtime/runner.ts (GameRunner class)
@src/engine/element/animation-events.test.ts (test patterns for game.animate)
@src/runtime/runner.test.ts (test patterns for GameRunner setup)
@src/ui/composables/useAnimationEvents.ts (stale JSDoc at lines 15, 45)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration tests for buildPlayerState with animation events</name>
  <files>src/session/build-player-state.test.ts</files>
  <action>
Create a new test file `src/session/build-player-state.test.ts` that proves the SES requirements hold.

Test setup pattern (follow existing codebase conventions from `runner.test.ts` and `animation-events.test.ts`):
- Create a minimal TestGame class extending `Game<TestGame, Player>` with a simple flow (use `defineFlow`, `loop`, `eachPlayer`, `actionStep`)
- Register at least one action that calls `this.animate('combat', { damage: 5 })` in its execute callback
- Create a `GameRunner` with the TestGame, start it, and use `buildPlayerState()` from `src/session/utils.ts`
- The test game needs `maxIterations` on `loop()` to avoid warnings

Import from:
- `{ Game, Player, Action, Piece, Space, defineFlow, loop, eachPlayer, actionStep }` from `../../engine/index.js`
- `type { FlowContext }` from `../../engine/index.js`
- `{ GameRunner }` from `../../runtime/runner.js`
- `{ buildPlayerState }` from `./utils.js`

Tests to write (5 tests in 2 describe blocks):

**describe('buildPlayerState - single truth view (SES-01)')**

1. "returns view field with truth state and no currentView field"
   - Create runner, start it, call `buildPlayerState(runner, ['Alice', 'Bob'], 1)`
   - Assert `state.view` is defined and is an object
   - Assert `'currentView' in state` is false
   - Assert `state.view` matches what `runner.getPlayerView(1).state` returns

2. "preserves per-player visibility filtering"
   - Use a game with hidden information (e.g., a `contentsHidden()` space with pieces)
   - Build state for player 1 and player 2
   - Assert the views are different (each player sees their own hand but not the other's)

**describe('buildPlayerState - animation events (SES-02)')**

3. "includes animationEvents when game has pending events"
   - Start the runner, perform an action that triggers `game.animate()`
   - Call `buildPlayerState()` on the runner
   - Assert `state.animationEvents` is an array with length > 0
   - Assert `state.animationEvents[0].type` matches the expected event type
   - Assert `state.lastAnimationEventId` equals the last event's id

4. "omits animationEvents when buffer is empty"
   - Start the runner (no action performed yet, so no animation events)
   - Call `buildPlayerState()`
   - Assert `state.animationEvents` is `undefined`
   - Assert `state.lastAnimationEventId` is `undefined`

5. "includes all animation events from a single action"
   - Create an action that calls `game.animate()` multiple times (e.g., 3 times with different types)
   - Perform that action
   - Call `buildPlayerState()`
   - Assert `state.animationEvents` has length 3
   - Assert IDs are sequential (1, 2, 3)
   - Assert `state.lastAnimationEventId` equals 3

Note: The test game action's execute callback receives `ctx` where `ctx.game` has type `Game<any,any>`. Cast to TestGame if needed to access custom properties. Use `game.animate()` directly in the constructor's action registration where `this` is the game.

Run `npx vitest run src/session/build-player-state.test.ts` to verify all tests pass.
  </action>
  <verify>npx vitest run src/session/build-player-state.test.ts -- all 5 tests pass</verify>
  <done>5 integration tests exist proving buildPlayerState produces single truth view (SES-01) and includes animation events (SES-02). All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Clean stale JSDoc and update tracking documents</name>
  <files>
    src/ui/composables/useAnimationEvents.ts
    .planning/REQUIREMENTS.md
    .planning/ROADMAP.md
    .planning/STATE.md
  </files>
  <action>
**1. Clean stale JSDoc in useAnimationEvents.ts**

Update the JSDoc example at line 15 to remove the stale `session.acknowledgeAnimations` reference. Replace:
```
 *   acknowledge: (upToId) => session.acknowledgeAnimations(upToId),
```
with:
```
 *   acknowledge: (upToId) => { /* notify server */ },
```

Update the JSDoc comment at line 45 to remove the stale reference. Replace:
```
  /** Callback to acknowledge events (calls session.acknowledgeAnimations) */
```
with:
```
  /** Callback to acknowledge processed events */
```

Do NOT change the `acknowledge` parameter itself or the `createAnimationEvents` function signature -- Phase 89 (CLI-10) handles removing the acknowledge parameter entirely. Only fix the JSDoc comments.

**2. Update REQUIREMENTS.md**

Mark SES-01 through SES-04 as complete:
- Change `- [ ] **SES-01**:` to `- [x] **SES-01**:`
- Change `- [ ] **SES-02**:` to `- [x] **SES-02**:`
- Change `- [ ] **SES-03**:` to `- [x] **SES-03**:`
- Change `- [ ] **SES-04**:` to `- [x] **SES-04**:`

In the Traceability table, change all four SES rows from `Pending` to `Complete`.

**3. Update ROADMAP.md**

In the Phase 87 section:
- Change `**Plans**: TBD` to `**Plans:** 1 plan`
- Add plan list:
  ```
  Plans:
  - [x] 87-01-PLAN.md -- Verification tests, stale JSDoc cleanup, documentation updates
  ```
- In the Progress table, change Phase 87 row:
  - Plans Complete: `1/1`
  - Status: `Complete`
  - Completed: today's date (2026-02-08)

**4. Update STATE.md**

Update the current position:
- Phase line: `Phase: 88 of 90 (Client Animation Queue)`
- Plan line: `Plan: 0 of TBD in current phase`
- Status: `Ready to plan`
- Last activity: `2026-02-08 -- Phase 87 Session Simplification complete and verified`
- Stopped at: `Phase 87 complete and verified, ready to plan Phase 88`
- Current focus line: `**Current focus:** v3.0 Animation Timeline -- Phase 88 Client Animation Queue`

Do NOT change Progress percentage (still 33% -- that tracks milestone completion, not phase completion).
  </action>
  <verify>
    1. grep "session.acknowledgeAnimations" src/ui/composables/useAnimationEvents.ts returns no matches (stale references removed)
    2. grep "\[x\] \*\*SES-0" .planning/REQUIREMENTS.md returns 4 matches (all SES requirements marked complete)
    3. grep "Phase 87.*Complete" .planning/ROADMAP.md returns 1 match (progress table updated)
    4. grep "Phase: 88" .planning/STATE.md returns 1 match (state advanced)
  </verify>
  <done>Stale JSDoc cleaned (no session.acknowledgeAnimations references remain), SES-01 through SES-04 marked complete in REQUIREMENTS.md and traceability table, ROADMAP.md shows Phase 87 complete with 1/1 plans, STATE.md points to Phase 88.</done>
</task>

</tasks>

<verification>
1. `npx vitest run src/session/build-player-state.test.ts` -- all 5 tests pass
2. `npx vitest run` -- full test suite passes (no regressions)
3. `grep -r "session.acknowledgeAnimations" src/` returns no matches
4. `grep "acknowledgeAnimat" src/session/game-session.ts` returns no matches (SES-03 still holds)
5. `grep "acknowledgeAnimat" src/server/core.ts` returns no matches (SES-04 still holds)
6. All four SES requirements marked [x] in REQUIREMENTS.md
</verification>

<success_criteria>
- 5 integration tests prove buildPlayerState sends single truth view with animation events
- All tests pass (new and existing)
- No stale `session.acknowledgeAnimations` JSDoc references remain in codebase
- REQUIREMENTS.md, ROADMAP.md, and STATE.md reflect Phase 87 completion
</success_criteria>

<output>
After completion, create `.planning/phases/87-session-simplification/87-01-SUMMARY.md`
</output>
