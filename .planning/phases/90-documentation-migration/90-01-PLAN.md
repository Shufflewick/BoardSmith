---
phase: 90-documentation-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/ui-components.md
  - docs/nomenclature.md
  - docs/migration-guide.md
autonomous: true

must_haves:
  truths:
    - "ui-components.md animation events section describes pure-data event model with no mention of theatre view, mutation capture, or acknowledgment"
    - "nomenclature.md has no Theatre View, Current View, or Mutation Capture entries"
    - "migration-guide.md exists with a v3.0 section documenting the full migration path"
  artifacts:
    - path: "docs/ui-components.md"
      provides: "Updated animation events documentation for v3.0"
      contains: "registerHandler"
    - path: "docs/nomenclature.md"
      provides: "Updated terminology without removed concepts"
      contains: "Animation Timeline"
    - path: "docs/migration-guide.md"
      provides: "v3.0 migration guide with before/after examples"
      contains: "v3.0"
  key_links:
    - from: "docs/ui-components.md"
      to: "docs/nomenclature.md"
      via: "cross-reference at end of animation events section"
      pattern: "nomenclature"
    - from: "docs/migration-guide.md"
      to: "BREAKING.md"
      via: "references breaking changes for full API removal list"
      pattern: "BREAKING"
---

<objective>
Update all BoardSmith documentation to reflect the v3.0 animation system.

Purpose: The v3.0 animation timeline replaced the v2.9 theatre view system across phases 85-89. Three documentation files still describe the old system -- ui-components.md has 220 lines of outdated animation docs, nomenclature.md defines Theatre View / Current View / Mutation Capture as active concepts, and migration-guide.md does not exist yet. This plan brings all documentation in line with the shipped code.

Output: Updated ui-components.md, updated nomenclature.md, new migration-guide.md
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/90-documentation-migration/90-RESEARCH.md

# Source material for migration guide
@BREAKING.md

# Current docs to update
@docs/ui-components.md (lines 1090-1307 -- animation events section)
@docs/nomenclature.md (quick reference table lines 8-46, animation section lines 427-493)

# Actual v3.0 API (source of truth for documentation)
@src/ui/composables/useAnimationEvents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite ui-components.md animation events section</name>
  <files>docs/ui-components.md</files>
  <action>
  Rewrite lines 1090-1307 of docs/ui-components.md (the "Animation Events" section through "Common Pitfalls") to document the v3.0 system. Preserve the heading hierarchy and section organization. The rest of the file (before line 1090 and after line 1307) is unchanged.

  Specific changes:

  1. **Line 1092 (overview paragraph):** Replace theatre view language. New overview: animation events are pure data signals emitted via `game.animate()`. Game state advances immediately (soft continuation). The client plays back events through a FIFO queue with wait-for-handler semantics. The server never waits on animation playback.

  2. **"Key Concepts" (lines 1094-1101):** Rewrite. Remove ALL mentions of theatre view, mutation capture, acknowledgment. New key concepts:
     - Animation events are pure data (type + payload, no mutations attached)
     - Game state advances immediately (soft continuation)
     - Client owns playback entirely -- server broadcasts truth and moves on
     - Wait-for-handler: queue pauses when no handler registered, allowing lazy component mounting (configurable timeout, default 3s)

  3. **"Engine-Side: Emitting Events" (lines 1103-1160):**
     - Line 1105: Change description from "State mutations go inside the callback" to "Use `game.animate(type, data)` to emit pure data animation events. An optional callback can co-locate game logic with the event for convenience."
     - Lines 1107-1122: Update the combat example. Show the preferred pure-data form FIRST (`game.animate('combat', { attackerId, targetId, damage })`), then show truth-advancing logic as separate sequential game code (not inside callback). Then show the optional callback convenience form as a second example.
     - Lines 1125-1131: Update parameter table. `callback` description: "Optional. Runs immediately as normal game code. Convenience for co-locating game logic with the event it describes. Mutations are NOT captured on the event."
     - Lines 1133-1135: DELETE the "Mutation capture" paragraph entirely.
     - Lines 1135: DELETE the "Theatre view" paragraph entirely.
     - Lines 1137-1145: Rewrite "Empty callbacks" section. Since callbacks are optional in v3.0, the pure data form is `game.animate('score-reveal', { playerId, total })` with no callback at all. Show this as the primary signal pattern.
     - Lines 1147-1160: Keep the "No nesting" section but update examples to use the v3.0 patterns (no empty callbacks in the "RIGHT" example -- use `game.animate('attack-start', { attackerId })` without callback, and show the callback form only where truth-advancing logic is co-located).

  4. **"UI-Side: Consuming Events" (lines 1162-1216):**
     - Lines 1168-1186: Update `createAnimationEvents` example. Remove `acknowledge` parameter entirely. Add `handlerWaitTimeout` parameter (default 3000ms). The options are: `events` (reactive getter), `defaultDuration` (optional, default 0), `handlerWaitTimeout` (optional, default 3000).
     - Lines 1188-1216: Keep the handler registration example -- it is correct for v3.0.

  5. **"Composable API" table (lines 1220-1224):** No changes needed.

  6. **"Instance API" table (lines 1228-1234):**
     - Update `skipAll()` description: remove "acknowledge all" -- just "Skip remaining animations" since there is no acknowledgment.
     - Add row: `pendingCount` is already there -- verify description is accurate.

  7. **"Integration with useFLIP and useFlyingElements" (lines 1236-1260):** No changes needed -- example is correct.

  8. **"ActionController Integration" (lines 1262-1283):** No changes needed -- this is about gating, which still works the same way.

  9. **"Common Pitfalls" (lines 1285-1307):**
     - DELETE pitfall #1 ("Forgetting to acknowledge events") -- acknowledgment no longer exists.
     - KEEP pitfall #2 ("Mutating event data in handlers") -- still valid.
     - KEEP pitfall #3 ("Not handling handler errors gracefully") -- still valid.
     - KEEP pitfall #4 ("Blocking entire UI on animations") -- still valid.
     - KEEP pitfall #5 ("Checking isMyTurn instead of showActionPanel") -- still valid.
     - ADD new pitfall: "Forgetting handlerWaitTimeout for lazily-mounted components" -- if a component registers handlers in `onMounted` and events arrive before mounting, the wait-for-handler mechanism pauses the queue. The default 3s timeout handles this, but games with slow-mounting components may need a longer timeout.
     - Renumber pitfalls after removing #1.

  10. **Line 1307 cross-reference:** Keep the link to nomenclature.md.

  IMPORTANT: Do NOT change anything outside lines 1090-1307. The rest of the file is correct.
  </action>
  <verify>
  Grep docs/ui-components.md for removed concepts:
  - `grep -i "theatre" docs/ui-components.md` returns NO matches
  - `grep -i "mutation capture" docs/ui-components.md` returns NO matches
  - `grep -i "acknowledge" docs/ui-components.md` returns NO matches (in animation section)
  - `grep "handlerWaitTimeout" docs/ui-components.md` returns at least 1 match
  - `grep "registerHandler" docs/ui-components.md` returns at least 1 match
  </verify>
  <done>The animation events section (lines 1090+) accurately describes the v3.0 pure-data event model with no references to theatre view, mutation capture, or acknowledgment. New concepts (wait-for-handler, handlerWaitTimeout) are documented.</done>
</task>

<task type="auto">
  <name>Task 2: Update nomenclature.md terminology</name>
  <files>docs/nomenclature.md</files>
  <action>
  Update docs/nomenclature.md to remove v2.9 concepts and add v3.0 terminology.

  **Quick Reference Table (lines 8-46):**
  1. Line 10 -- `Animation Event`: Change from "A structured event capturing mutations for theatre view playback" to "A pure data signal emitted via `game.animate()` for UI animation playback"
  2. Line 12 -- `Current View`: DELETE this entire row
  3. Line 13 -- `Mutation Capture`: DELETE this entire row
  4. Line 41 -- `Soft Continuation`: Keep but verify description says "Pattern where state advances immediately, UI plays back" (no theatre reference)
  5. Line 44 -- `Theatre View`: DELETE this entire row
  6. ADD new row: `Animation Timeline` -- "Client-side FIFO queue processing animation events with wait-for-handler semantics"
  7. ADD new row: `Wait-for-Handler` -- "Queue behavior that pauses for lazily-mounted handler registration (configurable timeout)"
  Keep the table sorted alphabetically after changes.

  **Animation Section (lines 427-493):**
  1. Lines 433-439 -- `Animation Event` definition: Rewrite. New definition: "A pure data event emitted during game execution via `game.animate()` that signals the UI to play an animation. Events carry a type and JSON-serializable data payload. Game state advances immediately (soft continuation); animations are visual overlays on truth." Update In Code, Related Terms (remove Theatre View, Current View, Mutation Capture; add Animation Timeline, Wait-for-Handler). Update Usage examples.

  2. Lines 441-449 -- `Animation Handler`: Keep as-is. Still accurate.

  3. Lines 451-460 -- `Soft Continuation`: Rewrite definition to remove theatre view reference. New definition: "Design pattern where game state advances immediately and UI plays back asynchronously. The UI shows truth at all times; animation events are visual overlays that 'catch up' to show what happened. The ActionPanel gates on animation completion to prevent premature decisions." Remove Theatre View from Related Terms. Update usage examples to remove theatre view references.

  4. Lines 462-471 -- `Theatre View`: DELETE entire entry (heading + content).

  5. Lines 473-482 -- `Current View`: DELETE entire entry (heading + content).

  6. Lines 484-493 -- `Mutation Capture`: DELETE entire entry (heading + content).

  7. ADD new entry `Animation Timeline`: "The client-side playback system that processes animation events sequentially through a FIFO queue. When an event arrives with no registered handler, the queue pauses (up to `handlerWaitTimeout`, default 3s) to allow lazily-mounted components to register. If the timeout expires, the event is skipped with a console warning." In Code: `createAnimationEvents()` composable. Related Terms: Animation Event, Wait-for-Handler, Animation Handler. Usage: "The animation timeline processes events in order" / "Configure the timeline's wait timeout for slow-mounting components".

  8. ADD new entry `Wait-for-Handler`: "Queue behavior where processing pauses when encountering an event type with no registered handler. This allows components that register handlers during `onMounted` to claim their events even if the events arrive before the component mounts. Configurable via `handlerWaitTimeout` (default 3s)." In Code: `handlerWaitTimeout` option in `createAnimationEvents()`. Related Terms: Animation Timeline, Animation Handler. Usage: "Wait-for-handler prevents fire-and-forget silent event consumption" / "Increase handlerWaitTimeout for components with heavy initialization".

  Keep the `---` separator and "Related Documentation" section at the end unchanged.
  </action>
  <verify>
  Grep docs/nomenclature.md for removed concepts:
  - `grep -i "theatre view" docs/nomenclature.md` returns NO matches
  - `grep -i "current view" docs/nomenclature.md` returns NO matches (as a concept name)
  - `grep -i "mutation capture" docs/nomenclature.md` returns NO matches
  - `grep "Animation Timeline" docs/nomenclature.md` returns at least 1 match
  - `grep "Wait-for-Handler" docs/nomenclature.md` returns at least 1 match
  </verify>
  <done>nomenclature.md has no Theatre View, Current View, or Mutation Capture entries. New Animation Timeline and Wait-for-Handler entries exist. Animation Event and Soft Continuation definitions are updated for v3.0.</done>
</task>

<task type="auto">
  <name>Task 3: Create migration-guide.md for v3.0</name>
  <files>docs/migration-guide.md</files>
  <action>
  Create a new file `docs/migration-guide.md` with a v3.0 migration guide. This is a user-facing, task-oriented document (not a dump of BREAKING.md). Structure it as a practical guide for game developers migrating from v2.9 to v3.0.

  Use BREAKING.md as source material for the removed APIs and before/after patterns. The migration guide should be organized by WHAT developers need to DO, not by what was removed.

  Structure:

  ```markdown
  # Migration Guide

  ## v3.0: Animation Timeline

  v3.0 replaces the server-side theatre view system with a client-side animation timeline. Animation events are now pure data signals -- the server broadcasts truth immediately and never waits on animation playback.

  For the complete list of removed APIs, see [BREAKING.md](../BREAKING.md).

  ### What Changed

  Brief summary of the conceptual shift: theatre view (server-managed frozen snapshot, mutation capture, acknowledgment round-trips) is gone. Replaced by: client-side FIFO queue with wait-for-handler semantics, pure data events, single truth view.

  ### Step 1: Update `game.animate()` calls

  **Remove empty callbacks:**
  Before: `game.animate('score', data, () => {})`
  After: `game.animate('score', data)`

  **Keep truth-advancing callbacks:**
  Before: `game.animate('score-complete', data, () => { this.addPoints(player, 10) })`
  After: Same -- callbacks that advance game state are still supported as a convenience. They run immediately as normal game code. The only change is that mutations inside the callback are NOT captured on the event.

  **Remove mutation-capture patterns:**
  Before: `game.animate('combat', data, () => { target.putInto(graveyard) })` -- mutations captured on event
  After: `game.animate('combat', data); target.putInto(graveyard);` -- mutations happen via normal code, event is pure data

  ### Step 2: Update `createAnimationEvents()`

  **Remove the `acknowledge` parameter:**
  Before:
  ```typescript
  const animationEvents = createAnimationEvents({
    events: () => state.value?.animationEvents,
    acknowledge: (upToId) => {
      session.acknowledgeAnimations(playerSeat, upToId);
    },
  });
  ```
  After:
  ```typescript
  const animationEvents = createAnimationEvents({
    events: () => state.value?.animationEvents,
    handlerWaitTimeout: 3000, // optional, default 3s
  });
  ```

  ### Step 3: Remove `useCurrentView()` usage

  Before:
  ```typescript
  import { useCurrentView } from 'boardsmith/ui';
  const view = useCurrentView();
  ```
  After:
  ```typescript
  // useCurrentView is removed. Use gameView from GameShell directly.
  // gameView is always truth -- there is no theatre/current split.
  const { gameView } = props;
  ```

  ### Step 4: Remove theatre state references

  Before: `game.theatreState`, `game.theatreStateForPlayer(seat)`
  After: `game.toJSON()`, `game.toJSONForPlayer(seat)` -- truth is the only view

  ### Step 5: Update animation event handlers (no changes required)

  Animation handlers (`registerHandler`) work exactly the same in v3.0. No migration needed for handler code.

  ### New in v3.0: Wait-for-Handler

  Events arriving before their handler registers now pause the queue (up to `handlerWaitTimeout`, default 3s) instead of being silently consumed. This prevents fire-and-forget event loss when components mount after events arrive.

  If timeout expires, a console warning names the event type and ID, and the event is skipped.

  ### Checklist

  - [ ] Remove all empty `() => {}` callbacks from `game.animate()` calls
  - [ ] Keep callbacks that advance game state (e.g., `addPoints()`, `remove()`)
  - [ ] Remove `acknowledge` parameter from all `createAnimationEvents()` calls
  - [ ] Replace `useCurrentView()` with `gameView` from GameShell props
  - [ ] Remove any `game.theatreState` or `game.theatreStateForPlayer()` references
  - [ ] Remove any `session.acknowledgeAnimations()` calls
  - [ ] Remove any `acknowledgeAnimations` WebSocket message handling
  - [ ] Update comments referencing "theatre view", "mutation capture", or "acknowledgment"
  - [ ] Test all animation flows in browser after migration
  ```

  IMPORTANT: Use proper code fences and markdown formatting. Keep the guide concise and task-oriented. Do NOT duplicate BREAKING.md -- reference it for the full API removal list.
  </action>
  <verify>
  - File exists: `ls docs/migration-guide.md`
  - Contains v3.0 section: `grep "v3.0" docs/migration-guide.md`
  - Contains before/after examples: `grep -c "Before\|After" docs/migration-guide.md` returns > 0
  - Contains migration checklist: `grep "checklist" docs/migration-guide.md` (case insensitive)
  - References BREAKING.md: `grep "BREAKING" docs/migration-guide.md`
  </verify>
  <done>migration-guide.md exists with a v3.0 section covering all 5 migration steps, before/after code examples, the new wait-for-handler behavior, and a migration checklist. References BREAKING.md for the full API removal list.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -ri "theatre" docs/ui-components.md docs/nomenclature.md` returns NO matches
2. `grep -ri "mutation capture" docs/ui-components.md docs/nomenclature.md` returns NO matches
3. `grep -ri "acknowledge" docs/ui-components.md` returns NO matches in the animation events section
4. `docs/migration-guide.md` exists and contains v3.0 migration content
5. All three docs files are internally consistent -- no cross-references to removed concepts
</verification>

<success_criteria>
- ui-components.md animation events section (lines 1090+) describes v3.0 pure-data model with registerHandler, wait-for-handler, and handlerWaitTimeout
- nomenclature.md has zero entries for Theatre View, Current View, or Mutation Capture; has new Animation Timeline and Wait-for-Handler entries
- migration-guide.md exists with task-oriented v3.0 migration guide including before/after code examples and checklist
</success_criteria>

<output>
After completion, create `.planning/phases/90-documentation-migration/90-01-SUMMARY.md`
</output>
