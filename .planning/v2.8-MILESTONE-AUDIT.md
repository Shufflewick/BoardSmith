---
milestone: v2.8
audited: 2026-02-06T19:30:00Z
status: gaps_found
scores:
  requirements: 20/20
  phases: 4/4
  integration: 6/7
  flows: 5/6
gaps:
  requirements: []
  integration:
    - "getChoices() in useActionController.ts drops disabled field when converting ValidElement[] to choice-like arrays (3 locations: lines 285-289, 310-313, 320-323)"
  flows:
    - "Auto-fill for element-type selections does not filter disabled items on client side"
    - "Custom UI getChoices()/getCurrentChoices() for element-type picks does not expose disabled field"
    - "Client-side fill() validation for element-type selections does not check disabled"
tech_debt: []
---

# v2.8 Milestone Audit: Disabled Selections

**Audited:** 2026-02-06
**Status:** gaps_found
**Milestone Goal:** Add a `disabled` state to element and choice selections so items remain visible but unselectable, with a mandatory reason string.

## Phase Verification Summary

| Phase | Status | Score | Verified |
|-------|--------|-------|----------|
| 75. Engine Core | Passed | 4/4 | 2026-02-06 |
| 76. Session Wire | Passed | 4/4 | 2026-02-06 |
| 77. UI Integration | Passed | 5/5 | 2026-02-06 |
| 78. Documentation | Passed | 4/4 | 2026-02-06 |

All individual phases passed verification. The gap was found during cross-phase integration checking.

## Requirements Coverage

| Requirement | Phase | Status |
|-------------|-------|--------|
| ENG-01: `chooseElement` accepts `disabled` option | 75 | SATISFIED |
| ENG-02: `fromElements` accepts `disabled` option | 75 | SATISFIED |
| ENG-03: `chooseFrom` accepts `disabled` option | 75 | SATISFIED |
| ENG-04: `getChoices()` returns `AnnotatedChoice<T>[]` | 75 | SATISFIED |
| ENG-05: `hasValidSelectionPath()` only counts enabled items | 75 | SATISFIED |
| ENG-06: `validateSelection()` rejects disabled with reason | 75 | SATISFIED |
| SES-01: `ValidElement` gains `disabled?: string` | 76 | SATISFIED |
| SES-02: `ChoiceWithRefs` gains `disabled?: string` | 76 | SATISFIED |
| SES-03: PickHandler threads disabled from engine to wire | 76 | SATISFIED |
| UI-01: ActionPanel disabled element buttons with tooltip | 77 | SATISFIED |
| UI-02: ActionPanel disabled choice buttons with tooltip | 77 | SATISFIED |
| UI-03: `isDisabledElement()` method | 77 | SATISFIED |
| UI-04: `triggerElementSelect` ignores disabled clicks | 77 | SATISFIED |
| UI-05: `bs-element-disabled` CSS class | 77 | SATISFIED |
| UI-06: `validElements` carries `disabled` for custom UIs | 77 | SATISFIED |
| UI-07: `getChoices()`/`getCurrentChoices()` carry `disabled` | 77 | PARTIAL |
| UI-08: `fill()` rejects disabled with reason | 77 | PARTIAL |
| UI-09: Auto-fill skips disabled items | 77 | PARTIAL |

**Requirements 20/20 mapped, 17 fully satisfied, 3 partial (element-type selections only).**

## Cross-Phase Integration

### Connected (6/7)

1. **Engine → Session wire types** — AnnotatedChoice disabled maps to ValidElement.disabled and ChoiceWithRefs.disabled via PickHandler
2. **Session → UI types** — Wire types carry disabled through to all UI-layer interfaces
3. **UI types → ActionPanel rendering** — All 6 button templates render disabled with tooltip
4. **ActionPanel → Board interaction → AutoElement** — Disabled elements get CSS class, click guard works
5. **Engine validation** — Server-side validateSelection rejects disabled items
6. **AI bot** — Filters disabled choices, never selects them

### Gap (1/7)

7. **getChoices() drops disabled for element-type selections** — `useActionController.ts` lines 285-289, 310-313, 320-323 convert `ValidElement[]` to choice-like arrays with only `{ value, display }`, dropping `el.disabled`.

## Gap Details

### getChoices() drops disabled for element-type selections

**Root cause:** When `getChoices()` in `useActionController.ts` converts `validElements` to a choice-like array, it only copies `value` (from `el.id`) and `display` — it does not copy `el.disabled`.

**3 affected code paths:**
1. Line 285-289: `snapshot.validElements` mapping
2. Line 310-313: `elementsByDependentValue` mapping
3. Line 320-323: Static `validElements` fallback

**Impact on requirements:**

| Requirement | Impact | Severity |
|-------------|--------|----------|
| UI-07: getChoices() carries disabled | Element-type picks return choices without `disabled` field. Choice-type picks work correctly. | Medium |
| UI-08: fill() rejects disabled | Client-side fill() for element picks won't catch disabled (server still rejects). | Low |
| UI-09: Auto-fill skips disabled | Auto-fill for element picks doesn't filter disabled. Could auto-fill a disabled element, which the server then rejects. | Medium |

**Mitigations already in place:**
- ActionPanel does NOT use `getChoices()` for element rendering — uses `validElements` computed directly, which preserves `disabled`
- `validElements` computed (requirement UI-06) returns `ValidElement[]` with `disabled` intact
- Board interaction `isDisabledElement()` works correctly
- Server-side engine validation always catches disabled selections as final safety net

**Not covered by tests:** All 7 disabled tests in `useActionController.test.ts` use `type: 'choice'`. None test `type: 'element'` or `type: 'elements'`.

## E2E Flow Verification

| Flow | Status |
|------|--------|
| Disabled choice button → can't click → tooltip shows reason | COMPLETE |
| Disabled board element → can't click → visual muting + tooltip | COMPLETE |
| Custom UI reads disabled from `validElements` for elements | COMPLETE |
| Custom UI reads disabled from `getChoices()` for choices | COMPLETE |
| Auto-fill skips disabled choices (all 3 code paths) | COMPLETE |
| Auto-fill skips disabled elements via `getChoices()` | DEGRADED |

## Human Verification Pending

From Phase 77 verification, 3 items require browser testing:
1. Visual disabled rendering in ActionPanel (greyed out buttons with tooltips)
2. Board element disabled visual (opacity 0.5, grayscale, not-allowed cursor)
3. End-to-end auto-fill with disabled items

## Anti-Patterns

None found across all 4 phases. No TODOs, stubs, placeholders, or empty handlers.

---

*Audited: 2026-02-06*
*Auditor: Claude (gsd milestone audit)*
