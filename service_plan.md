# BoardSmith Service Plan

## Vision

BoardSmith is a platform for developing and hosting multiplayer board/card games. Developers get a minimal SDK to build games locally, then publish to boardsmith.io where players discover, play, and compete on leaderboards.

**Key principle**: Developers focus only on making great games. All hosting infrastructure is opaque to them.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     DEVELOPER DOMAIN                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Game      │  │   Game      │  │    bsg       │              │
│  │   Rules     │  │    UI       │  │    CLI      │              │
│  │ (TypeScript)│  │   (Vue)     │  │             │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                │                      │
│         └────────────────┴────────────────┘                      │
│                          │                                       │
│                    bsg publish                                    │
└──────────────────────────┼───────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   BOARDSMITH.IO PLATFORM                          │
│                      (Future Phase)                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Build     │  │   Game      │  │   Player    │              │
│  │   Pipeline  │  │   Hosting   │  │   Portal    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: Developer SDK (Current Focus)

### 1.1 Package Structure

Published to npm under `@boardsmith` namespace:

```
@boardsmith/cli        # CLI tool (boardsmith command)
@boardsmith/engine     # Core game framework (Game, Elements, Flow, Actions)
@boardsmith/ui         # Vue components (GameShell, helpers)
```

Developers interact primarily through the CLI:
```bash
npx @boardsmith/cli init my-game
cd my-game
boardsmith dev
```

### 1.2 Game Project Structure

Generated by `boardsmith init`:

```
my-game/
├── boardsmith.json             # Game metadata (config as code)
├── package.json
├── tsconfig.json
├── src/
│   ├── rules/
│   │   ├── game.ts         # Game class extending BoardSmith Game
│   │   ├── elements.ts     # Custom elements (cards, boards, etc.)
│   │   ├── actions.ts      # Player actions
│   │   ├── flow.ts         # Game flow definition
│   │   └── index.ts        # Exports gameDefinition
│   └── ui/
│       ├── App.vue         # Main game UI (inside GameShell)
│       ├── components/     # Custom Vue components
│       └── assets/         # Images, sounds, fonts
├── tests/
│   └── game.test.ts        # Game logic tests
└── public/
    └── thumbnail.png       # Game thumbnail for catalog
```

### 1.3 Configuration as Code

`boardsmith.json` - simple JSON with a JSON Schema for IDE autocomplete:
```json
{
  "$schema": "https://boardsmith.io/schemas/game.json",

  "name": "my-game",
  "displayName": "My Awesome Game",
  "description": "A fun card game for 2-4 players",

  "playerCount": {
    "min": 2,
    "max": 4
  },

  "estimatedDuration": "15-30 minutes",
  "complexity": 2,
  "categories": ["card-game", "strategy"],

  "thumbnail": "./public/thumbnail.png",

  "scoreboard": {
    "stats": ["score", "cardsInHand"]
  }
}
```

**Why JSON over TypeScript?**
- No code execution risk (platform can safely parse)
- Simpler tooling (just `JSON.parse`)
- JSON Schema provides IDE autocomplete and validation
- Consistent with `package.json`, `tsconfig.json`

### 1.4 GameShell UI Component

BoardSmith provides a wrapper component that handles:
- **Top bar**: Site navigation (hamburger), current turn indicator, available actions
- **Side panel**: Scoreboard (customizable stats), game history
- **Bottom panel**: Debug tools (dev mode only)
- **Center**: Developer's custom game area

```vue
<!-- Developer's App.vue -->
<template>
  <GameShell :game="game" :player="currentPlayer">
    <template #game-area>
      <!-- Full creative control here -->
      <MyGameBoard :state="state" @action="handleAction" />
    </template>

    <template #scoreboard-stats="{ player }">
      <!-- Customize what shows per player in scoreboard -->
      <span>Score: {{ player.score }}</span>
      <span>Cards: {{ player.hand.length }}</span>
    </template>
  </GameShell>
</template>
```

### 1.5 CLI Commands

```bash
# Project setup
boardsmith init <name>           # Scaffold new game project
boardsmith dev                   # Run local dev server

# Development
boardsmith test                  # Run game tests
boardsmith build                 # Build for production
boardsmith validate              # Lint + automated game simulations

# Publishing (requires boardsmith.io account)
boardsmith login                 # Authenticate
boardsmith publish               # Push to boardsmith.io
boardsmith revisions             # List published revisions
boardsmith promote <rev>         # Make old revision the main
boardsmith status                # Check game stats
```

### 1.6 Local Development Experience

`boardsmith dev` provides:

1. **Multi-tab simulation**: Opens browser tabs for each player position with proper hidden information
2. **Hot Module Reload**: Code changes apply instantly, game state preserved
3. **Debug panel** (bottom of screen):
   - Restart game button
   - Time-travel: scrub through action history, replay from any point
   - View raw game state
   - Switch player perspective
4. **Action logging**: All actions logged with timestamps
5. **Replay file export**: Save game state for bug reproduction

### 1.7 Validation Requirements

Before `boardsmith publish` succeeds:

1. **Build passes**: TypeScript compiles, Vue builds without errors
2. **Automated simulation**: Random games complete without crashes/infinite loops
3. **Metadata complete**: All required fields in `boardsmith.json`
4. **Bundle size limits**: Rules and UI within size constraints
5. **Security scan**: No filesystem/network calls in rules code

---

## Phase 2: Engine Refinements

### 2.1 Current Packages to Refactor

Map existing packages to SDK structure:

| Current Package | SDK Package | Notes |
|----------------|-------------|-------|
| `@boardsmith/engine` | `@boardsmith/engine` | Rename, clean public API |
| `@boardsmith/runtime` | `@boardsmith/engine` | Merge into engine |
| `@boardsmith/ui-components` | `@boardsmith/ui` | Rename, add GameShell |
| `@boardsmith/worker` | `@boardsmith/worker` | Library for building game workers |

### 2.2 Engine API Cleanup

Expose only what developers need:

```typescript
// @boardsmith/engine

// Core classes
export { Game, GameOptions } from './game';
export { Player } from './player';

// Elements
export { GameElement, ElementCollection } from './element';
export { Piece, Card, Deck, Hand, Board, Space } from './elements';

// Flow
export { createFlow, Do, Loop, ForEach, EveryPlayer, If, Switch } from './flow';

// Actions
export { createAction, ActionDefinition } from './action';

// Utilities
export { Random } from './random';
```

### 2.3 Replay System

Standardized replay format for:
- Local debugging (time-travel)
- Platform replay viewing
- Bug reproduction (download replays)

```typescript
interface ReplayFile {
  version: 1;
  gameType: string;
  gameRevision: string;
  seed: string;
  playerCount: number;
  playerNames: string[];
  actions: SerializedAction[];
  outcome: 'complete' | 'aborted';
  winners?: number[];
  timestamp: string;
}
```

---

## Phase 3: UI Components

### 3.1 GameShell Component

Core wrapper all games use:

```typescript
interface GameShellProps {
  // Connection
  gameId: string;
  playerId: string;

  // Callbacks
  onAction: (action: string, args: Record<string, unknown>) => void;
  onError: (error: Error) => void;
}

interface GameShellSlots {
  'game-area': { state: GameState; player: Player };
  'scoreboard-stats': { player: Player };
}
```

### 3.2 Helper Components

Optional utilities developers can use:

```vue
<!-- Drag and drop -->
<Draggable :element="card" @drop="handleDrop">
  <CardComponent :card="card" />
</Draggable>

<!-- Dice rolling with animation -->
<DiceRoller :count="2" :sides="6" @rolled="handleRoll" />

<!-- Card fan display -->
<CardFan :cards="hand" :selected="selectedCard" @select="selectCard" />

<!-- Deck with shuffle animation -->
<DeckPile :deck="deck" @shuffle="shuffleDeck" />
```

### 3.3 Theming

Developers can customize within their game area but cannot override shell styles:

```json
// In boardsmith.json
{
  "theme": {
    "primaryColor": "#4a90d9",
    "backgroundColor": "#1a1a2e"
  }
}
```

---

## Phase 4: CLI Implementation

### 4.1 `boardsmith init`

Scaffolds complete project:

1. Creates directory structure
2. Generates `package.json` with correct dependencies
3. Creates starter `boardsmith.json`
4. Generates example game (simple card game)
5. Sets up TypeScript, Vite, Vitest configs
6. Initializes git repo

### 4.2 `boardsmith dev`

Local development server:

1. Starts Vite dev server for UI
2. Runs local game server (simulates platform)
3. Opens browser with multi-player tabs
4. Watches for file changes
5. Preserves game state across HMR
6. Injects debug panel

### 4.3 `boardsmith validate`

Pre-publish checks:

1. TypeScript compilation
2. ESLint with BoardSmith rules (no fetch, no fs, etc.)
3. Bundle size analysis
4. Run N random games to completion
5. Check for infinite loops (timeout)
6. Verify metadata completeness

### 4.4 `boardsmith publish`

Upload to platform:

1. Run full validation
2. Bundle rules and UI
3. Upload to boardsmith.io API
4. Receive revision ID
5. Display status URL

---

## Phase 5: Sandbox & Security

### 5.1 Rules Code Restrictions

Enforced via ESLint + runtime checks:

```typescript
// Forbidden in rules code:
fetch()           // No network
import('fs')      // No filesystem
setTimeout()      // No timers
setInterval()
Date.now()        // Non-deterministic (use game.random instead)
Math.random()     // Non-deterministic (use game.random instead)
```

### 5.2 Bundle Analysis

At build time:
- Scan for forbidden APIs
- Check bundle size (< X MB)
- Verify all imports are allowed

### 5.3 Execution Limits

At runtime:
- Action timeout: 100ms
- Memory limit: 128MB
- No infinite loops (step counter)

---

## Phase 6: Testing Framework

### 6.1 Game Testing Utilities

```typescript
import { createTestGame, simulateAction } from '@boardsmith/testing';

describe('GoFish', () => {
  it('should transfer cards on successful ask', () => {
    const game = createTestGame(GoFishGame, {
      playerCount: 2,
      seed: 'test-seed',
    });

    game.start();

    // Simulate player 0 asking player 1 for 8s
    const result = simulateAction(game, 0, 'ask', {
      target: 1,
      rank: '8',
    });

    expect(result.success).toBe(true);
    // ... assertions
  });
});
```

### 6.2 Automated Game Simulation

```typescript
import { simulateRandomGames } from '@boardsmith/testing';

describe('GoFish completeness', () => {
  it('should always reach completion', async () => {
    const results = await simulateRandomGames(GoFishGame, {
      count: 100,
      playerCounts: [2, 3, 4],
      timeout: 5000,
    });

    expect(results.completed).toBe(100);
    expect(results.crashed).toBe(0);
    expect(results.timedOut).toBe(0);
  });
});
```

---

## Future Phases (Platform - Deferred)

### Phase 7: boardsmith.io Backend
- User authentication
- Game catalog API
- Revision management
- Build pipeline

### Phase 8: Game Hosting
- Cloudflare Workers deployment
- Durable Objects for game state
- WebSocket connections
- Auto-scaling

### Phase 9: Player Features
- Matchmaking
- Leaderboards
- Player profiles
- Game history

### Phase 10: Monetization
- Developer revenue sharing
- Subscription tiers
- Premium games

---

## Immediate Next Steps

### Week 1-2: Package Reorganization
- [ ] Rename `@boardsmith/*` to `@boardsmith/*`
- [ ] Merge runtime into engine
- [ ] Clean up engine public API
- [ ] Create `@boardsmith/ui` with GameShell

### Week 3-4: CLI Foundation
- [ ] Create `@boardsmith/cli` package
- [ ] Implement `boardsmith init` with project scaffolding
- [ ] Implement `boardsmith dev` with local server
- [ ] Basic multi-tab player simulation

### Week 5-6: Development Experience
- [ ] Debug panel component
- [ ] Time-travel replay
- [ ] HMR with state preservation
- [ ] Action logging

### Week 7-8: Validation & Publishing
- [ ] `boardsmith validate` with all checks
- [ ] `boardsmith build` for production bundles
- [ ] ESLint plugin for security rules
- [ ] Replay file format

### Week 9-10: Documentation & Polish
- [ ] Developer documentation
- [ ] Tutorial: Build your first game
- [ ] Example games (beyond Go Fish/Cribbage)
- [ ] Error messages and DX improvements

---

## Open Questions

1. **AI Opponents**: Should SDK include simple AI for testing? (Random valid moves)
2. **Internationalization**: Should games support multiple languages? How?
3. **Accessibility**: What a11y requirements for game UIs?
4. **Mobile**: Responsive design requirements? Touch support in helpers?
5. **Sound**: Provide sound effect helpers or leave to developers?

---

## Success Metrics

For the SDK to be "complete enough" for external developers:

1. Developer can go from `boardsmith init` to playing their game in < 10 minutes
2. Example games (Go Fish, Cribbage) work fully in local dev mode
3. Time-travel debugging works reliably
4. Validation catches common errors before publish
5. Documentation covers all core concepts
